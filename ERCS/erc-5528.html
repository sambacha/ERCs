<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Refundable Fungible Token | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Refundable Fungible Token | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-5528" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-5528" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Refundable Fungible Token</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This standard is an extension of <a href="./eip-20.md">EIP-20</a>. This specification defines a type of escrow service with the following flow:</p>

<ul>
  <li>The seller issues tokens.</li>
  <li>The seller creates an escrow smart contract with detailed escrow information like contract addresses, lock period, exchange rate, additional escrow success conditions, etc.</li>
  <li>The seller funds seller tokens to the <em>Escrow Contract</em>.</li>
  <li>Buyers fund buyer tokens which are pre-defined in the <em>Escrow Contract</em>.</li>
  <li>When the escrow status meets success, the seller can withdraw buyer tokens, and buyers can withdraw seller tokens based on exchange rates.</li>
  <li>Buyers can withdraw (or refund) their funded token if the escrow process is failed or is in the middle of the escrow process.</li>
</ul>

<h2 id="motivation">Motivation</h2>

<p>Because of the pseudonymous nature of cryptocurrencies, there is no automatic recourse to recover funds that have already been paid.</p>

<p>In traditional finance, trusted escrow services solve this problem. In the world of decentralized cryptocurrency, however, it is possible to implement an escrow service without a third-party arbitrator. This standard defines an interface for smart contracts to act as an escrow service with a function where tokens are sent back to the original wallet if the escrow is not completed.</p>

<h2 id="specification">Specification</h2>

<p>There are two types of contract for the escrow process:</p>

<ul>
  <li><em>Payable Contract</em>: The sellers and buyers use this token to fund the <em>Escrow Contract</em>. This contract MUST override <a href="./eip-20.md">EIP-20</a> interfaces.</li>
  <li><em>Escrow Contract</em>: Defines the escrow policies and holds <em>Payable Contract</em>’s token for a certain period. This contract does not requires override <a href="./eip-20.md">EIP-20</a> interfaces.</li>
</ul>

<h3 id="methods">Methods</h3>

<h4 id="constructor"><code class="language-plaintext highlighter-rouge">constructor</code></h4>

<p>The <em>Escrow Contract</em> demonstrates details of escrow policies as none-mutable matter in constructor implementation.</p>

<p>The <em>Escrow Contract</em> MUST define the following policies:</p>

<ul>
  <li>Seller token contract address</li>
  <li>Buyer token contract address</li>
</ul>

<p>The <em>Escrow Contract</em> MAY define the following policies:</p>

<ul>
  <li>Escrow period</li>
  <li>Maximum (or minimum) number of investors</li>
  <li>Maximum (or minimum) number of tokens to fund</li>
  <li>Exchange rates of seller/buyer token</li>
  <li>KYC verification of users</li>
</ul>

<h4 id="escrowfund"><code class="language-plaintext highlighter-rouge">escrowFund</code></h4>

<p>Funds <code class="language-plaintext highlighter-rouge">_value</code> amount of tokens to address <code class="language-plaintext highlighter-rouge">_to</code>.</p>

<p>In the case of <em>Escrow Contract</em>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_to</code> MUST be the user address.</li>
  <li><code class="language-plaintext highlighter-rouge">msg.sender</code> MUST be the <em>Payable Contract</em> address.</li>
  <li>MUST check policy validations.</li>
</ul>

<p>In the case of <em>Payable Contract</em>:</p>

<ul>
  <li>The address <code class="language-plaintext highlighter-rouge">_to</code> MUST be the <em>Escrow Contract</em> address.</li>
  <li>MUST call the same function of the <em>Escrow Contract</em> interface. The parameter <code class="language-plaintext highlighter-rouge">_to</code> MUST be <code class="language-plaintext highlighter-rouge">msg.sender</code> to recognize the user address in the <em>Escrow Contract</em>.</li>
</ul>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">escrowFund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="escrowrefund"><code class="language-plaintext highlighter-rouge">escrowRefund</code></h4>

<p>Refunds <code class="language-plaintext highlighter-rouge">_value</code> amount of tokens from address <code class="language-plaintext highlighter-rouge">_from</code>.</p>

<p>In the case of <em>Escrow Contract</em>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_from</code> MUST be the user address.</li>
  <li><code class="language-plaintext highlighter-rouge">msg.sender</code> MUST be the <em>Payable Contract</em> address.</li>
  <li>MUST check policy validations.</li>
</ul>

<p>In the case of <em>Payable Contract</em>:</p>

<ul>
  <li>The address <code class="language-plaintext highlighter-rouge">_from</code> MUST be the <em>Escrow Contract</em> address.</li>
  <li>MUST call the same function of the <em>Escrow Contract</em> interface. The parameter <code class="language-plaintext highlighter-rouge">_from</code> MUST be <code class="language-plaintext highlighter-rouge">msg.sender</code> to recognize the user address in the <em>Escrow Contract</em>.</li>
</ul>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">escrowRefund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="escrowwithdraw"><code class="language-plaintext highlighter-rouge">escrowWithdraw</code></h4>

<p>Withdraws funds from the escrow account.</p>

<p>In the case of <em>Escrow Contract</em>:</p>

<ul>
  <li>MUST check the escrow process is completed.</li>
  <li>MUST send the remaining balance of seller and buyer tokens to <code class="language-plaintext highlighter-rouge">msg.sender</code>’s seller and buyer contract wallets.</li>
</ul>

<p>In the case of <em>Payable Contract</em>, it is optional.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">escrowWithdraw</span><span class="p">()</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="example-of-interface">Example of interface</h3>

<p>This example demonstrates simple exchange of one seller and one buyer in one-to-one exchange rates.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">20</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IERC5528</span> <span class="p">{</span>

    <span class="k">function</span> <span class="n">escrowFund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">escrowRefund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">escrowWithdraw</span><span class="p">()</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">contract</span> <span class="n">PayableContract</span> <span class="k">is</span> <span class="n">IERC5528</span><span class="p">,</span> <span class="n">IERC20</span> <span class="p">{</span>
    <span class="cm">/*
      General ERC20 implementations
    */</span>

    <span class="k">function</span> <span class="n">_transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">fromBalance</span> <span class="o">=</span> <span class="n">_balances</span><span class="p">[</span><span class="n">from</span><span class="p">];</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">fromBalance</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">,</span> <span class="s">"ERC20: transfer amount exceeds balance"</span><span class="p">);</span>
        <span class="n">_balances</span><span class="p">[</span><span class="n">from</span><span class="p">]</span> <span class="o">=</span> <span class="n">fromBalance</span> <span class="o">-</span> <span class="n">amount</span><span class="p">;</span>
        <span class="n">_balances</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
        <span class="n">_transfer</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">escrowFund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">){</span>
        <span class="kt">bool</span> <span class="n">res</span> <span class="o">=</span> <span class="n">IERC5528</span><span class="p">(</span><span class="n">to</span><span class="p">).</span><span class="n">escrowFund</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">"Fund Failed"</span><span class="p">);</span>
        <span class="n">_transfer</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">escrowRefund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">){</span>
        <span class="kt">bool</span> <span class="n">res</span> <span class="o">=</span> <span class="n">IERC5528</span><span class="p">(</span><span class="n">_from</span><span class="p">).</span><span class="n">escrowRefund</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">"Refund Failed"</span><span class="p">);</span>
        <span class="n">_transfer</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">contract</span> <span class="n">EscrowContract</span> <span class="k">is</span> <span class="n">IERC5528</span> <span class="p">{</span>

    <span class="k">enum</span> <span class="n">State</span> <span class="p">{</span> <span class="n">Inited</span><span class="p">,</span> <span class="n">Running</span><span class="p">,</span> <span class="n">Success</span><span class="p">,</span> <span class="n">Closed</span> <span class="p">}</span>
    <span class="k">struct</span> <span class="n">BalanceData</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">addr</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">address</span> <span class="n">_addrSeller</span><span class="p">;</span>
    <span class="kt">address</span> <span class="n">_addrBuyer</span><span class="p">;</span>
    <span class="n">BalanceData</span> <span class="n">_fundSeller</span><span class="p">;</span>
    <span class="n">BalanceData</span> <span class="n">_fundBuyer</span><span class="p">;</span>
    <span class="n">EscrowStatus</span> <span class="n">_status</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">sellerContract</span><span class="p">,</span> <span class="kt">address</span> <span class="n">buyerContract</span><span class="p">){</span>
        <span class="n">_addrSeller</span> <span class="o">=</span> <span class="n">sellerContract</span><span class="p">;</span>
        <span class="n">_addrBuyer</span> <span class="o">=</span> <span class="n">buyerContract</span><span class="p">;</span>
        <span class="n">_status</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Inited</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">escrowFund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">_addrSeller</span><span class="p">){</span>
            <span class="nb">require</span><span class="p">(</span><span class="n">_status</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="p">.</span><span class="n">Running</span><span class="p">,</span> <span class="s">"must be running state"</span><span class="p">);</span>
            <span class="n">_fundSeller</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">_to</span><span class="p">;</span>
            <span class="n">_fundSeller</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">_value</span><span class="p">;</span>
            <span class="n">_status</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Success</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">_addrBuyer</span><span class="p">){</span>
            <span class="nb">require</span><span class="p">(</span><span class="n">_status</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="p">.</span><span class="n">Inited</span><span class="p">,</span> <span class="s">"must be init state"</span><span class="p">);</span>
            <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">_to</span><span class="p">;</span>
            <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">_value</span><span class="p">;</span>
            <span class="n">_status</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Running</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nb">require</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">"Invalid to address"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">escrowRefund</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">){</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">_status</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="p">.</span><span class="n">Running</span><span class="p">,</span> <span class="s">"refund is only available on running state"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">_addrBuyer</span><span class="p">,</span> <span class="s">"invalid caller for refund"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">_fundBuyer</span><span class="p">.</span><span class="n">addr</span> <span class="o">==</span> <span class="n">_from</span><span class="p">,</span> <span class="s">"only buyer can refund"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">,</span> <span class="s">"buyer fund is not enough to refund"</span><span class="p">);</span>
        <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">-</span> <span class="n">amount</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">escrowWithdraw</span><span class="p">()</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">){</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">_status</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="s">"withdraw is only available on success state"</span><span class="p">);</span>
        <span class="kt">uint256</span> <span class="n">common</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">_fundSeller</span><span class="p">.</span><span class="n">amount</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">common</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">-</span> <span class="n">common</span><span class="p">;</span>
            <span class="n">_fundSeller</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">_fundSeller</span><span class="p">.</span><span class="n">amount</span> <span class="o">-</span> <span class="n">common</span><span class="p">;</span>

            <span class="c1">// Exchange
</span>            <span class="n">IERC5528</span><span class="p">(</span><span class="n">_addrSeller</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_fundBuyer</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">common</span><span class="p">);</span>
            <span class="n">IERC5528</span><span class="p">(</span><span class="n">_addrBuyer</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_fundSeller</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">common</span><span class="p">);</span>

            <span class="c1">// send back the remaining balances
</span>            <span class="k">if</span><span class="p">(</span><span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">IERC5528</span><span class="p">(</span><span class="n">_addrBuyer</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_fundBuyer</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">_fundBuyer</span><span class="p">.</span><span class="n">amount</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">_fundSeller</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">IERC5528</span><span class="p">(</span><span class="n">_addrSeller</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_fundSeller</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">_fundSeller</span><span class="p">.</span><span class="n">amount</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">_status</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Closed</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h2 id="rationale">Rationale</h2>

<p>The interfaces cover the escrow operation’s refundable issue.</p>

<p>The suggested 3 functions (<code class="language-plaintext highlighter-rouge">escrowFund</code>, <code class="language-plaintext highlighter-rouge">escrowRefund</code> and <code class="language-plaintext highlighter-rouge">escrowWithdraw</code>) are based on <code class="language-plaintext highlighter-rouge">transfer</code> function in EIP-20.</p>

<p><code class="language-plaintext highlighter-rouge">escrowFund</code> send tokens to the <em>Escrow Contract</em>. The <em>Escrow Contract</em> can hold the contract in the escrow process or reject tokens if the policy does not meet.</p>

<p><code class="language-plaintext highlighter-rouge">escrowRefund</code> can be invoked in the middle of the escrow process or when the escrow process fails.</p>

<p><code class="language-plaintext highlighter-rouge">escrowWithdraw</code> allows users (sellers and buyers) to transfer tokens from the escrow account. When the escrow process completes, the seller can get the buyer’s token, and the buyers can get the seller’s token.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>The <em>Payable Contract</em> which implements this EIP is fully backward compatible with the <a href="./eip-20.md">EIP-20</a> specification.</p>

<h2 id="test-cases">Test Cases</h2>

<p><a href="../assets/eip-5528/truffule-test.js">Unit test example by truffle</a>.</p>

<p>This test case demonstrates the following conditions for exchanging seller/buyer tokens.</p>

<ul>
  <li>The exchange rate is one-to-one.</li>
  <li>If the number of buyers reaches 2, the escrow process will be terminated(success).</li>
  <li>Otherwise (not meeting success condition yet), buyers can refund (or withdraw) their funded tokens.</li>
</ul>

<h2 id="security-considerations">Security Considerations</h2>

<p>Since the <em>Escrow Contract</em> controls seller and buyer rights, flaws within the <em>Escrow Contract</em> will directly lead to unexpected behavior and potential loss of funds.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
