<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Token State Fingerprint | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Token State Fingerprint | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-5646" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-5646" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Token State Fingerprint</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This specification defines the minimum interface required to unambiguously identify the state of a mutable token without knowledge of implementation details.</p>

<h2 id="motivation">Motivation</h2>

<p>Currently, protocols need to know about tokens’ state properties to create the unambiguous identifier. Unfortunately, this leads to an obvious bottleneck in which protocols need to support every new token specifically.</p>

<p><img src="../assets/eip-5646/support-per-abi.png" alt="" /></p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “SHOULD”, “SHOULD NOT”, and “MAY” in this document are to be interpreted as described in RFC 2119.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">ERC5646</span> <span class="k">is</span> <span class="n">ERC165</span> <span class="p">{</span>

    <span class="c1">/// @notice Function to return current token state fingerprint.
</span>    <span class="c1">/// @param tokenId Id of a token state in question.
</span>    <span class="c1">/// @return Current token state fingerprint.
</span>    <span class="k">function</span> <span class="n">getStateFingerprint</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">tokenId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getStateFingerprint</code> MUST return a different value when the token state changes.</li>
  <li><code class="language-plaintext highlighter-rouge">getStateFingerprint</code> MUST NOT return a different value when the token state remains the same.</li>
  <li><code class="language-plaintext highlighter-rouge">getStateFingerprint</code> MUST include all state properties that might change during the token lifecycle (are not immutable).</li>
  <li><code class="language-plaintext highlighter-rouge">getStateFingerprint</code> MAY include computed values, such as values based on a current timestamp (e.g., expiration, maturity).</li>
  <li><code class="language-plaintext highlighter-rouge">getStateFingerprint</code> MAY include token metadata URI.</li>
  <li><code class="language-plaintext highlighter-rouge">supportsInterface(0xf5112315)</code> MUST return <code class="language-plaintext highlighter-rouge">true</code>.</li>
</ul>

<h2 id="rationale">Rationale</h2>

<p>Protocols can use state fingerprints as a part of a token identifier and support mutable tokens without knowing any state implementation details.</p>

<p><img src="../assets/eip-5646/support-per-eip.png" alt="" /></p>

<p>State fingerprints don’t have to factor in state properties that are immutable, because they can be safely identified by a token id.</p>

<p>This standard is not for use cases where token state property knowledge is required, as these cases cannot escape the bottleneck problem described earlier.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This EIP is not introducing any backward incompatibilities.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">/// @title Example of a mutable token implementing state fingerprint.
</span><span class="k">contract</span> <span class="n">LPToken</span> <span class="k">is</span> <span class="n">ERC721</span><span class="p">,</span> <span class="n">ERC5646</span> <span class="p">{</span>

    <span class="c1">/// @dev Stored token states (token id =&gt; state).
</span>    <span class="k">mapping</span> <span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">State</span><span class="p">)</span> <span class="k">internal</span> <span class="n">states</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">State</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">asset1</span><span class="p">;</span>
        <span class="kt">address</span> <span class="n">asset2</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">amount1</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">amount2</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">fee</span><span class="p">;</span> <span class="c1">// Immutable
</span>        <span class="kt">address</span> <span class="n">operator</span><span class="p">;</span> <span class="c1">// Immutable
</span>        <span class="kt">uint256</span> <span class="n">expiration</span><span class="p">;</span> <span class="c1">// Parameter dependent on a block.timestamp
</span>    <span class="p">}</span>


    <span class="c1">/// @dev State fingerprint getter.
</span>    <span class="c1">/// @param tokenId Id of a token state in question.
</span>    <span class="c1">/// @return Current token state fingerprint.
</span>    <span class="k">function</span> <span class="n">getStateFingerprint</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">tokenId</span><span class="p">)</span> <span class="k">override</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">State</span> <span class="k">storage</span> <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">tokenId</span><span class="p">];</span>

        <span class="k">return</span> <span class="nb">keccak256</span><span class="p">(</span>
            <span class="n">abi</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">state</span><span class="p">.</span><span class="n">asset1</span><span class="p">,</span>
                <span class="n">state</span><span class="p">.</span><span class="n">asset2</span><span class="p">,</span>
                <span class="n">state</span><span class="p">.</span><span class="n">amount1</span><span class="p">,</span>
                <span class="n">state</span><span class="p">.</span><span class="n">amount2</span><span class="p">,</span>
                <span class="c1">// state.fee don't need to be part of the fingerprint computation as it is immutable
</span>                <span class="c1">// state.operator don't need to be part of the fingerprint computation as it is immutable
</span>                <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">state</span><span class="p">.</span><span class="n">expiration</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">supportsInterface</span><span class="p">(</span><span class="kt">bytes4</span> <span class="n">interfaceId</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">virtual</span> <span class="k">override</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">.</span><span class="n">supportsInterface</span><span class="p">(</span><span class="n">interfaceId</span><span class="p">)</span> <span class="o">||</span>
            <span class="n">interfaceId</span> <span class="o">==</span> <span class="k">type</span><span class="p">(</span><span class="n">ERC5646</span><span class="p">).</span><span class="n">interfaceId</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<p>Token state fingerprints from two different contracts may collide. Because of that, they should be compared only in the context of one token contract.</p>

<p>If the <code class="language-plaintext highlighter-rouge">getStateFingerprint</code> implementation does not include all parameters that could change the token state, a token owner would be able to change the token state without changing the token fingerprint. It could break the trustless assumptions of several protocols, which create, e.g., buy offers for tokens. The token owner would be able to change the state of the token before accepting an offer.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
