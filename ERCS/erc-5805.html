<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Voting with delegation | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Voting with delegation | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-5805" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-5805" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Voting with delegation</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>Many DAOs (decentralized autonomous organizations) rely on tokens to represent one’s voting power. In order to perform this task effectively, the token contracts need to include specific mechanisms such as checkpoints and delegation. The existing implementations are not standardized. This ERC proposes to standardize the way votes are delegated from one account to another, and the way current and past votes are tracked and queried. The corresponding behavior is compatible with many token types, including but not limited to <a href="./eip-20.md">ERC-20</a> and <a href="./eip-721.md">ERC-721</a>. This ERC also considers the diversity of time tracking functions, allowing the voting tokens (and any contract associated with it) to track the votes based on <code class="language-plaintext highlighter-rouge">block.number</code>, <code class="language-plaintext highlighter-rouge">block.timestamp</code>, or any other non-decreasing function.</p>

<h2 id="motivation">Motivation</h2>

<p>Beyond simple monetary transactions, decentralized autonomous organizations are arguably one of the most important use cases of blockchain and smart contract technologies. Today, many communities are organized around a governance contract that allows users to vote. Among these communities, some represent voting power using transferable tokens (<a href="./eip-20.md">ERC-20</a>, <a href="./eip-721.md">ERC-721</a>, other). In this context, the more tokens one owns, the more voting power one has. Governor contracts, such as Compound’s <code class="language-plaintext highlighter-rouge">GovernorBravo</code>, read from these “voting token” contracts to get the voting power of the users.</p>

<p>Unfortunately, simply using the <code class="language-plaintext highlighter-rouge">balanceOf(address)</code> function present in most token standards is not good enough:</p>

<ul>
  <li>The values are not checkpointed, so a user can vote, transfer its tokens to a new account, and vote again with the same tokens.</li>
  <li>A user cannot delegate their voting power to someone else without transferring full ownership of the tokens.</li>
</ul>

<p>These constraints have led to the emergence of voting tokens with delegation that contain the following logic:</p>

<ul>
  <li>Users can delegate the voting power of their tokens to themselves or a third party. This creates a distinction between balance and voting weight.</li>
  <li>The voting weights of accounts are checkpointed, allowing lookups for past values at different points in time.</li>
  <li>The balances are not checkpointed.</li>
</ul>

<p>This ERC is proposing to standardize the interface and behavior of these voting tokens.</p>

<p>Additionally, the existing (non-standardized) implementations are limited to <code class="language-plaintext highlighter-rouge">block.number</code> based checkpoints. This choice causes many issues in a multichain environment, where some chains (particularly L2s) have an inconsistent or unpredictable time between blocks. This ERC also addresses this issue by allowing the voting token to use any time tracking function it wants, and exposing it so that other contracts (such as a Governor) can stay consistent with the token checkpoints.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119.</p>

<p>Following pre-existing (but not-standardized) implementation, the EIP proposes the following mechanism.</p>

<p>Each user account (address) can delegate to an account of its choice. This can be itself, someone else, or no one (represented by <code class="language-plaintext highlighter-rouge">address(0)</code>). Assets held by the user cannot express their voting power unless they are delegated.</p>

<p>When a “delegator” delegates its tokens voting power to a “delegatee”, its balance is added to the voting power of the delegatee. If the delegator changes its delegation, the voting power is subtracted from the old delegatee’s voting power and added to the new delegate’s voting power. The voting power of each account is tracked through time so that it is possible to query its value in the past. With tokens being delegated to at most one delegate at a given point in time, double voting is prevented.</p>

<p>Whenever tokens are transferred from one account to another, the associated voting power should be deducted from the sender’s delegate and added to the receiver’s delegate.</p>

<p>Tokens that are delegated to <code class="language-plaintext highlighter-rouge">address(0)</code> should not be tracked. This allows users to optimize the gas cost of their token transfers by skipping the checkpoint update for their delegate.</p>

<p>To accommodate different types of chains, we want the voting checkpoint system to support different forms of time tracking. On the Ethereum mainnet, using block numbers provides backward compatibility with applications that historically use it. On the other hand, using timestamps provides better semantics for end users, and accommodates use cases where the duration is expressed in seconds. Other monotonic functions could also be deemed relevant by developers based on the characteristics of future applications and blockchains.</p>

<p>Both timestamps, block numbers, and other possible modes use the same external interfaces. This allows transparent binding of third-party contracts, such as governor systems, to the vote tracking built into the voting contracts. For this to be effective, the voting contracts must, in addition to all the vote-tracking functions, expose the current value used for time-tracking.</p>

<h3 id="methods">Methods</h3>

<h4 id="erc-6372-clock-and-clock_mode"><a href="./eip-6372.md">ERC-6372</a>: clock and CLOCK_MODE</h4>

<p>Compliant contracts SHOULD implement ERC-6372 (Contract clock) to announce the clock that is used for vote tracking.</p>

<p>If the contract does not implement ERC-6372, it MUST operate according to a block number clock, exactly as if ERC-6372’s <code class="language-plaintext highlighter-rouge">CLOCK_MODE</code> returned <code class="language-plaintext highlighter-rouge">mode=blocknumber&amp;from=default</code>.</p>

<p>In the following specification, “the current clock” refers to either the result of ERC-6372’s <code class="language-plaintext highlighter-rouge">clock()</code>, or the default of <code class="language-plaintext highlighter-rouge">block.number</code> in its absence.</p>

<h4 id="getvotes">getVotes</h4>

<p>This function returns the current voting weight of an account. This corresponds to all the voting power delegated to it at the moment this function is called.</p>

<p>As tokens delegated to <code class="language-plaintext highlighter-rouge">address(0)</code> should not be counted/snapshotted, <code class="language-plaintext highlighter-rouge">getVotes(0)</code> SHOULD always return <code class="language-plaintext highlighter-rouge">0</code>.</p>

<p>This function MUST be implemented</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">getVotes</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">account</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">votingWeight</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="getpastvotes">getPastVotes</h4>

<p>This function returns the historical voting weight of an account. This corresponds to all the voting power delegated to it at a specific timepoint. The timepoint parameter MUST match the operating mode of the contract. This function SHOULD only serve past checkpoints, which SHOULD be immutable.</p>

<ul>
  <li>Calling this function with a timepoint that is greater or equal to the current clock SHOULD revert.</li>
  <li>Calling this function with a timepoint strictly smaller than the current clock SHOULD NOT revert.</li>
  <li>For any integer that is strictly smaller than the current clock, the value returned by <code class="language-plaintext highlighter-rouge">getPastVotes</code> SHOULD be constant. This means that for any call to this function that returns a value, re-executing the same call (at any time in the future) SHOULD return the same value.</li>
</ul>

<p>As tokens delegated to <code class="language-plaintext highlighter-rouge">address(0)</code> should not be counted/snapshotted, <code class="language-plaintext highlighter-rouge">getPastVotes(0,x)</code> SHOULD always return <code class="language-plaintext highlighter-rouge">0</code> (for all values of <code class="language-plaintext highlighter-rouge">x</code>).</p>

<p>This function MUST be implemented</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">getPastVotes</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">account</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">timepoint</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">votingWeight</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="delegates">delegates</h4>

<p>This function returns the address to which the voting power of an account is currently delegated.</p>

<p>Note that if the delegate is <code class="language-plaintext highlighter-rouge">address(0)</code> then the voting power SHOULD NOT be checkpointed, and it should not be possible to vote with it.</p>

<p>This function MUST be implemented</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegates</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">account</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegatee</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
</code></pre></div></div>

<h4 id="delegate">delegate</h4>

<p>This function changes the caller’s delegate, updating the vote delegation in the meantime.</p>

<p>This function MUST be implemented</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegate</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">nonpayable</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegatee</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
  <span class="na">outputs</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div>

<h4 id="delegatebysig">delegateBySig</h4>

<p>This function changes an account’s delegate using a signature, updating the vote delegation in the meantime.</p>

<p>This function MUST be implemented</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegateBySig</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">nonpayable</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegatee</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nonce</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">expiry</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint8</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">r</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes32</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">s</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes32</span>
  <span class="na">outputs</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div>

<p>This signature should follow the <a href="./eip-712.md">EIP-712</a> format:</p>

<p>A call to <code class="language-plaintext highlighter-rouge">delegateBySig(delegatee, nonce, expiry, v, r, s)</code> changes the signer’s delegate to <code class="language-plaintext highlighter-rouge">delegatee</code>, increment the signer’s nonce by 1, and emits a corresponding <code class="language-plaintext highlighter-rouge">DelegateChanged</code> event, and possibly <code class="language-plaintext highlighter-rouge">DelegateVotesChanged</code> events for the old and the new delegate accounts, if and only if the following conditions are met:</p>

<ul>
  <li>The current timestamp is less than or equal to <code class="language-plaintext highlighter-rouge">expiry</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">nonces(signer)</code> (before the state update) is equal to <code class="language-plaintext highlighter-rouge">nonce</code>.</li>
</ul>

<p>If any of these conditions are not met, the <code class="language-plaintext highlighter-rouge">delegateBySig</code> call must revert. This translates to the following solidity code:</p>

<pre><code class="language-sol">require(expiry &lt;= block.timestamp)
bytes signer = ecrecover(
  keccak256(abi.encodePacked(
    hex"1901",
    DOMAIN_SEPARATOR,
    keccak256(abi.encode(
      keccak256("Delegation(address delegatee,uint256 nonce,uint256 expiry)"),
      delegatee,
      nonce,
      expiry)),
  v, r, s)
require(signer != address(0));
require(nounces[signer] == nonce);
// increment nonce
// set delegation of `signer` to `delegatee`
</code></pre>

<p>where <code class="language-plaintext highlighter-rouge">DOMAIN_SEPARATOR</code> is defined according to <a href="./eip-712.md">EIP-712</a>. The <code class="language-plaintext highlighter-rouge">DOMAIN_SEPARATOR</code> should be unique to the contract and chain to prevent replay attacks from other domains,
and satisfy the requirements of EIP-712, but is otherwise unconstrained.</p>

<p>A common choice for <code class="language-plaintext highlighter-rouge">DOMAIN_SEPARATOR</code> is:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DOMAIN_SEPARATOR</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span>
    <span class="n">abi</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="nb">keccak256</span><span class="p">(</span><span class="s">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span><span class="p">),</span>
        <span class="nb">keccak256</span><span class="p">(</span><span class="kt">bytes</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span>
        <span class="nb">keccak256</span><span class="p">(</span><span class="kt">bytes</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span>
        <span class="n">chainid</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)</span>
<span class="p">));</span>
</code></pre></div></div>

<p>In other words, the message is the EIP-712 typed structure:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">types</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">EIP712Domain</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">chainId</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">uint256</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">verifyingContract</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">address</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">Delegation</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span>
      <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">delegatee</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">address</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nonce</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">uint256</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">expiry</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">uint256</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">primaryType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Permit</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">domain</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">contractName</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span> <span class="nx">version</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">chainId</span><span class="dl">"</span><span class="p">:</span> <span class="nx">chainid</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">verifyingContract</span><span class="dl">"</span><span class="p">:</span> <span class="nx">contractAddress</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">delegatee</span><span class="dl">"</span><span class="p">:</span> <span class="nx">delegatee</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">nonce</span><span class="dl">"</span><span class="p">:</span> <span class="nx">nonce</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">expiry</span><span class="dl">"</span><span class="p">:</span> <span class="nx">expiry</span>
  <span class="p">}</span>
<span class="p">}}</span>
</code></pre></div></div>

<p>Note that nowhere in this definition do we refer to <code class="language-plaintext highlighter-rouge">msg.sender</code>. The caller of the <code class="language-plaintext highlighter-rouge">delegateBySig</code> function can be any address.</p>

<p>When this function is successfully executed, the delegator’s nonce MUST be incremented to prevent replay attacks.</p>

<h4 id="nonces">nonces</h4>

<p>This function returns the current nonce for a given account.</p>

<p>Signed delegations (see <code class="language-plaintext highlighter-rouge">delegateBySig</code>) are only accepted if the nonce used in the EIP-712 signature matches the return of this function. This value of <code class="language-plaintext highlighter-rouge">nonce(delegator)</code> should be incremented whenever a call to <code class="language-plaintext highlighter-rouge">delegateBySig</code> is performed on behalf of <code class="language-plaintext highlighter-rouge">delegator</code>.</p>

<p>This function MUST be implemented</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nonces</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">account</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">delegator</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nonce</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h3 id="events">Events</h3>

<h4 id="delegatechanged">DelegateChanged</h4>

<p><code class="language-plaintext highlighter-rouge">delegator</code> changes the delegation of its assets from <code class="language-plaintext highlighter-rouge">fromDelegate</code> to <code class="language-plaintext highlighter-rouge">toDelegate</code>.</p>

<p>MUST be emitted when the delegate for an account is modified by <code class="language-plaintext highlighter-rouge">delegate(address)</code> or <code class="language-plaintext highlighter-rouge">delegateBySig(address,uint256,uint256,uint8,bytes32,bytes32)</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DelegateChanged</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">event</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegator</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fromDelegate</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">toDelegate</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
</code></pre></div></div>

<h4 id="delegatevoteschanged">DelegateVotesChanged</h4>

<p><code class="language-plaintext highlighter-rouge">delegate</code> available voting power changes from <code class="language-plaintext highlighter-rouge">previousBalance</code> to <code class="language-plaintext highlighter-rouge">newBalance</code>.</p>

<p>This MUST be emitted when:</p>

<ul>
  <li>an account (that holds more than 0 assets) updates its delegation from or to <code class="language-plaintext highlighter-rouge">delegate</code>,</li>
  <li>an asset transfer from or to an account that is delegated to <code class="language-plaintext highlighter-rouge">delegate</code>.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DelegateVotesChanged</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">event</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delegate</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">previousBalance</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">newBalance</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h3 id="solidity-interface">Solidity interface</h3>

<pre><code class="language-sol">interface IERC5805 is IERC6372 /* (optional) */ {
  event DelegateChanged(address indexed delegator, address indexed fromDelegate, address indexed toDelegate);
  event DelegateVotesChanged(address indexed delegate, uint256 previousBalance, uint256 newBalance);

  function getVotes(address account) external view returns (uint256);
  function getPastVotes(address account, uint256 timepoint) external view returns (uint256);
  function delegates(address account) external view returns (address);
  function nonces(address owner) public view virtual returns (uint256)

  function delegate(address delegatee) external;
  function delegateBySig(address delegatee, uint256 nonce, uint256 expiry, uint8 v, bytes32 r, bytes32 s) external;
}
</code></pre>

<h3 id="expected-properties">Expected properties</h3>

<p>Let <code class="language-plaintext highlighter-rouge">clock</code> be the current clock.</p>

<ul>
  <li>For all timepoints <code class="language-plaintext highlighter-rouge">t &lt; clock</code>, <code class="language-plaintext highlighter-rouge">getVotes(address(0))</code> and <code class="language-plaintext highlighter-rouge">getPastVotes(address(0), t)</code> SHOULD return 0.</li>
  <li>For all accounts <code class="language-plaintext highlighter-rouge">a != 0</code>, <code class="language-plaintext highlighter-rouge">getVotes(a)</code> SHOULD be the sum of the “balances” of all the accounts that delegate to <code class="language-plaintext highlighter-rouge">a</code>.</li>
  <li>For all accounts <code class="language-plaintext highlighter-rouge">a != 0</code> and all timestamp <code class="language-plaintext highlighter-rouge">t &lt; clock</code>, <code class="language-plaintext highlighter-rouge">getPastVotes(a, t)</code> SHOULD be the sum of the “balances” of all the accounts that delegated to <code class="language-plaintext highlighter-rouge">a</code> when <code class="language-plaintext highlighter-rouge">clock</code> overtook <code class="language-plaintext highlighter-rouge">t</code>.</li>
  <li>For all accounts <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">getPastVotes(a, t)</code> MUST be constant after <code class="language-plaintext highlighter-rouge">t &lt; clock</code> is reached.</li>
  <li>For all accounts <code class="language-plaintext highlighter-rouge">a</code>, the action of changing the delegate from <code class="language-plaintext highlighter-rouge">b</code> to <code class="language-plaintext highlighter-rouge">c</code> MUST not increase the current voting power of <code class="language-plaintext highlighter-rouge">b</code> (<code class="language-plaintext highlighter-rouge">getVotes(b)</code>) and MUST not decrease the current voting power of <code class="language-plaintext highlighter-rouge">c</code> (<code class="language-plaintext highlighter-rouge">getVotes(c)</code>).</li>
</ul>

<h2 id="rationale">Rationale</h2>

<p>Delegation allows token holders to trust a delegate with their vote while keeping full custody of their token. This means that only a small-ish number of delegates need to pay gas for voting. This leads to better representation of small token holders by allowing their votes to be cast without requiring them to pay expensive gas fees. Users can take over their voting power at any point, and delegate it to someone else, or to themselves.</p>

<p>The use of checkpoints prevents double voting. Votes, for example in the context of a governance proposal, should rely on a snapshot defined by a timepoint. Only tokens delegated at that timepoint can be used for voting. This means any token transfer performed after the snapshot will not affect the voting power of the sender/receiver’s delegate. This also means that in order to vote, someone must acquire tokens and delegate them before the snapshot is taken. Governors can, and do, include a delay between the proposal is submitted and the snapshot is taken so that users can take the necessary actions (change their delegation, buy more tokens, …).</p>

<p>While timestamps produced by ERC-6372’s <code class="language-plaintext highlighter-rouge">clock</code> are represented as <code class="language-plaintext highlighter-rouge">uint48</code>, <code class="language-plaintext highlighter-rouge">getPastVotes</code>’s timepoint argument is <code class="language-plaintext highlighter-rouge">uint256</code> for backward compatibility. Any timepoint <code class="language-plaintext highlighter-rouge">&gt;=2**48</code> passed to <code class="language-plaintext highlighter-rouge">getPastVotes</code> SHOULD cause the function to revert, as it would be a lookup in the future.</p>

<p><code class="language-plaintext highlighter-rouge">delegateBySig</code> is necessary to offer a gasless workflow to token holders that do not want to pay gas for voting.</p>

<p>The <code class="language-plaintext highlighter-rouge">nonces</code> mapping is given for replay protection.</p>

<p>EIP-712 typed messages are included because of their widespread adoption in many wallet providers.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>Compound and OpenZeppelin already provide implementations of voting tokens. The delegation-related methods are shared between the two implementations and this ERC. For the vote lookup, this ERC uses OpenZeppelin’s implementation (with return type uint256) as Compound’s implementation causes significant restrictions of the acceptable values (return type is uint96).</p>

<p>Both implementations use <code class="language-plaintext highlighter-rouge">block.number</code> for their checkpoints and do not implement ERC-6372, which is compatible with this ERC.</p>

<p>Existing governors, that are currently compatible with OpenZeppelin’s implementation will be compatible with the “block number mode” of this ERC.</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>Before doing a lookup, one should check the return value of <code class="language-plaintext highlighter-rouge">clock()</code> and make sure that the parameters of the lookup are consistent. Performing a lookup using a timestamp argument on a contract that uses block numbers will very likely cause a revert. On the other end, performing a lookup using a block number argument on a contract that uses timestamps will likely return 0.</p>

<p>Though the signer of a <code class="language-plaintext highlighter-rouge">Delegation</code> may have a certain party in mind to submit their transaction, another party can always front-run this transaction and call <code class="language-plaintext highlighter-rouge">delegateBySig</code> before the intended party. The result is the same for the <code class="language-plaintext highlighter-rouge">Delegation</code> signer, however.</p>

<p>Since the ecrecover precompile fails silently and just returns the zero address as <code class="language-plaintext highlighter-rouge">signer</code> when given malformed messages, it is important to ensure <code class="language-plaintext highlighter-rouge">signer != address(0)</code> to avoid <code class="language-plaintext highlighter-rouge">delegateBySig</code> from delegating “zombie funds” belonging to the zero address.</p>

<p>Signed <code class="language-plaintext highlighter-rouge">Delegation</code> messages are censorable. The relaying party can always choose to not submit the <code class="language-plaintext highlighter-rouge">Delegation</code> after having received it, withholding the option to submit it. The <code class="language-plaintext highlighter-rouge">expiry</code> parameter is one mitigation to this. If the signing party holds ETH they can also just submit the <code class="language-plaintext highlighter-rouge">Delegation</code> themselves, which can render previously signed <code class="language-plaintext highlighter-rouge">Delegation</code>s invalid.</p>

<p>If the <code class="language-plaintext highlighter-rouge">DOMAIN_SEPARATOR</code> contains the <code class="language-plaintext highlighter-rouge">chainId</code> and is defined at contract deployment instead of reconstructed for every signature, there is a risk of possible replay attacks between chains in the event of a future chain split.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
