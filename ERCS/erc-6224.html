<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Contracts Dependencies Registry | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Contracts Dependencies Registry | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-6224" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-6224" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Contracts Dependencies Registry</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This EIP introduces an on-chain registry system that a decentralized protocol may use to manage its smart contracts.</p>

<p>The proposed system consists of two components: <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> and <code class="language-plaintext highlighter-rouge">Dependant</code>. The <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> contract stores references to every smart contract used within a protocol, optionally making them upgradeable by deploying self-managed proxies on top, and acts as a hub the <code class="language-plaintext highlighter-rouge">Dependant</code> contracts query to fetch their required dependencies from.</p>

<h2 id="motivation">Motivation</h2>

<p>In the ever-growing Ethereum ecosystem, projects tend to become more and more complex. Modern protocols require portability and agility to satisfy customer needs by continuously delivering new features and staying on pace with the industry. However, the requirement is hard to achieve due to the immutable nature of blockchains and smart contracts. Moreover, the increased complexity and continuous delivery bring bugs and entangle the dependencies between the contracts, making systems less supportable.</p>

<p>Applications that have a clear architectural facade; which are designed with forward compatibility in mind; which dependencies are transparent and clean are easier to develop and maintain. The given EIP tries to solve the aforementioned problems by presenting two smart contracts: the <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> and the <code class="language-plaintext highlighter-rouge">Dependant</code>.</p>

<p>The advantages of using the provided system might be:</p>

<ul>
  <li>Structured smart contracts management via specialized contracts.</li>
  <li>Ad-hoc upgradeability provision of a protocol.</li>
  <li>Runtime addition, removal, and substitution of smart contracts.</li>
  <li>Dependency injection mechanism to keep smart contracts’ dependencies under control.</li>
  <li>Ability to specify custom access control rules to maintain the protocol.</li>
</ul>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<h3 id="overview">Overview</h3>

<p>The system consists of two smart contracts:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ContractsRegistry</code> that is a singleton registry to manage and upgrade a protocol’s smart contracts.</li>
  <li><code class="language-plaintext highlighter-rouge">Dependant</code> that is a mix-in which enables a dependency injection mechanism.</li>
</ul>

<p>The following diagram depicts the relationship between the registry and its dependants:</p>

<p><img src="../assets/eip-6224/diagram.svg" alt="" /></p>

<h3 id="contractsregistry">ContractsRegistry</h3>

<p>The <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> is the main contract of the proposed system. It MUST store the references to every standalone contract used within a protocol. The <code class="language-plaintext highlighter-rouge">ContractRegistry</code> MAY be configured to deploy a proxy contract of choice on top of the registered contracts.</p>

<p>Additionally, the <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> MUST reject the registration of zero addresses.</p>

<p>The <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> MUST implement the following interface:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IContractsRegistry</span> <span class="p">{</span>
    <span class="cm">/**
     * @notice The event that is emitted when the contract gets added to the registry
     * @param name the name of the contract
     * @param contractAddress the address of the added contract
     */</span>
    <span class="k">event</span> <span class="n">ContractAdded</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">);</span>
 
    <span class="cm">/**
     * @notice The event that is emitted when the proxy contract gets added to the registry
     * @param name the name of the contract
     * @param contractAddress the address of the proxy contract
     * @param implementation the address of the implementation contract
     */</span>
    <span class="k">event</span> <span class="n">ProxyContractAdded</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">,</span> <span class="kt">address</span> <span class="n">implementation</span><span class="p">);</span>
 
    <span class="cm">/**
     * @notice The event that is emitted when the proxy contract gets upgraded through the registry
     * @param name the name of the contract
     * @param newImplementation the address of the new implementation contract
     */</span>
    <span class="k">event</span> <span class="n">ProxyContractUpgraded</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">);</span>
 
    <span class="cm">/**
     * @notice The event that is emitted when the contract gets removed from the registry
     * @param name the name of the removed contract
     */</span>
    <span class="k">event</span> <span class="n">ContractRemoved</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
 
    <span class="cm">/**
     * @notice The function that returns an associated contract by the name. 
     *
     * MUST revert if the requested contract is `address(0)`
     *
     * @param name the name of the contract
     * @return the address of the contract
     */</span>
    <span class="k">function</span> <span class="n">getContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">);</span>
 
    <span class="cm">/**
     * @notice The function that checks if a contract with a given name has been added
     * @param name the name of the contract
     * @return true if the contract is present in the registry
     */</span>
    <span class="k">function</span> <span class="n">hasContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>
 
    <span class="cm">/**
     * @notice The function that injects dependencies into the given contract.
     *
     * MUST call the `setDependencies()` with `address(this)` and `bytes("")` as arguments on the provided contract
     *
     * @param name the name of the contract
     */</span>
    <span class="k">function</span> <span class="n">injectDependencies</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that injects dependencies into the given contract with extra data.
     *
     * MUST call the `setDependencies()` with `address(this)` and `data` as arguments on the provided contract
     *
     * @param name the name of the contract
     * @param data the extra context data that will be passed to the dependant contract
     */</span>
    <span class="k">function</span> <span class="n">injectDependenciesWithData</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span>
    <span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that upgrades added proxy contract with a new implementation.
     *
     * It is the Owner's responsibility to ensure the compatibility between implementations.
     *
     * MUST emit `ProxyContractUpgraded` event
     *
     * @param name the name of the proxy contract
     * @param newImplementation the new implementation the proxy will be upgraded to
     */</span>
    <span class="k">function</span> <span class="n">upgradeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that upgrades added proxy contract with a new implementation, providing data
     *
     * It is the Owner's responsibility to ensure the compatibility between implementations.
     *
     * MUST emit `ProxyContractUpgraded` event
     *
     * @param name the name of the proxy contract
     * @param newImplementation the new implementation the proxy will be upgraded to
     * @param data the data that the proxy will be called with after upgrade. This can be an ABI encoded function call
     */</span>
    <span class="k">function</span> <span class="n">upgradeContractAndCall</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span>
    <span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that adds pure (non-proxy) contracts to the `ContractsRegistry`. The contracts MAY either be
     * the ones the system does not have direct upgradeability control over or those that are not upgradeable by design.
     *
     * MUST emit `ContractAdded` event. Reverts if the provided address is `address(0)`
     *
     * @param name the name to associate the contract with
     * @param contractAddress the address of the contract to be added
     */</span>
    <span class="k">function</span> <span class="n">addContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that adds the proxy contracts to the registry by deploying them above the provided implementation.
     *
     * The function may be used to add a contract that the `ContractsRegistry` has to be able to upgrade.
     *
     * MUST emit `ProxyContractAdded` event. Reverts if implementation address is `address(0)`
     *
     * @param name the name to associate the contract with
     * @param contractAddress the address of the implementation to point the proxy to
     */</span>
    <span class="k">function</span> <span class="n">addProxyContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that adds the proxy contracts to the registry by deploying them above the provided implementation,
     * providing data.
     *
     * The function may be used to add a contract that the `ContractsRegistry` has to be able to upgrade.
     *
     * MUST emit `ProxyContractAdded` event. Reverts if implementation address is `address(0)`
     *
     * @param name the name to associate the contract with
     * @param contractAddress the address of the implementation
     * @param data the data that the proxy will be called with. This can be an ABI encoded initialization call
     */</span>
    <span class="k">function</span> <span class="n">addProxyContractAndCall</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span>
    <span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that adds an already deployed proxy to the `ContractsRegistry`. It MAY be used
     * when the system migrates to the new `ContractRegistry`. In that case, the new registry MUST have the
     * credentials to upgrade the newly added proxies.
     *
     * MUST emit `ProxyContractAdded` event. Reverts if implementation address is `address(0)`
     *
     * @param name the name to associate the contract with
     * @param contractAddress the address of the proxy
     */</span>
    <span class="k">function</span> <span class="n">justAddProxyContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function to remove contracts from the ContractsRegistry.
     *
     * MUST emit `ContractRemoved` event. Reverts if the contract is already removed
     *
     * @param name the associated name with the contract
     */</span>
    <span class="k">function</span> <span class="n">removeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="dependant">Dependant</h3>

<p>The <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> works together with the <code class="language-plaintext highlighter-rouge">Dependant</code> contract. Every standalone contract of a protocol MUST inherit <code class="language-plaintext highlighter-rouge">Dependant</code> in order to support the dependency injection mechanism.</p>

<p>The required dependencies MUST be set in the overridden <code class="language-plaintext highlighter-rouge">setDependencies</code> method, not in the <code class="language-plaintext highlighter-rouge">constructor</code> or <code class="language-plaintext highlighter-rouge">initializer</code> methods.</p>

<p>Only the injector MUST be able to call the <code class="language-plaintext highlighter-rouge">setDependencies</code> and <code class="language-plaintext highlighter-rouge">setInjector</code> methods. The initial injector will be a zero address, in that case, the call MUST NOT revert on access control checks.</p>

<p>The <code class="language-plaintext highlighter-rouge">Dependant</code> contract MUST implement the following interface:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IDependant</span> <span class="p">{</span>
    <span class="cm">/**
     * @notice The function that is called from the `ContractsRegistry` to inject dependencies.
     *
     * The contract MUST perform a proper access check of `msg.sender`. The calls should only be possible from `ContractsRegistry`
     *
     * @param contractsRegistry the registry to pull dependencies from
     * @param data the extra data that might provide additional application-specific context
     */</span>
    <span class="k">function</span> <span class="n">setDependencies</span><span class="p">(</span><span class="kt">address</span> <span class="n">contractsRegistry</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that sets the new dependency injector.
     *
     * The contract MUST perform a proper access check of `msg.sender`
     *
     * @param injector the new dependency injector
     */</span>
    <span class="k">function</span> <span class="n">setInjector</span><span class="p">(</span><span class="kt">address</span> <span class="n">injector</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="cm">/**
     * @notice The function that gets the current dependency injector
     * @return the current dependency injector
     */</span>
    <span class="k">function</span> <span class="n">getInjector</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">Dependant</code> contract MAY store the dependency injector (usually <code class="language-plaintext highlighter-rouge">ContractsRegistry</code>) address in the special slot <code class="language-plaintext highlighter-rouge">0x3d1f25f1ac447e55e7fec744471c4dab1c6a2b6ffb897825f9ea3d2e8c9be583</code> (obtained as <code class="language-plaintext highlighter-rouge">bytes32(uint256(keccak256("eip6224.dependant.slot")) - 1)</code>).</li>
</ul>

<h2 id="rationale">Rationale</h2>

<p>There are a few design decisions that have to be explicitly specified:</p>

<h3 id="contractsregistry-rationale">ContractsRegistry Rationale</h3>

<h4 id="contracts-identifier">Contracts Identifier</h4>

<p>The <code class="language-plaintext highlighter-rouge">string</code> contracts identifier is chosen over the <code class="language-plaintext highlighter-rouge">uint256</code> and <code class="language-plaintext highlighter-rouge">bytes32</code> to maintain code readability and reduce the human error chances when interacting with the <code class="language-plaintext highlighter-rouge">ContractsRegistry</code>. Being the topmost smart contract of a protocol, it MAY be typical for the users to interact with it via block explorers or DAOs. Clarity was prioritized over gas usage.</p>

<p>Due to the <code class="language-plaintext highlighter-rouge">string</code> identifier, the event parameters are not indexed. The <code class="language-plaintext highlighter-rouge">string indexed</code> parameter will become the <code class="language-plaintext highlighter-rouge">keccak256</code> hash of the contract name if it is larger than 32 bytes. This fact reduces readability, which was prioritized.</p>

<h4 id="reverts">Reverts</h4>

<p>The <code class="language-plaintext highlighter-rouge">getContract</code> view function reverts if the requested contract is <code class="language-plaintext highlighter-rouge">address(0)</code>. This is essential to minimize the risks of misinitialization of a protocol. Correct contracts SHOULD be added to the registry prior to any dependency injection actions.</p>

<p>The <code class="language-plaintext highlighter-rouge">addContract</code>, <code class="language-plaintext highlighter-rouge">addProxyContract</code>, <code class="language-plaintext highlighter-rouge">addProxyContractAndCall</code>, and <code class="language-plaintext highlighter-rouge">justAddProxyContract</code> methods revert if the provided address is <code class="language-plaintext highlighter-rouge">address(0)</code> for the same risk minimization reason.</p>

<h3 id="dependant-rationale">Dependant Rationale</h3>

<h4 id="dependencies">Dependencies</h4>

<p>The <code class="language-plaintext highlighter-rouge">data</code> parameter is provided to carry additional application-specific context. It MAY be used to extend the method’s behavior.</p>

<h4 id="injector">Injector</h4>

<p>The <code class="language-plaintext highlighter-rouge">setInjector</code> function is made <code class="language-plaintext highlighter-rouge">external</code> to support the dependency injection mechanism for factory-made contracts. However, the method SHOULD be used with extra care.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<blockquote>
  <p>Note that the reference implementation depends on OpenZeppelin contracts <code class="language-plaintext highlighter-rouge">4.9.2</code>.</p>
</blockquote>

<h3 id="contractsregistry-implementation">ContractsRegistry Implementation</h3>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="n">Address</span><span class="p">}</span> <span class="n">from</span> <span class="s">"@openzeppelin/contracts/utils/Address.sol"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="n">TransparentUpgradeableProxy</span><span class="p">}</span> <span class="n">from</span> <span class="s">"@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="n">OwnableUpgradeable</span><span class="p">}</span> <span class="n">from</span> <span class="s">"@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="n">Dependant</span><span class="p">}</span> <span class="n">from</span> <span class="s">"./Dependant.sol"</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IContractsRegistry</span> <span class="p">{</span>
    <span class="k">event</span> <span class="n">ContractAdded</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">);</span>
    <span class="k">event</span> <span class="n">ProxyContractAdded</span><span class="p">(</span>
        <span class="kt">string</span> <span class="n">name</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">implementation</span>
    <span class="p">);</span>
    <span class="k">event</span> <span class="n">ProxyContractUpgraded</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">);</span>
    <span class="k">event</span> <span class="n">ContractRemoved</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">getContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">hasContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">injectDependencies</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">injectDependenciesWithData</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">upgradeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">)</span>
        <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">upgradeContractAndCall</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span>
    <span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">addContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">addProxyContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span>
        <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">addProxyContractAndCall</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span>
    <span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">justAddProxyContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress</span><span class="p">)</span>
        <span class="k">external</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">removeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">contract</span> <span class="n">ProxyUpgrader</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">Address</span> <span class="k">for</span> <span class="kt">address</span><span class="p">;</span>

    <span class="kt">address</span> <span class="k">private</span> <span class="kr">immutable</span> <span class="n">_OWNER</span><span class="p">;</span>

    <span class="k">modifier</span> <span class="n">onlyOwner</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_onlyOwner</span><span class="p">();</span>
        <span class="n">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_OWNER</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">upgrade</span><span class="p">(</span><span class="kt">address</span> <span class="n">what_</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to_</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">data_</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyOwner</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data_</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TransparentUpgradeableProxy</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">what_</span><span class="p">)).</span><span class="n">upgradeToAndCall</span><span class="p">(</span><span class="n">to_</span><span class="p">,</span> <span class="n">data_</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">TransparentUpgradeableProxy</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">what_</span><span class="p">)).</span><span class="n">upgradeTo</span><span class="p">(</span><span class="n">to_</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getImplementation</span><span class="p">(</span><span class="kt">address</span> <span class="n">what_</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="n">onlyOwner</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// bytes4(keccak256("implementation()")) == 0x5c60da1b
</span>        <span class="p">(</span><span class="kt">bool</span> <span class="n">success_</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">returndata_</span><span class="p">)</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">what_</span><span class="p">).</span><span class="n">staticcall</span><span class="p">(</span><span class="s">hex"5c60da1b"</span><span class="p">);</span>

        <span class="nb">require</span><span class="p">(</span><span class="n">success_</span><span class="p">,</span> <span class="s">"ProxyUpgrader: not a proxy"</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">abi</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">returndata_</span><span class="p">,</span> <span class="p">(</span><span class="kt">address</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_onlyOwner</span><span class="p">()</span> <span class="k">internal</span> <span class="k">view</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">_OWNER</span> <span class="o">==</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="s">"ProxyUpgrader: not an owner"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">contract</span> <span class="n">ContractsRegistry</span> <span class="k">is</span> <span class="n">IContractsRegistry</span><span class="p">,</span> <span class="n">OwnableUpgradeable</span> <span class="p">{</span>
    <span class="n">ProxyUpgrader</span> <span class="k">private</span> <span class="n">_proxyUpgrader</span><span class="p">;</span>

    <span class="k">mapping</span><span class="p">(</span><span class="kt">string</span> <span class="o">=&gt;</span> <span class="kt">address</span><span class="p">)</span> <span class="k">private</span> <span class="n">_contracts</span><span class="p">;</span>
    <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="k">private</span> <span class="n">_isProxy</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__ContractsRegistry_init</span><span class="p">()</span> <span class="k">public</span> <span class="n">initializer</span> <span class="p">{</span>
        <span class="n">_proxyUpgrader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProxyUpgrader</span><span class="p">();</span>

        <span class="n">__Ownable_init</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">contractAddress_</span> <span class="o">=</span> <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">];</span>

        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractAddress_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: this mapping doesn't exist"</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="n">contractAddress_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">hasContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">]</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getProxyUpgrader</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="n">_proxyUpgrader</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">injectDependencies</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">)</span> <span class="k">public</span> <span class="k">virtual</span> <span class="n">onlyOwner</span> <span class="p">{</span>
        <span class="n">injectDependenciesWithData</span><span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">""</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">injectDependenciesWithData</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data_</span><span class="p">)</span>
        <span class="k">public</span>
        <span class="k">virtual</span>
        <span class="n">onlyOwner</span>
    <span class="p">{</span>
        <span class="kt">address</span> <span class="n">contractAddress_</span> <span class="o">=</span> <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">];</span>

        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractAddress_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: this mapping doesn't exist"</span>
        <span class="p">);</span>

        <span class="n">Dependant</span> <span class="n">dependant_</span> <span class="o">=</span> <span class="n">Dependant</span><span class="p">(</span><span class="n">contractAddress_</span><span class="p">);</span>
        <span class="n">dependant_</span><span class="p">.</span><span class="n">setDependencies</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">data_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">upgradeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span> <span class="kt">address</span> <span class="n">newImplementation_</span><span class="p">)</span>
        <span class="k">public</span>
        <span class="k">virtual</span>
        <span class="n">onlyOwner</span>
    <span class="p">{</span>
        <span class="n">upgradeContractAndCall</span><span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="n">newImplementation_</span><span class="p">,</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">""</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">upgradeContractAndCall</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">newImplementation_</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data_</span>
    <span class="p">)</span> <span class="k">public</span> <span class="k">virtual</span> <span class="n">onlyOwner</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">contractToUpgrade_</span> <span class="o">=</span> <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">];</span>

        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractToUpgrade_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: this mapping doesn't exist"</span>
        <span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span>
            <span class="n">_isProxy</span><span class="p">[</span><span class="n">contractToUpgrade_</span><span class="p">],</span>
            <span class="s">"ContractsRegistry: not a proxy contract"</span>
        <span class="p">);</span>

        <span class="n">_proxyUpgrader</span><span class="p">.</span><span class="n">upgrade</span><span class="p">(</span><span class="n">contractToUpgrade_</span><span class="p">,</span> <span class="n">newImplementation_</span><span class="p">,</span> <span class="n">data_</span><span class="p">);</span>

        <span class="k">emit</span> <span class="n">ProxyContractUpgraded</span><span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="n">newImplementation_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">addContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress_</span><span class="p">)</span>
        <span class="k">public</span>
        <span class="k">virtual</span>
        <span class="n">onlyOwner</span>
    <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractAddress_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: zero address is forbidden"</span>
        <span class="p">);</span>

        <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">]</span> <span class="o">=</span> <span class="n">contractAddress_</span><span class="p">;</span>

        <span class="k">emit</span> <span class="n">ContractAdded</span><span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="n">contractAddress_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">addProxyContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress_</span><span class="p">)</span>
        <span class="k">public</span>
        <span class="k">virtual</span>
        <span class="n">onlyOwner</span>
    <span class="p">{</span>
        <span class="n">addProxyContractAndCall</span><span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="n">contractAddress_</span><span class="p">,</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">""</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">addProxyContractAndCall</span><span class="p">(</span>
        <span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">contractAddress_</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data_</span>
    <span class="p">)</span> <span class="k">public</span> <span class="k">virtual</span> <span class="n">onlyOwner</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractAddress_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: zero address is forbidden"</span>
        <span class="p">);</span>

        <span class="kt">address</span> <span class="n">proxyAddr_</span> <span class="o">=</span> <span class="n">_deployProxy</span><span class="p">(</span>
            <span class="n">contractAddress_</span><span class="p">,</span>
            <span class="kt">address</span><span class="p">(</span><span class="n">_proxyUpgrader</span><span class="p">),</span>
            <span class="n">data_</span>
        <span class="p">);</span>

        <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxyAddr_</span><span class="p">;</span>
        <span class="n">_isProxy</span><span class="p">[</span><span class="n">proxyAddr_</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">emit</span> <span class="n">ProxyContractAdded</span><span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="n">proxyAddr_</span><span class="p">,</span> <span class="n">contractAddress_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">justAddProxyContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">,</span> <span class="kt">address</span> <span class="n">contractAddress_</span><span class="p">)</span>
        <span class="k">public</span>
        <span class="k">virtual</span>
        <span class="n">onlyOwner</span>
    <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractAddress_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: zero address is forbidden"</span>
        <span class="p">);</span>

        <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">]</span> <span class="o">=</span> <span class="n">contractAddress_</span><span class="p">;</span>
        <span class="n">_isProxy</span><span class="p">[</span><span class="n">contractAddress_</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">emit</span> <span class="n">ProxyContractAdded</span><span class="p">(</span>
            <span class="n">name_</span><span class="p">,</span>
            <span class="n">contractAddress_</span><span class="p">,</span>
            <span class="n">_proxyUpgrader</span><span class="p">.</span><span class="n">getImplementation</span><span class="p">(</span><span class="n">contractAddress_</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">removeContract</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name_</span><span class="p">)</span> <span class="k">public</span> <span class="k">virtual</span> <span class="n">onlyOwner</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">contractAddress_</span> <span class="o">=</span> <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">];</span>

        <span class="nb">require</span><span class="p">(</span>
            <span class="n">contractAddress_</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s">"ContractsRegistry: this mapping doesn't exist"</span>
        <span class="p">);</span>

        <span class="k">delete</span> <span class="n">_isProxy</span><span class="p">[</span><span class="n">contractAddress_</span><span class="p">];</span>
        <span class="k">delete</span> <span class="n">_contracts</span><span class="p">[</span><span class="n">name_</span><span class="p">];</span>

        <span class="k">emit</span> <span class="n">ContractRemoved</span><span class="p">(</span><span class="n">name_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_deployProxy</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">contractAddress_</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">admin_</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data_</span>
    <span class="p">)</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span>
            <span class="kt">address</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">TransparentUpgradeableProxy</span><span class="p">(</span><span class="n">contractAddress_</span><span class="p">,</span> <span class="n">admin_</span><span class="p">,</span> <span class="n">data_</span><span class="p">)</span>
            <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="dependant-implementation">Dependant Implementation</h3>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IDependant</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">setDependencies</span><span class="p">(</span><span class="kt">address</span> <span class="n">contractsRegistry</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="k">function</span> <span class="n">setInjector</span><span class="p">(</span><span class="kt">address</span> <span class="n">injector</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
 
    <span class="k">function</span> <span class="n">getInjector</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">abstract</span> <span class="k">contract</span> <span class="n">Dependant</span> <span class="k">is</span> <span class="n">IDependant</span> <span class="p">{</span>
    <span class="cm">/**
     * @dev bytes32(uint256(keccak256("eip6224.dependant.slot")) - 1)
     */</span>
    <span class="kt">bytes32</span> <span class="k">private</span> <span class="k">constant</span> <span class="n">_INJECTOR_SLOT</span> <span class="o">=</span>
        <span class="mh">0x3d1f25f1ac447e55e7fec744471c4dab1c6a2b6ffb897825f9ea3d2e8c9be583</span><span class="p">;</span>

    <span class="k">modifier</span> <span class="n">dependant</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_checkInjector</span><span class="p">();</span>
        <span class="n">_</span><span class="p">;</span>
        <span class="n">_setInjector</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">setDependencies</span><span class="p">(</span><span class="kt">address</span> <span class="n">contractsRegistry_</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data_</span><span class="p">)</span> <span class="k">public</span> <span class="k">virtual</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">setInjector</span><span class="p">(</span><span class="kt">address</span> <span class="n">injector_</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_checkInjector</span><span class="p">();</span>
        <span class="n">_setInjector</span><span class="p">(</span><span class="n">injector_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getInjector</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">injector_</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">slot_</span> <span class="o">=</span> <span class="n">_INJECTOR_SLOT</span><span class="p">;</span>

        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">injector_</span> <span class="o">:=</span> <span class="n">sload</span><span class="p">(</span><span class="n">slot_</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_setInjector</span><span class="p">(</span><span class="kt">address</span> <span class="n">injector_</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">slot_</span> <span class="o">=</span> <span class="n">_INJECTOR_SLOT</span><span class="p">;</span>

        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">sstore</span><span class="p">(</span><span class="n">slot_</span><span class="p">,</span> <span class="n">injector_</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_checkInjector</span><span class="p">()</span> <span class="k">internal</span> <span class="k">view</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">injector_</span> <span class="o">=</span> <span class="n">getInjector</span><span class="p">();</span>

        <span class="nb">require</span><span class="p">(</span><span class="n">injector_</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">injector_</span> <span class="o">==</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="s">"Dependant: not an injector"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<p>It is crucial for the owner of <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> to keep their keys in a safe place. The loss/leakage of credentials to the <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> will lead to the application’s point of no return. The <code class="language-plaintext highlighter-rouge">ContractRegistry</code> is a cornerstone of a protocol, access must be granted to the trusted parties only.</p>

<h3 id="contractsregistry-security">ContractsRegistry Security</h3>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">ContractsRegistry</code> does not perform any upgradeability checks between the proxy upgrades. It is the user’s responsibility to make sure that the new implementation is compatible with the old one.</li>
</ul>

<h3 id="dependant-security">Dependant Security</h3>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">Dependant</code> contract MUST set its dependency injector no later than the first call to the <code class="language-plaintext highlighter-rouge">setDependencies</code> function is made. That being said, it is possible to front-run the first dependency injection.</li>
</ul>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
