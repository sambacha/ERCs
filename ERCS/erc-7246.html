<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Encumber - Splitting Ownership &amp; Guarantees | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Encumber - Splitting Ownership &amp; Guarantees | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7246" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7246" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Encumber - Splitting Ownership &amp; Guarantees</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This ERC proposes an extension to the <a href="./eip-20.md">ERC-20</a> token standard by adding Encumber—the ability for an account to grant another account exclusive right to move some portion of their balance. Encumber is a stronger version of <a href="./eip-20.md">ERC-20</a> allowances. While <a href="./eip-20.md">ERC-20</a> approve grants another account the permission to transfer a specified token amount, encumber grants the same permission while ensuring that the tokens will be available when needed.</p>

<h2 id="motivation">Motivation</h2>

<p>This extension adds flexibility to the <a href="./eip-20.md">ERC-20</a> token standard and caters to use cases where token locking is required, but it is preferential to maintain actual ownership of tokens. This interface can also be adapted to other token standards, such as <a href="./eip-721.md">ERC-721</a>, in a straightforward manner</p>

<p>Token holders commonly transfer their tokens to smart contracts which will return the tokens under specific conditions. In some cases, smart contracts do not actually need to hold the tokens, but need to guarantee they will be available if necessary. Since allowances do not provide a strong enough guarantee, the only way to do guarantee token availability presently is to transfer the token to the smart contract. Locking tokens without moving them gives more clear indication of the rights and ownership of the tokens. This allows for airdrops and other ancillary benefits of ownership to reach the true owner. It also adds another layer of safety, where draining a pool of <a href="./eip-20.md">ERC-20</a> tokens can be done in a single transfer, iterating accounts to transfer encumbered tokens would be significantly more prohibitive in gas usage.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<p>A compliant token MUST implement the following interface</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @dev Interface of the ERC-7246 standard.
 */</span>
<span class="k">interface</span> <span class="n">IERC7246</span><span class="p">{</span>
    <span class="cm">/**
     * @dev Emitted when `amount` tokens are encumbered from `owner` to `taker`.
     */</span>
    <span class="k">event</span> <span class="n">Encumber</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Emitted when the encumbrance of a `taker` to an `owner` is reduced by `amount`.
     */</span>
    <span class="k">event</span> <span class="n">Release</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Returns the total amount of tokens owned by `owner` that are currently encumbered.
     * MUST never exceed `balanceOf(owner)`
     *
     * Any function which would reduce balanceOf(owner) below encumberedBalanceOf(owner) MUST revert
     */</span>
    <span class="k">function</span> <span class="n">encumberedBalanceOf</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Returns the number of tokens that `owner` has encumbered to `taker`.
     *
     * This value increases when {encumber} or {encumberFrom} are called by the `owner` or by another permitted account.
     * This value decreases when {release} and {transferFrom} are called by `taker`.
     */</span>
    <span class="k">function</span> <span class="n">encumbrances</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">taker</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Increases the amount of tokens that the caller has encumbered to `taker` by `amount`.
     * Grants to `taker` a guaranteed right to transfer `amount` from the caller's balance by using `transferFrom`.
     *
     * MUST revert if caller does not have `amount` tokens available
     * (e.g. if `balanceOf(caller) - encumbrances(caller) &lt; amount`).
     *
     * Emits an {Encumber} event.
     */</span>
    <span class="k">function</span> <span class="n">encumber</span><span class="p">(</span><span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Increases the amount of tokens that `owner` has encumbered to `taker` by `amount`.
     * Grants to `taker` a guaranteed right to transfer `amount` from `owner` using transferFrom
     *
     * The function SHOULD revert unless the owner account has deliberately authorized the sender of the message via some mechanism.
     *
     * MUST revert if `owner` does not have `amount` tokens available
     * (e.g. if `balanceOf(owner) - encumbrances(owner) &lt; amount`).
     *
     * Emits an {Encumber} event.
     */</span>
    <span class="k">function</span> <span class="n">encumberFrom</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Reduces amount of tokens encumbered from `owner` to caller by `amount`
     *
     * Emits a {Release} event.
     */</span>
    <span class="k">function</span> <span class="n">release</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>


    <span class="cm">/**
     * @dev Convenience function for reading the unencumbered balance of an address.
     * Trivially implemented as `balanceOf(owner) - encumberedBalanceOf(owner)`
     */</span>
    <span class="k">function</span> <span class="n">availableBalanceOf</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>
<p>The specification was designed to complement and mirror the ERC-20 specification to ease adoption and understanding. The specification is intentionally minimally proscriptive of this joining, where the only true requirement is that an owner cannot transfer encumbered tokens. However, the example implementation includes some decisions about where to connect with ERC-20 functions worth noting. It was designed for minimal invasiveness of standard ERC-20 definitions.
    - The example has a dependency on <code class="language-plaintext highlighter-rouge">approve</code> to facilitate <code class="language-plaintext highlighter-rouge">encumberFrom</code>. This proposal allows for an implementer to define another mechanism, such as an <code class="language-plaintext highlighter-rouge">approveEncumber</code> which would mirror ERC-20 allowances, if desired.
    - <code class="language-plaintext highlighter-rouge">transferFrom(src, dst, amount)</code> is written to first reduce the <code class="language-plaintext highlighter-rouge">encumbrances(src, amount)</code>, and then subsequently spend from <code class="language-plaintext highlighter-rouge">allowance(src, msg.sender)</code>. Alternatively, <code class="language-plaintext highlighter-rouge">transferFrom</code> could be implemented to spend from allowance simultaneously to spending encumbrances. This would require <code class="language-plaintext highlighter-rouge">approve</code> to check that the approved balance does not decrease beneath the amount required by encumbered balances, and also make creating the approval a prerequisite to calling <code class="language-plaintext highlighter-rouge">encumber</code>.</p>

<p>It is possible to stretch the Encumber interface to cover ERC-721 tokens by using the <code class="language-plaintext highlighter-rouge">tokenId</code> in place of <code class="language-plaintext highlighter-rouge">amount</code> param since they are both <code class="language-plaintext highlighter-rouge">uint</code>. The interface opts for clarity with the most likely use case (ERC-20), even if it is compatible with other formats.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This EIP is backwards compatible with the existing <a href="./eip-20.md">ERC-20</a> standard. Implementations must add the functionality to block transfer of tokens that are encumbered to another account.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<p>This can be implemented as an extension of any base <a href="./eip-20.md">ERC-20</a> contract by modifying the transfer function to block the transfer of encumbered tokens and to release encumbrances when spent via transferFrom.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// An erc-20 token that implements the encumber interface by blocking transfers.
</span>
<span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="n">ERC20</span><span class="p">}</span> <span class="n">from</span> <span class="s">"../lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="n">IERC7246</span> <span class="p">}</span> <span class="n">from</span> <span class="s">"./IERC7246.sol"</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">EncumberableERC20</span> <span class="k">is</span> <span class="n">ERC20</span><span class="p">,</span> <span class="n">IERC7246</span> <span class="p">{</span>
    <span class="c1">// Owner -&gt; Taker -&gt; Amount that can be taken
</span>    <span class="k">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="k">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">))</span> <span class="k">public</span> <span class="n">encumbrances</span><span class="p">;</span>

    <span class="c1">// The encumbered balance of the token owner. encumberedBalance must not exceed balanceOf for a user
</span>    <span class="c1">// Note this means rebasing tokens pose a risk of diminishing and violating this prototocol
</span>    <span class="k">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="k">public</span> <span class="n">encumberedBalanceOf</span><span class="p">;</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">minter</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol</span><span class="p">)</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">minter</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">minter</span><span class="p">,</span> <span class="s">"only minter"</span><span class="p">);</span>
        <span class="n">_mint</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">encumber</span><span class="p">(</span><span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_encumber</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">taker</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">encumberFrom</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">allowance</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">);</span>
       <span class="n">_encumber</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">taker</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">release</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_release</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// If bringing balance and encumbrances closer to equal, must check
</span>    <span class="k">function</span> <span class="n">availableBalanceOf</span><span class="p">(</span><span class="kt">address</span> <span class="n">a</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">encumberedBalanceOf</span><span class="p">[</span><span class="n">a</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_encumber</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">availableBalanceOf</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">,</span> <span class="s">"insufficient balance"</span><span class="p">);</span>
        <span class="n">encumbrances</span><span class="p">[</span><span class="n">owner</span><span class="p">][</span><span class="n">taker</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
        <span class="n">encumberedBalanceOf</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
        <span class="k">emit</span> <span class="n">Encumber</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">taker</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_release</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">encumbrances</span><span class="p">[</span><span class="n">owner</span><span class="p">][</span><span class="n">taker</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">amount</span> <span class="o">=</span> <span class="n">encumbrances</span><span class="p">[</span><span class="n">owner</span><span class="p">][</span><span class="n">taker</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">encumbrances</span><span class="p">[</span><span class="n">owner</span><span class="p">][</span><span class="n">taker</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
        <span class="n">encumberedBalanceOf</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
        <span class="k">emit</span> <span class="n">Release</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">taker</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">override</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// check but dont spend encumbrance
</span>        <span class="nb">require</span><span class="p">(</span><span class="n">availableBalanceOf</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">,</span> <span class="s">"insufficient balance"</span><span class="p">);</span>
        <span class="n">_transfer</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">transferFrom</span><span class="p">(</span><span class="kt">address</span> <span class="n">src</span><span class="p">,</span> <span class="kt">address</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">override</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">encumberedToTaker</span> <span class="o">=</span> <span class="n">encumbrances</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
        <span class="kt">bool</span> <span class="n">exceedsEncumbrance</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">encumberedToTaker</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exceedsEncumbrance</span><span class="p">)</span>  <span class="p">{</span>
            <span class="kt">uint</span> <span class="n">excessAmount</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">encumberedToTaker</span><span class="p">;</span>

            <span class="c1">// check that enough enencumbered tokens exist to spend from allowance
</span>           <span class="nb">require</span><span class="p">(</span><span class="n">availableBalanceOf</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">excessAmount</span><span class="p">,</span> <span class="s">"insufficient balance"</span><span class="p">);</span>

           <span class="c1">// Exceeds Encumbrance , so spend all of it
</span>            <span class="n">_spendEncumbrance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">encumberedToTaker</span><span class="p">);</span>

            <span class="n">_spendAllowance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">excessAmount</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">_spendEncumbrance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">_transfer</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_spendEncumbrance</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">taker</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">currentEncumbrance</span> <span class="o">=</span> <span class="n">encumbrances</span><span class="p">[</span><span class="n">owner</span><span class="p">][</span><span class="n">taker</span><span class="p">];</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">currentEncumbrance</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">,</span> <span class="s">"insufficient encumbrance"</span><span class="p">);</span>
        <span class="kt">uint</span> <span class="n">newEncumbrance</span> <span class="o">=</span> <span class="n">currentEncumbrance</span> <span class="o">-</span> <span class="n">amount</span><span class="p">;</span>
        <span class="n">encumbrances</span><span class="p">[</span><span class="n">owner</span><span class="p">][</span><span class="n">taker</span><span class="p">]</span> <span class="o">=</span> <span class="n">newEncumbrance</span><span class="p">;</span>
        <span class="n">encumberedBalanceOf</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<p>Parties relying on <code class="language-plaintext highlighter-rouge">balanceOf</code> to determine the amount of tokens available for transfer should instead rely on <code class="language-plaintext highlighter-rouge">balanceOf(account) - encumberedBalance(account)</code>, or, if implemented, <code class="language-plaintext highlighter-rouge">availableBalanceOf(account)</code>.</p>

<p>The property that encumbered balances are always backed by a token balance can be accomplished in a straightforward manner by altering <code class="language-plaintext highlighter-rouge">transfer</code> and <code class="language-plaintext highlighter-rouge">transferFrom</code> to block . If there are other functions that can alter user balances, such as a rebasing token or an admin burn function, additional guards must be added by the implementer to likewise ensure those functions prevent reducing <code class="language-plaintext highlighter-rouge">balanceOf(account)</code> below <code class="language-plaintext highlighter-rouge">encumberedBalanceOf(account)</code> for any given account.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
