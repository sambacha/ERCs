<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Flash Loans | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Flash Loans | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7399" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7399" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Flash Loans</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>A flash loan is a loan between lender and borrower smart contracts that must be
repaid, plus an optional fee, before the end of the transaction. This ERC
specifies interfaces for lenders to accept flash loan requests, and for
borrowers to take temporary control of the transaction within the lender
execution. The process for the safe execution of flash loans is also specified.</p>

<h2 id="motivation">Motivation</h2>

<p>The flash loan ecosystem is fragmented, and lacks a common interface. Without
standardization, the work required to integrate with it is expected to grow.</p>

<p>Some of the high level differences in the approaches across the protocols
include:</p>

<ul>
  <li>Syntax of the call initiating the flash loan.</li>
  <li>Possibility of the loan receiver and the callback receiver being different
addresses.</li>
  <li>Repayment approaches at the end of the transaction, where some pull the
principal plus the fee from the loan receiver, and others where the loan
receiver needs to manually return the principal and the fee to the lender.</li>
  <li>Some lenders enable to flash mint (create tokens on demand) any amount of
their native asset without charging a fee, effectively allowing flash loans
bounded by computational constraints instead of asset ownership constraints.</li>
</ul>

<p>This ERC aims to consolidate all flash lenders into a common standard of maximum
flexibility, so that borrowers can easily choose flash lenders without changing
their code.</p>

<h2 id="specification">Specification</h2>

<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this
document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<p>Under the <a href="./eip-7399.md">ERC-7399</a> standard a flash loan is a loan of an
<code class="language-plaintext highlighter-rouge">amount</code> of an <a href="./eip-20.md">ERC-20</a> <code class="language-plaintext highlighter-rouge">asset</code> from a <code class="language-plaintext highlighter-rouge">lender</code>. This loan can
remain open for the span of a single <code class="language-plaintext highlighter-rouge">flash</code> call in the <code class="language-plaintext highlighter-rouge">lender</code>.</p>

<p>This <code class="language-plaintext highlighter-rouge">amount</code> plus a <code class="language-plaintext highlighter-rouge">fee</code> defined by the <code class="language-plaintext highlighter-rouge">lender</code> in the same <code class="language-plaintext highlighter-rouge">asset</code> must be
repaid before the end of <code class="language-plaintext highlighter-rouge">flash</code> call at a <code class="language-plaintext highlighter-rouge">repayment receiver</code> address defined
by the <code class="language-plaintext highlighter-rouge">lender</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">flash</code> function is called by the <code class="language-plaintext highlighter-rouge">initiator</code>, who defines the
<code class="language-plaintext highlighter-rouge">loan receiver</code>, the <code class="language-plaintext highlighter-rouge">callback receiver</code>, the <code class="language-plaintext highlighter-rouge">callback function</code>, the <code class="language-plaintext highlighter-rouge">asset</code>
and the <code class="language-plaintext highlighter-rouge">amount</code>.</p>

<p>When the <code class="language-plaintext highlighter-rouge">initiator</code> calls <code class="language-plaintext highlighter-rouge">flash</code> in a <code class="language-plaintext highlighter-rouge">lender</code>. The <code class="language-plaintext highlighter-rouge">lender</code> will then
transfer the <code class="language-plaintext highlighter-rouge">amount</code> of <code class="language-plaintext highlighter-rouge">asset</code> to the <code class="language-plaintext highlighter-rouge">loan receiver</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">lender</code>, after transferring <code class="language-plaintext highlighter-rouge">amount</code> of <code class="language-plaintext highlighter-rouge">asset</code> to the <code class="language-plaintext highlighter-rouge">loan receiver</code>,
will execute the <code class="language-plaintext highlighter-rouge">callback function</code> on the <code class="language-plaintext highlighter-rouge">callback receiver</code>. The <code class="language-plaintext highlighter-rouge">lender</code>
will include in this <code class="language-plaintext highlighter-rouge">callback function</code> call a number of parameters related to
the loan as defined in this standard.</p>

<p>The <code class="language-plaintext highlighter-rouge">amount</code> and <code class="language-plaintext highlighter-rouge">fee</code> need to be transferred to a <code class="language-plaintext highlighter-rouge">repayment receiver</code> before
the end of the <code class="language-plaintext highlighter-rouge">flash</code> call. The <code class="language-plaintext highlighter-rouge">fee</code> can be set to zero <code class="language-plaintext highlighter-rouge">asset</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">callback function</code> can return any arbitrary data which will be received by
the <code class="language-plaintext highlighter-rouge">initiator</code> as the return value of the <code class="language-plaintext highlighter-rouge">flash</code> call.</p>

<h3 id="lender-specification">Lender Specification</h3>

<p>A <code class="language-plaintext highlighter-rouge">lender</code> MUST implement the <a href="./eip-7399.md">ERC-7399</a> interface.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: CC0-1.0
</span><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">&gt;=</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">4</span> <span class="o">&lt;</span><span class="mf">0.9</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="n">IERC20</span> <span class="p">}</span> <span class="n">from</span> <span class="s">"./IERC20.sol"</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IERC7399</span> <span class="p">{</span>
    <span class="c1">/// @dev The amount of currency available to be lent.
</span>    <span class="c1">/// @param asset The loan currency.
</span>    <span class="c1">/// @return The amount of `asset` that can be borrowed.
</span>    <span class="k">function</span> <span class="n">maxFlashLoan</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">asset</span>
    <span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev The fee to be charged for a given loan. Returns type(uint256).max if the loan is not possible.
</span>    <span class="c1">/// @param asset The loan currency.
</span>    <span class="c1">/// @param amount The amount of assets lent.
</span>    <span class="c1">/// @return The amount of `asset` to be charged for the loan, on top of the returned principal.
</span>    <span class="k">function</span> <span class="n">flashFee</span><span class="p">(</span>
        <span class="n">IERC20</span> <span class="n">asset</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">amount</span>
    <span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="c1">/// @dev Initiate a flash loan.
</span>    <span class="c1">/// @param loanReceiver The address receiving the flash loan
</span>    <span class="c1">/// @param asset The asset to be loaned
</span>    <span class="c1">/// @param amount The amount to loaned
</span>    <span class="c1">/// @param data The ABI encoded user data
</span>    <span class="c1">/// @param callback The address and signature of the callback function
</span>    <span class="c1">/// @return result ABI encoded result of the callback
</span>    <span class="k">function</span> <span class="n">flash</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">loanReceiver</span><span class="p">,</span>
        <span class="n">ERC20</span> <span class="n">asset</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">data</span><span class="p">,</span>
        <span class="c1">/// @dev callback. This is a combination of the callback receiver address, and the signature of callback
</span>        <span class="c1">/// function. It is encoded packed as 20 bytes + 4 bytes.
</span>        <span class="c1">/// @dev the return of the callback function is not encoded in the parameter, but must be `returns (bytes
</span>        <span class="c1">/// memory)` for compliance with the standard.
</span>        <span class="c1">/// @param initiator The address that called this function
</span>        <span class="c1">/// @param paymentReceiver The address that needs to receive the amount plus fee at the end of the callback
</span>        <span class="c1">/// @param asset The asset to be loaned
</span>        <span class="c1">/// @param amount The amount to loaned
</span>        <span class="c1">/// @param fee The fee to be paid
</span>        <span class="c1">/// @param data The ABI encoded data to be passed to the callback
</span>        <span class="c1">/// @return result ABI encoded result of the callback
</span>        <span class="k">function</span><span class="p">(</span><span class="kt">address</span><span class="p">,</span> <span class="kt">address</span><span class="p">,</span> <span class="n">IERC20</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="n">callback</span>
    <span class="p">)</span>
        <span class="k">external</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">flashFee</code> function MUST return the fee charged for a loan of <code class="language-plaintext highlighter-rouge">amount</code>
<code class="language-plaintext highlighter-rouge">asset</code>. If the asset is not supported <code class="language-plaintext highlighter-rouge">flashFee</code> MUST revert. If the lender
doesn’t have enough liquidity to loan <code class="language-plaintext highlighter-rouge">amount</code> the fee returned MUST be
<code class="language-plaintext highlighter-rouge">type(uint256).max</code>. If an <code class="language-plaintext highlighter-rouge">asset</code>is supported but the available liquidity for
it is exactly zero, the fee returned still MUST be <code class="language-plaintext highlighter-rouge">type(uint256).max</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">flash</code> function MUST execute the callback passed on as an argument.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">result</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">_fee</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">flash</code> function MUST transfer <code class="language-plaintext highlighter-rouge">amount</code> of <code class="language-plaintext highlighter-rouge">asset</code> to <code class="language-plaintext highlighter-rouge">loan receiver</code> before
executing the callback.</p>

<p>The <code class="language-plaintext highlighter-rouge">flash</code> function MUST include <code class="language-plaintext highlighter-rouge">msg.sender</code> as the <code class="language-plaintext highlighter-rouge">initiator</code> in the
callback.</p>

<p>The <code class="language-plaintext highlighter-rouge">flash</code> function MUST NOT modify the <code class="language-plaintext highlighter-rouge">asset</code>, <code class="language-plaintext highlighter-rouge">amount</code> and <code class="language-plaintext highlighter-rouge">data</code> parameter
received, and MUST pass them on to the callback.</p>

<p>The <code class="language-plaintext highlighter-rouge">flash</code> function MUST include a <code class="language-plaintext highlighter-rouge">fee</code> argument in the callback with the fee
to pay for the loan on top of the principal, ensuring that <code class="language-plaintext highlighter-rouge">fee == flashFee(asset, amount)</code>.</p>

<p>Before the end of the callback, the <code class="language-plaintext highlighter-rouge">asset</code> balance of <code class="language-plaintext highlighter-rouge">payment receiver</code> MUST
have increased by <code class="language-plaintext highlighter-rouge">amount + fee</code> from the amount at the beginning of the
callback, or revert if this is not true.</p>

<p>The return of the <code class="language-plaintext highlighter-rouge">flash</code> function MUST be the same as the return from the
callback.</p>

<h3 id="receiver-specification">Receiver Specification</h3>

<p>A <code class="language-plaintext highlighter-rouge">callback receiver</code> of flash loans MUST implement one or more external
functions with the following arguments and return value:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// @dev This function can have any name and be overloaded.
/// @param initiator The address that called this function
/// @param paymentReceiver The address that needs to receive the amount plus fee at the end of the callback
/// @param asset The asset to be loaned
/// @param amount The amount to loaned
/// @param fee The fee to be paid
/// @param data The ABI encoded data to be passed to the callback
/// @return result ABI encoded result of the callback
</span><span class="k">function</span><span class="p">(</span><span class="kt">address</span><span class="p">,</span> <span class="kt">address</span><span class="p">,</span> <span class="n">IERC20</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="n">callback</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>

<p>The interfaces described in this ERC have been chosen as to cover the known
flash lending use cases, while allowing for safe and gas efficient
implementations.</p>

<p><code class="language-plaintext highlighter-rouge">flashFee</code> reverts on unsupported assets, because returning a numerical value
would be incorrect.</p>

<p><code class="language-plaintext highlighter-rouge">flashFee</code> returns a value that is consistent with an impossible loan when the
<code class="language-plaintext highlighter-rouge">lender</code> doesn’t have enough liquidity to serve the loan.</p>

<p><code class="language-plaintext highlighter-rouge">flash</code> has been chosen as a function name as a verb which is descriptive
enough, unlikely to clash with other functions in the <code class="language-plaintext highlighter-rouge">lender</code>, and including
both the use cases in which the assets lent are held or minted by the <code class="language-plaintext highlighter-rouge">lender</code>.</p>

<p>Existing flash lenders all provide flash loans of several asset types from the
same contract. Providing a <code class="language-plaintext highlighter-rouge">asset</code> parameter in both the <code class="language-plaintext highlighter-rouge">flash</code> and callback
functions matches closely the observed functionality.</p>

<p>A <code class="language-plaintext highlighter-rouge">bytes calldata data</code> parameter is included for the <code class="language-plaintext highlighter-rouge">initiator</code> to pass
arbitrary information to the <code class="language-plaintext highlighter-rouge">receiver</code>. The <code class="language-plaintext highlighter-rouge">receiver</code> can pass arbitrary
information back to the <code class="language-plaintext highlighter-rouge">initiator</code> using the <code class="language-plaintext highlighter-rouge">bytes memory</code> return value.</p>

<p>A <code class="language-plaintext highlighter-rouge">initiator</code> will often be required in the callback function, which the
<code class="language-plaintext highlighter-rouge">lender</code> knows as <code class="language-plaintext highlighter-rouge">msg.sender</code>. An alternative implementation which would embed
the <code class="language-plaintext highlighter-rouge">initiator</code> in the <code class="language-plaintext highlighter-rouge">data</code> parameter by the caller would require an
additional mechanism for the receiver to verify its accuracy, and is not
advisable.</p>

<p>A <code class="language-plaintext highlighter-rouge">loan receiver</code> is taken as a parameter to allow flexibility on the
implementation of separate loan initiators, loan receivers, and callback
receivers. This parameter is not passed on to the <code class="language-plaintext highlighter-rouge">callback receiver</code> on the
grounds that it will be often the same as <code class="language-plaintext highlighter-rouge">callback receiver</code> and when not, it
can be encoded in the <code class="language-plaintext highlighter-rouge">data</code> by the <code class="language-plaintext highlighter-rouge">initiator</code>.</p>

<p>A <code class="language-plaintext highlighter-rouge">payment receiver</code> allows for the same flexibility on repayments as in
borrows. Control flow and asset flow are independent.</p>

<p>The <code class="language-plaintext highlighter-rouge">amount</code> will be required in the callback function, which the <code class="language-plaintext highlighter-rouge">lender</code> took
as a parameter. An alternative implementation which would embed the <code class="language-plaintext highlighter-rouge">amount</code> in
the <code class="language-plaintext highlighter-rouge">data</code> parameter by the caller would require an additional mechanism for the
receiver to verify its accuracy, and is not advisable.</p>

<p>A <code class="language-plaintext highlighter-rouge">fee</code> will often be calculated in the callback function, which the callback
receiver must be aware of for repayment. Passing the <code class="language-plaintext highlighter-rouge">fee</code> as a parameter
instead of appended to <code class="language-plaintext highlighter-rouge">data</code> is simple and effective.</p>

<p>Arbitrary callback functions on callback receivers enables implementing
different behaviors to flash loans on callback receivers without the need for
encoding a function router using the <code class="language-plaintext highlighter-rouge">data</code> argument. A function call type is 24
bytes of which the first 20 bytes are the target address and the last 4 bytes
are the function signature.</p>

<p>The <code class="language-plaintext highlighter-rouge">amount + fee</code> are pushed to the <code class="language-plaintext highlighter-rouge">payment receiver</code> to allow for the
segregation of asset and control flows. While a “pull” architecture is more
prevalent, “push” architectures are also common. For those cases where the
<code class="language-plaintext highlighter-rouge">lender</code> can’t implement a “push” architecture, a simple wrapper contract can
offer an ERC-7399 external interface, while using liquidity from the <code class="language-plaintext highlighter-rouge">lender</code>
using a “pull” architecture.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This EIP is a successor of <a href="./eip-3156.md">ERC-3156</a>. While not directly
backwards compatible, a wrapper contract offering this proposal’s external
interface with liquidity obtained from an ERC-3156 flash <code class="language-plaintext highlighter-rouge">lender</code> is trivial to
implement.</p>

<h2 id="security-considerations">Security Considerations</h2>

<h3 id="verification-of-callback-arguments">Verification of callback arguments</h3>

<p>The arguments of the flash loan callbacks are expected to reflect the conditions
of the flash loan, but cannot be trusted unconditionally. They can be divided in
two groups, that require different checks before they can be trusted to be
genuine.</p>

<ol>
  <li>
    <p>No arguments can be assumed to be genuine without some kind of verification.
<code class="language-plaintext highlighter-rouge">initiator</code>, <code class="language-plaintext highlighter-rouge">asset</code> and <code class="language-plaintext highlighter-rouge">amount</code> refer to a past transaction that might not
have happened if the caller of the callback decides to lie. <code class="language-plaintext highlighter-rouge">fee</code> might be
false or calculated incorrectly. <code class="language-plaintext highlighter-rouge">data</code> might have been manipulated by the
caller.</p>
  </li>
  <li>
    <p>To trust that the value of <code class="language-plaintext highlighter-rouge">initiator</code>, <code class="language-plaintext highlighter-rouge">asset</code>, <code class="language-plaintext highlighter-rouge">amount</code> and <code class="language-plaintext highlighter-rouge">fee</code> are
genuine a reasonable pattern is to verify that the callback caller is in a
whitelist of verified flash lenders. Since often the caller of <code class="language-plaintext highlighter-rouge">flash</code> will
also be receiving the callback this will be trivial. In all other cases flash
lenders will need to be approved if the arguments in the callback are to be
trusted.</p>
  </li>
  <li>
    <p>To trust that the value of <code class="language-plaintext highlighter-rouge">data</code> is genuine, in addition to the check in
point 1, it is recommended to verify that the <code class="language-plaintext highlighter-rouge">initiator</code> belongs to a group
of trusted addresses. Trusting the <code class="language-plaintext highlighter-rouge">lender</code> and the <code class="language-plaintext highlighter-rouge">initiator</code> is enough to
trust that the contents of <code class="language-plaintext highlighter-rouge">data</code> are genuine.</p>
  </li>
</ol>

<h3 id="flash-lending-security-considerations">Flash lending security considerations</h3>

<h4 id="automatic-approvals">Automatic approvals</h4>

<p>Any <code class="language-plaintext highlighter-rouge">receiver</code> that repays the <code class="language-plaintext highlighter-rouge">amount</code> and <code class="language-plaintext highlighter-rouge">fee</code> received as arguments needs to
include in the callback a mechanism to verify that the initiator and <code class="language-plaintext highlighter-rouge">lender</code>
are trusted.</p>

<p>The, the callback receiver can implement permissioned functions that set state
variables indicating that a flash loan has been initiated and what to expect as
<code class="language-plaintext highlighter-rouge">amount</code> and <code class="language-plaintext highlighter-rouge">fee</code>.</p>

<p>Alternatively, the callback receiver can verify that <code class="language-plaintext highlighter-rouge">amount</code> was received by
the <code class="language-plaintext highlighter-rouge">loanReceiver</code> and use its own heuristics to determine if a <code class="language-plaintext highlighter-rouge">fee</code> is fair
and the loan repaid, or the transaction reverted.</p>

<h3 id="flash-minting-external-security-considerations">Flash minting external security considerations</h3>

<p>The typical quantum of assets involved in flash mint transactions will give rise
to new innovative attack vectors.</p>

<h4 id="spot-oracle-manipulation">Spot Oracle Manipulation</h4>

<p>The supply of a flash-mintable asset can be easily manipulated, so oracles that
take the supply of the flash-mintable asset into account must either discount
amounts that were flash-minted, produce data that is averaged over time, or find
some other solution to the varying supply.</p>

<h4 id="arithmetic-overflow-and-underflow">Arithmetic Overflow and Underflow</h4>

<p>If the flash mint provider does not place any limits on the amount of flash
mintable assets in a transaction, then anyone can flash mint $2^256-1$ amount of
assets.</p>

<p>The protocols on the receiving end of the flash mints will need to ensure their
contracts can handle this, either by using a compiler that embeds overflow
protection in the smart contract bytecode, or by setting explicit checks.</p>

<h3 id="flash-minting-internal-security-considerations">Flash minting internal security considerations</h3>

<p>The coupling of flash minting with business specific features in the same
platform can easily lead to unintended consequences.</p>

<h4 id="treasury-draining">Treasury Draining</h4>

<p>Assume a smart contract that flash lends its native asset. The same smart
contract borrows from a third party when users burn the native asset. This
pattern would be used to aggregate in the smart contract the collateralized debt
of several users into a single account in the third party. The flash mint could
be used to cause the <code class="language-plaintext highlighter-rouge">lender</code> to borrow to its limit, and then pushing interest
rates in the underlying <code class="language-plaintext highlighter-rouge">lender</code>, liquidate the flash <code class="language-plaintext highlighter-rouge">lender</code>:</p>

<ol>
  <li>Flash mint from <code class="language-plaintext highlighter-rouge">lender</code> a very large amount of FOO.</li>
  <li>Redeem FOO for BAR, causing <code class="language-plaintext highlighter-rouge">lender</code> to borrow from <code class="language-plaintext highlighter-rouge">underwriter</code> all the way
to its borrowing limit.</li>
  <li>Trigger a debt rate increase in <code class="language-plaintext highlighter-rouge">underwriter</code>, making <code class="language-plaintext highlighter-rouge">lender</code>
undercollateralized.</li>
  <li>Liquidate the <code class="language-plaintext highlighter-rouge">lender</code> for profit.</li>
</ol>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0-1.0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
