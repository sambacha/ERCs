<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Prevent ticket touting | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Prevent ticket touting | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7439" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7439" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Prevent ticket touting</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This standard is an extension of  <a href="./eip-721.md">ERC-721</a> and defines standard functions outlining a scope for ticketing agents or event organizers to take preventative actions to stop audiences being exploited in the ticket scalping market and allow customers to resell their tickets via authorized ticket resellers.</p>

<h2 id="motivation">Motivation</h2>

<p>Industrial-scale ticket touting has been a longstanding issue, with its associated fraud and criminal problems leading to unfortunate incidents and waste of social resources. It is also hugely damaging to artists at all levels of their careers and to related businesses across the board. Although the governments of various countries have begun to legislate to restrict the behavior of scalpers, the effect is limited. They still sold tickets for events at which resale was banned or did not yet own then obtained substantial illegal profits from speculative selling. We consulted many opinions to provide a consumer-friendly resale interface, enabling buyers to resell or reallocate a ticket at the price they initially paid or less is the efficient way to rip off “secondary ticketing”.that enables ticketing agents to utilize</p>

<p>The typical ticket may be a “piece of paper” or even a voucher in your email inbox, making it easy to counterfeit or circulate. To restrict the transferability of these tickets, we have designed a mechanism that prohibits ticket transfers for all parties, including the ticket owner, except for specific accounts that are authorized to transfer tickets. The specific accounts may be ticketing agents, managers, promoters and authorized resale platforms. Therefore, the ticket touts are unable to transfer tickets as they wish. Furthermore, to enhance functionality, we have implemented a token info schema to each ticket,  allowing only authorized accounts(excluding the owner) to modify these records.</p>

<p>This standard defines a framework that enables ticketing agents to utilize <a href="./eip-721.md">ERC-721</a> tokens as event tickets and restricts token transferability to prevent ticket touting. By implementing this standard, we aim to protect customers from scams and fraudulent activities.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<h3 id="interface">Interface</h3>

<p>The interface and structure referenced here are as follows:</p>

<ul>
  <li>TokenInfo
    <ul>
      <li><code class="language-plaintext highlighter-rouge">signature</code>: Recommend that the adapter self-defines what to sign using the user’s private key or agent’s private key to prove the token validity.</li>
      <li><code class="language-plaintext highlighter-rouge">status</code>: Represent token current status.</li>
      <li><code class="language-plaintext highlighter-rouge">expireTime</code>: Recommend set to the event due time.</li>
    </ul>
  </li>
  <li>TokenStatus
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Sold</code>: When a token is sold, it MUST change to <code class="language-plaintext highlighter-rouge">Sold</code>. The token is valid in this status.</li>
      <li><code class="language-plaintext highlighter-rouge">Resell</code>: When a token is in the secondary market, it MUST be changed to Resell. The token is valid in this status.</li>
      <li><code class="language-plaintext highlighter-rouge">Void</code>: When the token owner engages in an illegal transaction, the token status MUST be set to Void, and the token is invalid in this status.</li>
      <li><code class="language-plaintext highlighter-rouge">Redeemed</code>:  When the token is used, it is RECOMMENDED to change the token status to <code class="language-plaintext highlighter-rouge">Redeemed</code>.</li>
    </ul>
  </li>
</ul>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// @title IERC7439 Prevent Ticket Touting Interface
</span><span class="k">interface</span> <span class="n">IERC7439</span> <span class="cm">/* is ERC721 */</span> <span class="p">{</span>
    <span class="c1">/// @dev TokenStatus represent the token current status, only specific role can change status
</span>    <span class="k">enum</span> <span class="n">TokenStatus</span> <span class="p">{</span>
        <span class="n">Sold</span><span class="p">,</span>    <span class="c1">// 0
</span>        <span class="n">Resell</span><span class="p">,</span>  <span class="c1">// 1
</span>        <span class="n">Void</span><span class="p">,</span>    <span class="c1">// 2
</span>        <span class="n">Redeemed</span> <span class="c1">// 3
</span>    <span class="p">}</span>

    <span class="c1">/// @param signature Data signed by user's private key or agent's private key
</span>    <span class="c1">/// @param tokenStatus Token status changing to
</span>    <span class="c1">/// @param expireTime Event due time
</span>    <span class="k">struct</span> <span class="n">TokenInfo</span> <span class="p">{</span>
        <span class="kt">bytes</span> <span class="n">signature</span><span class="p">;</span>
        <span class="n">TokenStatus</span> <span class="n">tokenStatus</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">expireTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// @notice Used to notify listeners that the token with the specified ID has been changed status
</span>    <span class="c1">/// @param tokenId The token has been changed status
</span>    <span class="c1">/// @param tokenStatus Token status has been changed to
</span>    <span class="c1">/// @param signature Data signed by user's private key or agent's private key
</span>    <span class="k">event</span> <span class="n">TokenStatusChanged</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="k">indexed</span> <span class="n">tokenId</span><span class="p">,</span>
        <span class="n">TokenStatus</span> <span class="k">indexed</span> <span class="n">tokenStatus</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="n">signature</span>
    <span class="p">);</span>

    <span class="c1">/// @notice Used to mint token with token status
</span>    <span class="c1">/// @dev MUST emit the `TokenStatusChanged` event if the token status is changed.
</span>    <span class="c1">/// @param to The receiptent of token
</span>    <span class="c1">/// @param signature Data signed by user's private key or agent's private key
</span>    <span class="k">function</span> <span class="n">safeMint</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="c1">/// @notice Used to change token status and can only be invoked by a specific role
</span>    <span class="c1">/// @dev MUST emit the `TokenStatusChanged` event if the token status is changed.
</span>    <span class="c1">/// @param tokenId The token need to change status
</span>    <span class="c1">/// @param signature Data signed by user's private key or agent's private key
</span>    <span class="c1">/// @param tokenStatus Token status changing to
</span>    <span class="c1">/// @param newExpireTime New event due time
</span>    <span class="k">function</span> <span class="n">changeState</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">tokenId</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span><span class="p">,</span>
        <span class="n">TokenStatus</span> <span class="n">tokenStatus</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">newExpireTime</span>
    <span class="p">)</span> <span class="k">external</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">supportsInterface</code> method MUST return <code class="language-plaintext highlighter-rouge">true</code> when called with <code class="language-plaintext highlighter-rouge">0x15fbb306</code>.</p>

<h2 id="rationale">Rationale</h2>

<p>Designing the proposal, we considered the following questions:</p>
<ol>
  <li>What is the most crucial for ticketing agents, performers, and audiences?
    <ul>
      <li>
        <p>For ticketing companies, selling out all tickets is crucial. Sometimes, to create a vibrant sales environment, ticketing companies may even collaborate with scalpers. This practice can be detrimental to both the audience and performers. To prevent such situations, there must be an open and transparent primary sales channel, as well as a fair secondary sales mechanism. In the <code class="language-plaintext highlighter-rouge">safeMint</code> function, which is a public function, we hope that everyone can mint tickets transparently at a listed price by themselves. At that time, <code class="language-plaintext highlighter-rouge">TokenInfo</code> adds a signature that only the buyer account or agent can resolve depending on the mechanism, to prove the ticket validity. And the token <code class="language-plaintext highlighter-rouge">status</code> is <code class="language-plaintext highlighter-rouge">Sold</code>. Despite this, we must also consider the pressures on ticketing companies. They aim to maximize the utility of every valid ticket, meaning selling out each one. In the traditional mechanism, ticketing companies only benefit from the initial sale, implying that they do not enjoy the excess profits from secondary sales. Therefore, we have designed a secondary sales process that is manageable for ticketing companies. In the <code class="language-plaintext highlighter-rouge">_beforeTokenTransfer()</code> function, you can see that it is an accessControl function, and only the <code class="language-plaintext highlighter-rouge">PARTNER_ROLE</code> <code class="language-plaintext highlighter-rouge">mint</code> or <code class="language-plaintext highlighter-rouge">burn</code> situation can transfer the ticket. The <code class="language-plaintext highlighter-rouge">PARTNER_ROLE</code> can be the ticket agency or a legal secondary ticket selling platform, which may be a state supervision or the ticket agency designated platform. To sustain the fair ticketing market, we cannot allow them to transfer tickets themselves, because we can’t distinguish whether the buyer is a scalper.</p>
      </li>
      <li>For performers or event holder, they aren’t willing to see bad news during ticket selling. A smooth ticketing process or no news that may damage their performers’ reputation is what they want. Other than that, what really matters is all the audience true fans who come. Tickets ending up in the hands of scalpers or entering a chaotic secondary market doesn’t really appeal to genuine fans. We believe performers wouldn’t be pleased with such a situation. Through the transparant mechanism, performers or event holder can control the real sales status at all times form cross-comparison of token mint amount and <code class="language-plaintext highlighter-rouge">TokenInfo</code>-<code class="language-plaintext highlighter-rouge">TokenStatus</code>.
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   enum TokenStatus {
       Sold,    // 0
       Resell,  // 1
       Void,    // 2
       Redeemed // 3
   }
</code></pre></div>        </div>
      </li>
      <li>For audiences, the only thing they need is to get a valid ticket. In the traditional mechanism,fans encounter many obstacles. At hot concerts, fans who try to snag tickets can run into some foes, like scalpers and ticketing companies. These scalpers are like pros, all organized and strategic in grabbing up tickets. Surprisingly, ticketing companies might actually team up with these scalpers. Or, they might just keep a bunch of freebies or VIP tickets to themselves. A transparent mechanism is equally important for the audiences.</li>
    </ul>
  </li>
  <li>How to establish a healthy ticketing ecosystem?
    <ul>
      <li>
        <p>Clear ticketing rules are key to making sure the supply and demand stay in balance.</p>
      </li>
      <li>
        <p>An open pricing system is a must to make sure consumers are protected.</p>
      </li>
      <li>
        <p>Excellent liquidity. In the initial market, users can mint tickets themselves. If needed, purchased tickets can also be transferred in a transparent and open secondary market. Audiences who didn’t buy tickets during the initial sale can also confidently purchase tickets in a legal secondary market. The <code class="language-plaintext highlighter-rouge">changeState</code> function is to help the ticket have good liquidity. Only <code class="language-plaintext highlighter-rouge">PARTNER_ROLE</code> can change the ticket status. Once the sold ticket needs to be sold in the secondary market, it needs to ask the secondary market to help it change to resell status. The process of changing status is a kind of official verification of the secondary sale ticket. It is a protection mechanism to the second hand buyer.</p>
      </li>
    </ul>
  </li>
  <li>How to design a smooth ticketing process？
    <ul>
      <li>
        <p>Easy to buy/sell. Audiences can buy ticket as mint NFT. This is a well-known practice.</p>
      </li>
      <li>
        <p>Easy to refund. When something extreme happens and you need to cancel the show. Handling ticket refunds can be a straightforward process.</p>
      </li>
      <li>
        <p>Easy to redeem. Before the show, the ticket agency can verify the ticket by the signature to confirm if the audience is genuine. <code class="language-plaintext highlighter-rouge">TokenStatus</code> needs to be equal to <code class="language-plaintext highlighter-rouge">sold</code>, and <code class="language-plaintext highlighter-rouge">expireTime</code> can distinguish whether the audience has arrived at the correct session. After verification is passed, the ticket agency can change the <code class="language-plaintext highlighter-rouge">TokenStatus</code> to <code class="language-plaintext highlighter-rouge">Redeemed</code>.</p>
      </li>
      <li>
        <p>Normal Flow
   <img src="../assets/eip-7439/normal.png" alt="Alt text" /></p>
      </li>
      <li>
        <p>Void Flow
   <img src="../assets/eip-7439/void.png" alt="Alt text" /></p>
      </li>
      <li>
        <p>Resell Flow
   <img src="../assets/eip-7439/resell.png" alt="Alt text" /></p>
      </li>
    </ul>
  </li>
</ol>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This standard is compatible with <a href="./eip-721.md">ERC-721</a>.</p>

<h2 id="test-cases">Test Cases</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">expectRevert</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">@openzeppelin/test-helpers</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">expect</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">chai</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ERC7439</span> <span class="o">=</span> <span class="nx">artifacts</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">ERC7439</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">contract</span><span class="p">(</span><span class="dl">"</span><span class="s2">ERC7439</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">accounts</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">deployer</span><span class="p">,</span> <span class="nx">partner</span><span class="p">,</span> <span class="nx">userA</span><span class="p">,</span> <span class="nx">userB</span><span class="p">]</span> <span class="o">=</span> <span class="nx">accounts</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">expireTime</span> <span class="o">=</span> <span class="mi">19999999</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">tokenId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">signature</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">0x993dab3dd91f5c6dc28e17439be475478f5635c92a56e17e82349d3fb2f166196f466c0b4e0c146f285204f0dcb13e5ae67bc33f4b888ec32dfe0a063e8f3f781b</span><span class="dl">"</span>
  <span class="kd">const</span> <span class="nx">zeroHash</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">0x</span><span class="dl">"</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ERC7439</span><span class="p">.</span><span class="k">new</span><span class="p">({</span>
      <span class="na">from</span><span class="p">:</span> <span class="nx">deployer</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">mint</span><span class="p">(</span><span class="nx">userA</span><span class="p">,</span> <span class="nx">signature</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">deployer</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">Should mint a token</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tokenInfo</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">tokenInfo</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">);</span>

    <span class="nx">expect</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">userA</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">signature</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">signature</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Sold</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">expireTime</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">expireTime</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should ordinary users cannot transfer successfully</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expectRevert</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">userA</span><span class="p">,</span> <span class="nx">userB</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">userA</span> <span class="p">}),</span> <span class="dl">"</span><span class="s2">ERC7439: You cannot transfer this NFT!</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should partner can transfer successfully and chage the token info to resell status</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tokenStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Resell</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">zeroHash</span><span class="p">,</span> <span class="nx">tokenStatus</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">userA</span><span class="p">,</span> <span class="nx">partner</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">tokenHash</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">zeroHash</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tokenStatus</span><span class="p">);</span> <span class="c1">// Resell</span>
    <span class="nx">expect</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">partner</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should partner can change the token status to void</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tokenStatus</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// Void</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">zeroHash</span><span class="p">,</span> <span class="nx">tokenStatus</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">tokenHash</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">zeroHash</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tokenStatus</span><span class="p">);</span> <span class="c1">// Void</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should partner can change the token status to redeemed</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tokenStatus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// Redeemed</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">zeroHash</span><span class="p">,</span> <span class="nx">tokenStatus</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">tokenHash</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">zeroHash</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tokenStatus</span><span class="p">);</span> <span class="c1">// Redeemed</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should partner can resell the token and change status from resell to sold</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>    
    <span class="kd">let</span> <span class="nx">tokenStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Resell</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">zeroHash</span><span class="p">,</span> <span class="nx">tokenStatus</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">userA</span><span class="p">,</span> <span class="nx">partner</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>
    
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tokenStatus</span><span class="p">);</span> <span class="c1">// Resell</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">tokenHash</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">zeroHash</span><span class="p">);</span>

    <span class="nx">tokenStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Sold</span>
    <span class="kd">const</span> <span class="nx">newSignature</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">0x113hqb3ff45f5c6ec28e17439be475478f5635c92a56e17e82349d3fb2f166196f466c0b4e0c146f285204f0dcb13e5ae67bc33f4b888ec32dfe0a063w7h2f742f</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">newSignature</span><span class="p">,</span> <span class="nx">tokenStatus</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">erc7439</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">partner</span><span class="p">,</span> <span class="nx">userB</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">,</span> <span class="p">{</span> <span class="na">from</span><span class="p">:</span> <span class="nx">partner</span> <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tokenStatus</span><span class="p">);</span> <span class="c1">// Sold</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">tokenInfo</span><span class="p">.</span><span class="nx">tokenHash</span><span class="p">).</span><span class="nx">equal</span><span class="p">(</span><span class="nx">newSignature</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="reference-implementation">Reference Implementation</h2>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: CC0-1.0
</span><span class="k">pragma</span> <span class="n">solidity</span> <span class="mf">0.8</span><span class="p">.</span><span class="mi">19</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"@openzeppelin/contracts/token/ERC721/ERC721.sol"</span><span class="p">;</span>
<span class="c1">// If you need additional metadata, you can import ERC721URIStorage
// import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
</span><span class="k">import</span> <span class="s">"@openzeppelin/contracts/access/AccessControl.sol"</span><span class="p">;</span>
<span class="k">import</span> <span class="s">"@openzeppelin/contracts/utils/Counters.sol"</span><span class="p">;</span>
<span class="k">import</span> <span class="s">"./IERC7439.sol"</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">ERC7439</span> <span class="k">is</span> <span class="n">ERC721</span><span class="p">,</span> <span class="n">AccessControl</span><span class="p">,</span> <span class="n">IERC7439</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">Counters</span> <span class="k">for</span> <span class="n">Counters</span><span class="p">.</span><span class="n">Counter</span><span class="p">;</span>

    <span class="kt">bytes32</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">PARTNER_ROLE</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="s">"PARTNER_ROLE"</span><span class="p">);</span>
    <span class="n">Counters</span><span class="p">.</span><span class="n">Counter</span> <span class="k">private</span> <span class="n">_tokenIdCounter</span><span class="p">;</span>

    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">expireTime</span><span class="p">;</span>

    <span class="k">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="n">TokenInfo</span><span class="p">)</span> <span class="k">public</span> <span class="n">tokenInfo</span><span class="p">;</span>

    <span class="k">constructor</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_expireTime</span><span class="p">)</span> <span class="n">ERC721</span><span class="p">(</span><span class="s">"MyToken"</span><span class="p">,</span> <span class="s">"MTK"</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_grantRole</span><span class="p">(</span><span class="n">DEFAULT_ADMIN_ROLE</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
        <span class="n">_grantRole</span><span class="p">(</span><span class="n">PARTNER_ROLE</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
        <span class="n">expireTime</span> <span class="o">=</span> <span class="n">_expireTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">safeMint</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">tokenId</span> <span class="o">=</span> <span class="n">_tokenIdCounter</span><span class="p">.</span><span class="n">current</span><span class="p">();</span>
        <span class="n">_tokenIdCounter</span><span class="p">.</span><span class="n">increment</span><span class="p">();</span>
        <span class="n">_safeMint</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">tokenId</span><span class="p">);</span>
        <span class="n">tokenInfo</span><span class="p">[</span><span class="n">tokenId</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">TokenStatus</span><span class="p">.</span><span class="n">Sold</span><span class="p">,</span> <span class="n">expireTime</span><span class="p">);</span>
        <span class="k">emit</span> <span class="n">TokenStatusChanged</span><span class="p">(</span><span class="n">tokenId</span><span class="p">,</span> <span class="n">TokenStatus</span><span class="p">.</span><span class="n">Sold</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">changeState</span><span class="p">(</span>
        <span class="kt">uint256</span> <span class="n">tokenId</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span><span class="p">,</span>
        <span class="n">TokenStatus</span> <span class="n">tokenStatus</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">newExpireTime</span>
    <span class="p">)</span> <span class="k">public</span> <span class="n">onlyRole</span><span class="p">(</span><span class="n">PARTNER_ROLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tokenInfo</span><span class="p">[</span><span class="n">tokenId</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">tokenStatus</span><span class="p">,</span> <span class="n">newExpireTime</span><span class="p">);</span>
        <span class="k">emit</span> <span class="n">TokenStatusChanged</span><span class="p">(</span><span class="n">tokenId</span><span class="p">,</span> <span class="n">tokenStatus</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">function</span> <span class="n">_burn</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">tokenId</span><span class="p">)</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="k">override</span><span class="p">(</span><span class="n">ERC721</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">super</span><span class="p">.</span><span class="n">_burn</span><span class="p">(</span><span class="n">tokenId</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_exists</span><span class="p">(</span><span class="n">tokenId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="n">tokenInfo</span><span class="p">[</span><span class="n">tokenId</span><span class="p">];</span>
            <span class="c1">// If you import ERC721URIStorage
</span>            <span class="c1">// delete _tokenURIs[tokenId];
</span>        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">supportsInterface</span><span class="p">(</span>
        <span class="kt">bytes4</span> <span class="n">interfaceId</span>
    <span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">virtual</span> <span class="k">override</span><span class="p">(</span><span class="n">AccessControl</span><span class="p">,</span> <span class="n">ERC721</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span>
            <span class="n">interfaceId</span> <span class="o">==</span> <span class="k">type</span><span class="p">(</span><span class="n">IERC7439</span><span class="p">).</span><span class="n">interfaceId</span> <span class="o">||</span>
            <span class="nb">super</span><span class="p">.</span><span class="n">supportsInterface</span><span class="p">(</span><span class="n">interfaceId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_beforeTokenTransfer</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">from</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">to</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">tokenId</span>
    <span class="p">)</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="k">override</span><span class="p">(</span><span class="n">ERC721</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hasRole</span><span class="p">(</span><span class="n">PARTNER_ROLE</span><span class="p">,</span> <span class="n">_msgSender</span><span class="p">()))</span> <span class="p">{</span>
            <span class="nb">require</span><span class="p">(</span>
                <span class="n">from</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">to</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="s">"ERC7439: You cannot transfer this NFT!"</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="nb">super</span><span class="p">.</span><span class="n">_beforeTokenTransfer</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">tokenId</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<p>There are no security considerations related directly to the implementation of this standard.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
