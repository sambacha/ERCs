<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Registry Extension for ERC-7579 | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Registry Extension for ERC-7579 | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7484" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7484" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Registry Extension for ERC-7579</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This proposal standardises the interface and functionality of Module Registries, allowing modular smart accounts to verify the security of modules using a Registry Adapter. It also provides a reference implementation of a Singleton Module Registry.</p>

<h2 id="motivation">Motivation</h2>

<p><a href="./eip-4337.md">ERC-4337</a> standardises the execution flow of contract accounts and <a href="./eip-7579">ERC-7579</a> aims to standardise the modular implementation of these accounts, allowing any developer to build modules for these modular accounts (hereafter Smart Accounts). However, adding third-party modules into Smart Accounts unchecked opens up a wide range of attack vectors.</p>

<p>One solution to this security issue is to create a Module Registry that stores security attestations on Modules and allows Smart Accounts to query these attestations before using a module. This standard aims to achieve two things:</p>

<ol>
  <li>Standardise the interface and required functionality of Module Registries.</li>
  <li>Standardise the functionality of Adapters that allow Smart Accounts to query Module Registries.</li>
</ol>

<p>This ensures that Smart Accounts can securely query Module Registries and handle the Registry behavior correctly, irrespective of their architecture, execution flows and security assumptions. This standard also provides a reference implementation of a Singleton Module Registry that is ownerless and can be used by any Smart Account. While we see many benefits of the entire ecosystem using this single Module Registry (see <code class="language-plaintext highlighter-rouge">Rationale</code>), we acknowledge that there are tradeoffs to using a singleton and thus this standard does not require Smart Accounts to use the reference implementation. Hence, this standard ensures that Smart Accounts can query any Module Registry that implements the required interface and functionality, reducing integration overhead and ensuring interoperability for Smart Accounts.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<h3 id="definitions">Definitions</h3>

<ul>
  <li><strong>Smart account</strong> - An ERC-7579 modular smart account.</li>
  <li><strong>Module</strong> - Self-contained smart account functionality.</li>
  <li><strong>Attestation</strong> - Onchain assertions made about the security of a module.</li>
  <li><strong>Attester</strong> - The entity that makes an attestation about a module.</li>
  <li><strong>(Module) Registry</strong> - A contract that stores an onchain list of attestations about modules.</li>
  <li><strong>Adapter</strong> - Smart account functionality that handles the fetching and validation of attestations from the Registry.</li>
</ul>

<h3 id="required-registry-functionality">Required Registry functionality</h3>

<p>There are 2 separate required Registry methods: <code class="language-plaintext highlighter-rouge">check</code> and <code class="language-plaintext highlighter-rouge">checkN</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">check</code> is used to check the attestation on a module by a single attester.</li>
  <li><code class="language-plaintext highlighter-rouge">checkN</code> is used to check the attestation on a module by multiple attesters.</li>
</ul>

<p>The core interface for a Registry is as follows:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IRegistry</span> <span class="p">{</span>
    <span class="c1">// Without module types
</span>    <span class="k">function</span> <span class="n">check</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span> <span class="n">attester</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">checkN</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">attesters</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">threshold</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span><span class="p">);</span>

    <span class="c1">// With module types
</span>    <span class="k">function</span> <span class="n">check</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span> <span class="n">attester</span><span class="p">,</span> <span class="kt">uint16</span> <span class="n">moduleType</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>
    <span class="k">function</span> <span class="n">checkN</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">attesters</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">threshold</span><span class="p">,</span> <span class="kt">uint16</span> <span class="n">moduleType</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The Registry MUST implement the following functionality:</p>

<ul>
  <li>Verify that an attester is the creator of an attestation, for example by checking <code class="language-plaintext highlighter-rouge">msg.sender</code> or by using signatures, before storing it.</li>
  <li>Allow attesters to revoke attestations that they have made.</li>
  <li>Store either the attestation data or a reference to the attestation data.</li>
  <li>Implement both versions of <code class="language-plaintext highlighter-rouge">check</code> and <code class="language-plaintext highlighter-rouge">checkN</code> as specified below.</li>
</ul>

<p>The Registry SHOULD implement the following additional functionality:</p>

<ul>
  <li>Allow attesters to specify an expiry date for their attestations and revert during <code class="language-plaintext highlighter-rouge">check</code> or <code class="language-plaintext highlighter-rouge">checkN</code> if an attestation is expired.</li>
  <li>Implement a view function that allows an adapter or offchain client to read the data for a specific attestation.</li>
</ul>

<h4 id="check-without-moduletype"><code class="language-plaintext highlighter-rouge">check</code> without moduleType</h4>

<p>Takes two arguments: <code class="language-plaintext highlighter-rouge">module</code> and <code class="language-plaintext highlighter-rouge">attester</code>.</p>

<ul>
  <li>The Registry MUST revert if the <code class="language-plaintext highlighter-rouge">attester</code> has not made an attestation on the <code class="language-plaintext highlighter-rouge">module</code>.</li>
  <li>The Registry MUST revert if the <code class="language-plaintext highlighter-rouge">attester</code> has revoked their attestation on the <code class="language-plaintext highlighter-rouge">module</code>.</li>
</ul>

<p>Returns a <code class="language-plaintext highlighter-rouge">uint256</code> of the timestamp at which the attestation was created.</p>

<h4 id="check-with-moduletype"><code class="language-plaintext highlighter-rouge">check</code> with moduleType</h4>

<p>Takes three arguments: <code class="language-plaintext highlighter-rouge">module</code>, <code class="language-plaintext highlighter-rouge">attester</code> and <code class="language-plaintext highlighter-rouge">moduleType</code>.</p>

<ul>
  <li>The Registry MUST revert if the <code class="language-plaintext highlighter-rouge">attester</code> has not made an attestation on the <code class="language-plaintext highlighter-rouge">module</code>.</li>
  <li>The Registry MUST revert if the <code class="language-plaintext highlighter-rouge">attester</code> has revoked their attestation on the <code class="language-plaintext highlighter-rouge">module</code>.</li>
  <li>The Registry MUST revert if the module type of the <code class="language-plaintext highlighter-rouge">module</code> is not the provided <code class="language-plaintext highlighter-rouge">moduleType</code>.</li>
</ul>

<p>Returns a <code class="language-plaintext highlighter-rouge">uint256</code> of the timestamp at which the attestation was created.</p>

<h4 id="checkn-without-moduletype"><code class="language-plaintext highlighter-rouge">checkN</code> without moduleType</h4>

<p>Takes three arguments: <code class="language-plaintext highlighter-rouge">module</code>, <code class="language-plaintext highlighter-rouge">attesters</code> and <code class="language-plaintext highlighter-rouge">threshold</code>.</p>

<p>Note: <code class="language-plaintext highlighter-rouge">threshold</code> may be 0.</p>

<ul>
  <li>The Registry MUST revert if the number of <code class="language-plaintext highlighter-rouge">attesters</code> that have made an attestation on the <code class="language-plaintext highlighter-rouge">module</code> is smaller than the <code class="language-plaintext highlighter-rouge">threshold</code>.</li>
  <li>The Registry MUST revert if any <code class="language-plaintext highlighter-rouge">attester</code> has revoked their attestation on the <code class="language-plaintext highlighter-rouge">module</code>.</li>
</ul>

<p>Returns an array of <code class="language-plaintext highlighter-rouge">uint256</code> of the timestamps at which the attestation by each queried attester was created.</p>

<h4 id="checkn-with-moduletype"><code class="language-plaintext highlighter-rouge">checkN</code> with moduleType</h4>

<p>Takes four arguments: <code class="language-plaintext highlighter-rouge">module</code>, <code class="language-plaintext highlighter-rouge">attesters</code>, <code class="language-plaintext highlighter-rouge">threshold</code> and <code class="language-plaintext highlighter-rouge">moduleType</code>.</p>

<p>Note: <code class="language-plaintext highlighter-rouge">threshold</code> may be 0.</p>

<ul>
  <li>The Registry MUST revert if the number of <code class="language-plaintext highlighter-rouge">attesters</code> that have made an attestation on the <code class="language-plaintext highlighter-rouge">module</code> is smaller than the <code class="language-plaintext highlighter-rouge">threshold</code>.</li>
  <li>The Registry MUST revert if any <code class="language-plaintext highlighter-rouge">attester</code> has revoked their attestation on the <code class="language-plaintext highlighter-rouge">module</code>.</li>
  <li>The Registry MUST revert if the module type of the <code class="language-plaintext highlighter-rouge">module</code> is not the provided <code class="language-plaintext highlighter-rouge">moduleType</code>.</li>
</ul>

<p>Returns an array of <code class="language-plaintext highlighter-rouge">uint256</code> of the timestamps at which the attestation by each queried attester was created.</p>

<p>Note: The return values of <code class="language-plaintext highlighter-rouge">check</code> and <code class="language-plaintext highlighter-rouge">checkN</code> might change in the future, based on community feedback and further exploration of Registries and Adapters.</p>

<h3 id="adapter-behavior">Adapter behavior</h3>

<p>A Smart Account MUST implement the following Adapter functionality either natively in the account or as a module. This Adapter functionality MUST ensure that:</p>

<ul>
  <li>The Registry is queried about module <code class="language-plaintext highlighter-rouge">A</code> at least once before or during the transaction in which <code class="language-plaintext highlighter-rouge">A</code> is called for the first time.</li>
  <li>The Registry reverting is treated as a security risk.</li>
</ul>

<p>Additionally, the Adapter SHOULD implement the following functionality:</p>

<ul>
  <li>Revert the transaction flow when the Registry reverts.</li>
  <li>Query the Registry about module <code class="language-plaintext highlighter-rouge">A</code> on installation of <code class="language-plaintext highlighter-rouge">A</code>.</li>
  <li>Query the Registry about module <code class="language-plaintext highlighter-rouge">A</code> on execution of <code class="language-plaintext highlighter-rouge">A</code>.</li>
</ul>

<p>Example: Adapter flow using <code class="language-plaintext highlighter-rouge">check</code>
<img src="../assets/eip-7484/check-sequence.jpg" alt="Adapter flow using check()" /></p>

<h2 id="rationale">Rationale</h2>

<h3 id="attestations">Attestations</h3>

<p>Attestations are onchain assertions made about a module. These assertions could pertain to the security of a module (similar to a regular smart contract audit), whether a module adheres to a certain standard or any other kinds of statements about these modules. While some of these assertions can feasibly be verified onchain, the majority of them cannot be.</p>

<p>One example of this would be determining what storage slots a specific module can write to, which might be useful if a smart account uses DELEGATECALL to invoke the module. This assertion is practically infeasible to verify onchain, but can easily be verified off-chain. Thus, an attester could perform this check off-chain and publish an attestation onchain that attests to the fact that a given module can only write to its designated storage slots.</p>

<p>While attestations are always certain kinds of assertions made about a module, this proposal purposefully allows the attestation data to be any kind of data or pointer to data. This ensures that any kind of data can be used as an assertion, from a simple boolean flag specifying that a module is secure to a complex proof of runtime module behaviour.</p>

<h3 id="singleton-registry">Singleton Registry</h3>

<p>In order for attestations to be queryable onchain, they need to be stored in some sort of list in a smart contract. This proposal includes the reference implementation of an ownerless Singleton Registry that functions as the source of truth for attestations.</p>

<p>The reasons for proposing a Singleton Registry are the following:</p>

<p><strong>Security</strong>: A Singleton Registry creates greater security by focusing account integrations into a single source of truth where a maximum number of security entities are attesting. This has a number of benefits: a) it increases the maximum potential quantity and type of attestations per module and b) removes the need for accounts to verify the authenticity and security of different registries, focusing trust delegation to the onchain entities making attestations. The result is that accounts are able to query multiple attesters with lower gas overhead in order to increase security guarantees and there is no additional work required by accounts to verify the security of different registries.</p>

<p><strong>Interoperability</strong>: A Singleton Registry not only creates a greater level of “attestation liquidity”, but it also increases module liquidity and ensures a greater level of module interoperability. Developers need only deploy their module to one place to receive attestations and maximise module distribution to all integrated accounts. Attesters can also benefit from previous auditing work by chaining attestations and deriving ongoing security from these chains of dependencies. This allows for benefits such as traversing through the history of attestations or version control by the developer.</p>

<p>However, there are obviously tradeoffs for using a singleton. A Singleton Registry creates a single point of failure that, if exploited, could lead to serious consequences for smart accounts. The most serious attack vector of these would be the ability for an attacker to attest to a malicious module on behalf of a trusted attester. One tradeoff here is that using multiple registries, changes in security attestations (for example a vulnerability is found and an attestation is revoked) are slower to propagate across the ecosystem, giving attackers an opportunity to exploit vulnerabilities for longer or even find and exploit them after seeing an issue pointed out in a specific Registry but not in others.</p>

<p>Due to being a singleton, the Registry needs to be very flexible and thus likely less computationally efficient in comparison to a narrow, optimised Registry. This means that querying a Singleton Registry is likely to be more computationally (and by extension gas) intensive than querying a more narrow Registry. The tradeoff here is that a singleton makes it cheaper to query attestations from multiple parties simultaneously. So, depending on the Registry architectures, there is an amount of attestations to query (N) after which using a flexible singleton is actually computationally cheaper than querying N narrow registries. However, the reference implementation has also been designed with gas usage in mind and it is unlikely that specialised registries will be able to significantly decrease gas beyond the reference implementations benchmarks.</p>

<h3 id="related-work">Related work</h3>

<p>The reference implementation of the Registry is heavily inspired by the Ethereum Attestation Service. The specific use-case of this proposal, however, required some custom modifications and additions to EAS, meaning that using the existing EAS contracts as the Module Registry was sub-optimal. However, it would be possible to use EAS as a Module Registry with some modifications.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>No backward compatibility issues found.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<h3 id="adaptersol">Adapter.sol</h3>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">contract</span> <span class="n">Adapter</span> <span class="p">{</span>
    <span class="n">IRegistry</span> <span class="n">registry</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">checkModule</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span> <span class="n">trustedAttester</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="c1">// Check module attestation on Registry
</span>        <span class="n">registry</span><span class="p">.</span><span class="n">check</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">trustedAttester</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">checkNModule</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">attesters</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">threshold</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="c1">// Check list of module attestations on Registry
</span>        <span class="n">registry</span><span class="p">.</span><span class="n">checkN</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attesters</span><span class="p">,</span> <span class="n">threshold</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">checkModuleWithModuleType</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span> <span class="n">trustedAttester</span><span class="p">,</span> <span class="kt">uint16</span> <span class="n">moduleType</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="c1">// Check module attestation on Registry
</span>        <span class="n">registry</span><span class="p">.</span><span class="n">check</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">trustedAttester</span><span class="p">,</span> <span class="n">moduleType</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">checkNModuleWithModuleType</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">attesters</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">threshold</span><span class="p">,</span>  <span class="kt">uint16</span> <span class="n">moduleType</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="c1">// Check list of module attestations on Registry
</span>        <span class="n">registry</span><span class="p">.</span><span class="n">checkN</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attesters</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">moduleType</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<h3 id="accountsol">Account.sol</h3>

<p><strong>Note</strong>: This is a specific example that complies to the <code class="language-plaintext highlighter-rouge">Specification</code> above, but this implementation is not binding.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">contract</span> <span class="n">Account</span> <span class="k">is</span> <span class="n">Adapter</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="c1">// installs a module
</span>    <span class="k">function</span> <span class="n">installModule</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span> <span class="n">trustedAttester</span><span class="p">,</span> <span class="kt">uint16</span> <span class="n">moduleType</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
       <span class="n">checkModule</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">trustedAttester</span><span class="p">,</span> <span class="n">moduleType</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="c1">// executes a module
</span>    <span class="k">function</span> <span class="n">executeTransactionFromModule</span><span class="p">(</span><span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">attesters</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">threshold</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="n">checkNModule</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attesters</span><span class="p">,</span> <span class="n">threshold</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="registry">Registry</h3>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
* @dev this implementation is unoptimized in order to make the reference implementation shorter to read
*/</span>
<span class="k">contract</span> <span class="n">Registry</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="k">function</span> <span class="n">check</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">module</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">attester</span>
    <span class="p">)</span>
        <span class="k">public</span>
        <span class="k">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">AttestationRecord</span> <span class="k">storage</span> <span class="n">attestation</span> <span class="o">=</span> <span class="n">_getAttestation</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attester</span><span class="p">);</span>

        <span class="kt">uint48</span> <span class="n">expirationTime</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="n">expirationTime</span><span class="p">;</span>
        <span class="kt">uint48</span> <span class="n">attestedAt</span> <span class="o">=</span>
            <span class="n">expirationTime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">expirationTime</span> <span class="o">&lt;</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">attestation</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">attestedAt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">AttestationNotFound</span><span class="p">();</span>

        <span class="kt">uint48</span> <span class="n">revokedAt</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="n">revocationTime</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">revokedAt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">RevokedAttestation</span><span class="p">(</span><span class="n">attestation</span><span class="p">.</span><span class="n">attester</span><span class="p">);</span>

        <span class="k">return</span> <span class="kt">uint256</span><span class="p">(</span><span class="n">attestedAt</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">check</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">module</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">attester</span><span class="p">,</span>
        <span class="kt">uint16</span> <span class="n">moduleType</span>
    <span class="p">)</span>
        <span class="k">public</span>
        <span class="k">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Module</span> <span class="n">module</span> <span class="o">=</span> <span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">moduleType</span> <span class="o">!=</span> <span class="n">moduleType</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">ModuleTypeMismatch</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">check</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attester</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">checkN</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">module</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">calldata</span> <span class="n">attesters</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">threshold</span>
    <span class="p">)</span>
        <span class="k">external</span>
        <span class="k">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">attestersLength</span> <span class="o">=</span> <span class="n">attesters</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">attestersLength</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="o">||</span> <span class="n">threshold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">attestersLength</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">uint256</span> <span class="n">timeNow</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">attestedAtArray</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint256</span><span class="p">[](</span><span class="n">attestersLength</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attestersLength</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">uncheckedInc</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">AttestationRecord</span> <span class="k">storage</span> <span class="n">attestation</span> <span class="o">=</span> <span class="n">_getAttestation</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attesters</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attestation</span><span class="p">.</span><span class="n">revocationTime</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">revert</span> <span class="n">RevokedAttestation</span><span class="p">(</span><span class="n">attestation</span><span class="p">.</span><span class="n">attester</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">uint48</span> <span class="n">expirationTime</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="n">expirationTime</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">expirationTime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">expirationTime</span> <span class="o">&lt;</span> <span class="n">timeNow</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">revert</span> <span class="n">AttestationNotFound</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">attestedAtArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kt">uint256</span><span class="p">(</span><span class="n">attestation</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">attestation</span><span class="p">.</span><span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">--</span><span class="n">threshold</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">threshold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">attestedAtArray</span><span class="p">;</span>
        <span class="nb">revert</span> <span class="n">InsufficientAttestations</span><span class="p">();</span>
    <span class="p">}</span>

     <span class="k">function</span> <span class="n">checkN</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">module</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">calldata</span> <span class="n">attesters</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="kt">uint16</span> <span class="n">moduleType</span>
    <span class="p">)</span>
        <span class="k">external</span>
        <span class="k">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Module</span> <span class="n">module</span> <span class="o">=</span> <span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">moduleType</span> <span class="o">!=</span> <span class="n">moduleType</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">ModuleTypeMismatch</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">checkN</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attesters</span><span class="p">,</span> <span class="n">threshold</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">_getAttestation</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">module</span><span class="p">,</span>
        <span class="kt">address</span> <span class="n">attester</span>
    <span class="p">)</span>
        <span class="k">internal</span>
        <span class="k">view</span>
        <span class="k">virtual</span>
        <span class="k">returns</span> <span class="p">(</span><span class="n">AttestationRecord</span> <span class="k">storage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_moduleToAttesterToAttestations</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">attester</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<p>Needs discussion.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
