<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Asynchronous ERC-4626 Tokenized Vaults | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Asynchronous ERC-4626 Tokenized Vaults | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7540" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7540" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Asynchronous ERC-4626 Tokenized Vaults</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>The following standard extends <a href="./eip-4626.md">ERC-4626</a> by adding support for asynchronous deposit and redemption flows. The async flows are called Requests.</p>

<p>New methods are added to asynchronously Request a deposit or redemption, and view the status of the Request. The existing <code class="language-plaintext highlighter-rouge">deposit</code>, <code class="language-plaintext highlighter-rouge">mint</code>, <code class="language-plaintext highlighter-rouge">withdraw</code>, and <code class="language-plaintext highlighter-rouge">redeem</code> ERC-4626 methods are used for executing Claimable Requests.</p>

<p>Implementations can choose to whether to add asynchronous flows for deposits, redemptions, or both.</p>

<h2 id="motivation">Motivation</h2>

<p>The ERC-4626 Tokenized Vaults standard has helped to make yield-bearing tokens more composable across decentralized finance. The standard is optimized for atomic deposits and redemptions up to a limit. If the limit is reached, no new deposits or redemptions can be submitted.</p>

<p>This limitation does not work well for any smart contract system with asynchronous actions or delays as a prerequisite for interfacing with the Vault (e.g. real-world asset protocols, undercollateralized lending protocols, cross-chain lending protocols, liquid staking tokens, or insurance safety modules).</p>

<p>This standard expands the utility of ERC-4626 Vaults for asynchronous use cases. The existing Vault interface (deposit/withdraw/mint/redeem) is fully utilized to claim asynchronous Requests.</p>

<h2 id="specification">Specification</h2>

<h3 id="definitions">Definitions:</h3>

<p>The existing definitions from <a href="./eip-4626.md">ERC-4626</a> apply. In addition, this spec defines:</p>

<ul>
  <li>Request: a request to enter (<code class="language-plaintext highlighter-rouge">requestDeposit</code>) or exit (<code class="language-plaintext highlighter-rouge">requestRedeem</code>) the Vault</li>
  <li>Pending: the state where a Request has been made but is not yet Claimable</li>
  <li>Claimable: the state where a Request is processed by the Vault enabling the user to claim corresponding <code class="language-plaintext highlighter-rouge">shares</code> (for async deposit) or <code class="language-plaintext highlighter-rouge">assets</code> (for async redeem)</li>
  <li>Claimed: the state where a Request is finalized by the user and the user receives the output token (e.g. <code class="language-plaintext highlighter-rouge">shares</code> for a deposit Request)</li>
  <li>Claim function: the corresponding Vault method to bring a Request to Claimed state (e.g. <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code> claims <code class="language-plaintext highlighter-rouge">shares</code> from <code class="language-plaintext highlighter-rouge">requestDeposit</code>). Lower case claim always describes the verb action of calling a Claim function.</li>
  <li>asynchronous deposit Vault: a Vault that implements asynchronous Requests for deposit flows</li>
  <li>asynchronous redemption Vault: a Vault that implements asynchronous redemption flows</li>
  <li>fully asynchronous Vault: a Vault that implements asynchronous Requests for both deposit and redemption</li>
</ul>

<h3 id="request-flows">Request Flows</h3>

<p><a href="./eip-7540.md">ERC-7540 Vaults</a> MUST implement one or both of asynchronous deposit and redemption Request flows. If either flow is not implemented in a Request pattern, it MUST use the ERC-4626 standard synchronous interaction pattern.</p>

<p>All ERC-7540 asynchronous tokenized Vaults MUST implement ERC-4626 with overrides for certain behavior described below.</p>

<p>Asynchronous deposit Vaults MUST override the ERC-4626 specification as follows:</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">deposit</code> and <code class="language-plaintext highlighter-rouge">mint</code> methods do not transfer  <code class="language-plaintext highlighter-rouge">asset</code> to the Vault, because this already happened on <code class="language-plaintext highlighter-rouge">requestDeposit</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">previewDeposit</code> and <code class="language-plaintext highlighter-rouge">previewMint</code> MUST revert for all callers and inputs.</li>
</ol>

<p>Asynchronous redeem Vaults MUST override the ERC-4626 specification as follows:</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">redeem</code> and <code class="language-plaintext highlighter-rouge">withdraw</code> methods do not transfer <code class="language-plaintext highlighter-rouge">shares</code> to the Vault, because this already happened on <code class="language-plaintext highlighter-rouge">requestRedeem</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">owner</code> field of <code class="language-plaintext highlighter-rouge">redeem</code> and <code class="language-plaintext highlighter-rouge">withdraw</code> MUST be <code class="language-plaintext highlighter-rouge">msg.sender</code> to prevent the theft of requested redemptions by a non-owner.</li>
  <li><code class="language-plaintext highlighter-rouge">previewRedeem</code> and <code class="language-plaintext highlighter-rouge">previewWithdraw</code> MUST revert for all callers and inputs.</li>
</ol>

<h3 id="request-lifecycle">Request Lifecycle</h3>

<p>After submission, Requests go through Pending, Claimable, and Claimed stages. An example lifecycle for a deposit Request is visualized in the table below.</p>

<table>
  <thead>
    <tr>
      <th><strong>State</strong></th>
      <th><strong>User</strong></th>
      <th><strong>Vault</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Pending</td>
      <td><code class="language-plaintext highlighter-rouge">requestDeposit(assets, receiver, owner, data)</code></td>
      <td><code class="language-plaintext highlighter-rouge">asset.transferFrom(owner, vault, assets)</code>; <code class="language-plaintext highlighter-rouge">pendingDepositRequest[receiver] += assets</code></td>
    </tr>
    <tr>
      <td>Claimable</td>
      <td> </td>
      <td><em>Internal Request fulfillment</em>:  <code class="language-plaintext highlighter-rouge">pendingDepositRequest[owner] -= assets</code>; <code class="language-plaintext highlighter-rouge">claimableDepositRequest[owner] += assets</code></td>
    </tr>
    <tr>
      <td>Claimed</td>
      <td><code class="language-plaintext highlighter-rouge">deposit(assets, receiver)</code></td>
      <td><code class="language-plaintext highlighter-rouge">claimableDepositRequest[owner] -= assets</code>; <code class="language-plaintext highlighter-rouge">vault.balanceOf[receiver] += shares</code></td>
    </tr>
  </tbody>
</table>

<p>Note that <code class="language-plaintext highlighter-rouge">maxDeposit</code> increases and decreases in sync with <code class="language-plaintext highlighter-rouge">claimableDepositRequest</code>.</p>

<p>An important Vault inequality is that following a Request(s), the cumulative requested quantity MUST be more than <code class="language-plaintext highlighter-rouge">pendingDepositRequest + maxDeposit - claimed</code>. The inequality may come from fees or other state transitions outside implemented by Vault logic such as cancellation of a Request, otherwise this would be a strict equality.</p>

<p>Requests MUST NOT skip or otherwise short-circuit the Claim state. In other words, to initiate and claim a Request, a user MUST call both request* and the corresponding Claim function separately, even in the same block. Vaults MUST NOT “push” tokens onto the user after a Request, users MUST “pull” the tokens via the Claim function.</p>

<p>For asynchronous Vaults, the exchange rate between <code class="language-plaintext highlighter-rouge">shares</code> and <code class="language-plaintext highlighter-rouge">assets</code> including fees and yield is up to the Vault implementation. In other words, pending redemption Requests MAY NOT be yield bearing and MAY NOT have a fixed exchange rate.</p>

<h3 id="request-ids">Request Ids</h3>
<p>The request ID (<code class="language-plaintext highlighter-rouge">requestId</code>) of a request is returned by the corresponding <code class="language-plaintext highlighter-rouge">requestDeposit</code> and <code class="language-plaintext highlighter-rouge">requestRedeem</code> functions.</p>

<p>Multiple requests may have the same <code class="language-plaintext highlighter-rouge">requestId</code>, so a given Request is discriminated by both the <code class="language-plaintext highlighter-rouge">requestId</code> and the <code class="language-plaintext highlighter-rouge">owner</code>.</p>

<p>Requests of the same <code class="language-plaintext highlighter-rouge">requestId</code> MUST be fungible with each other (except in the special case <code class="language-plaintext highlighter-rouge">requestId == 0</code> described below). I.e. all Requests with the same <code class="language-plaintext highlighter-rouge">requestId</code> MUST transition from Pending to Claimable at the same time and receive the same exchange rate between <code class="language-plaintext highlighter-rouge">assets</code> and <code class="language-plaintext highlighter-rouge">shares</code>.</p>

<p>If a Request becomes partially claimable, all requests of the same <code class="language-plaintext highlighter-rouge">requestId</code> MUST become claimable at the same pro rata rate.</p>

<p>There are no assumptions or requirements of requests with different <code class="language-plaintext highlighter-rouge">requestId</code>. I.e. they MAY transition to Claimable at different times and exchange rates with no ordering or correlation enforced in any way.</p>

<p>When <code class="language-plaintext highlighter-rouge">requestId==0</code>, the Vault MUST use purely the <code class="language-plaintext highlighter-rouge">owner</code> to discriminate the request state. The Pending and Claimable state of multiple requests from the same <code class="language-plaintext highlighter-rouge">owner</code> would be aggregated. If a Vault returns <code class="language-plaintext highlighter-rouge">0</code> for the <code class="language-plaintext highlighter-rouge">requestId</code> of any request, it MUST return <code class="language-plaintext highlighter-rouge">0</code> for all requests.</p>

<h3 id="methods">Methods</h3>

<h4 id="requestdeposit">requestDeposit</h4>

<p>Transfers <code class="language-plaintext highlighter-rouge">assets</code> from <code class="language-plaintext highlighter-rouge">msg.sender</code> into the Vault and submits a Request for asynchronous <code class="language-plaintext highlighter-rouge">deposit</code>. This places the Request in Pending state, with a corresponding increase in <code class="language-plaintext highlighter-rouge">pendingDepositRequest</code> for the amount <code class="language-plaintext highlighter-rouge">assets</code>.</p>

<p>The output <code class="language-plaintext highlighter-rouge">requestId</code> is used to partially discriminate the request along with the <code class="language-plaintext highlighter-rouge">receiver</code>. See <a href="#request-ids">Request Ids</a> section for more info.</p>

<p>If the length of <code class="language-plaintext highlighter-rouge">data</code> is not 0, the Request MUST send an <code class="language-plaintext highlighter-rouge">onERC7540DepositReceived</code> callback to <code class="language-plaintext highlighter-rouge">receiver</code> following the interface of <code class="language-plaintext highlighter-rouge">ERC7540DepositReceiver</code> described in <a href="#request-callbacks">Request Callbacks</a> section. If the length of <code class="language-plaintext highlighter-rouge">data</code> is 0, the Request MUST NOT send a callback.</p>

<p>When the Request is Claimable, <code class="language-plaintext highlighter-rouge">claimableDepositRequest</code> will be increased for the <code class="language-plaintext highlighter-rouge">receiver</code>. <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code> can subsequently be called by <code class="language-plaintext highlighter-rouge">receiver</code> to receive <code class="language-plaintext highlighter-rouge">shares</code>. A Request MAY transition straight to Claimable state but MUST NOT skip the Claimable state.</p>

<p>The <code class="language-plaintext highlighter-rouge">shares</code> that will be received on <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code> MAY NOT be equivalent to the value of <code class="language-plaintext highlighter-rouge">convertToShares(assets)</code> at the time of Request, as the price can change between Request and Claim.</p>

<p>MUST support <a href="./eip-20.md">ERC-20</a> <code class="language-plaintext highlighter-rouge">approve</code> / <code class="language-plaintext highlighter-rouge">transferFrom</code> on <code class="language-plaintext highlighter-rouge">asset</code> as a deposit Request flow.</p>

<p><code class="language-plaintext highlighter-rouge">owner</code> MUST equal <code class="language-plaintext highlighter-rouge">msg.sender</code> unless the <code class="language-plaintext highlighter-rouge">owner</code> has approved the <code class="language-plaintext highlighter-rouge">msg.sender</code> by some mechanism.</p>

<p>MUST revert if all of <code class="language-plaintext highlighter-rouge">assets</code> cannot be requested for <code class="language-plaintext highlighter-rouge">deposit</code>/<code class="language-plaintext highlighter-rouge">mint</code> (due to deposit limit being reached, slippage, the user not approving enough underlying tokens to the Vault contract, etc).</p>

<p>Note that most implementations will require pre-approval of the Vault with the Vault’s underlying <code class="language-plaintext highlighter-rouge">asset</code> token.</p>

<p>MUST emit the <code class="language-plaintext highlighter-rouge">RequestDeposit</code> event.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestDeposit</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">nonpayable</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">assets</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">receiver</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestId</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="pendingdepositrequest">pendingDepositRequest</h4>

<p>The amount of requested <code class="language-plaintext highlighter-rouge">assets</code> in Pending state for the <code class="language-plaintext highlighter-rouge">owner</code> to <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code>.</p>

<p>MUST NOT include any <code class="language-plaintext highlighter-rouge">assets</code> in Claimable state for <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code>.</p>

<p>MUST NOT show any variations depending on the caller.</p>

<p>MUST NOT revert unless due to integer overflow caused by an unreasonably large input.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pendingDepositRequest</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>

  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">assets</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="claimabledepositrequest">claimableDepositRequest</h4>

<p>The amount of requested <code class="language-plaintext highlighter-rouge">assets</code> in Claimable state for the <code class="language-plaintext highlighter-rouge">owner</code> to <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code>.</p>

<p>MUST NOT include any <code class="language-plaintext highlighter-rouge">assets</code> in Pending state for <code class="language-plaintext highlighter-rouge">deposit</code> or <code class="language-plaintext highlighter-rouge">mint</code>.</p>

<p>MUST NOT show any variations depending on the caller.</p>

<p>MUST NOT revert unless due to integer overflow caused by an unreasonably large input.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">claimableDepositRequest</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>

  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">assets</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="requestredeem">requestRedeem</h4>

<p>Assumes control of <code class="language-plaintext highlighter-rouge">shares</code> from <code class="language-plaintext highlighter-rouge">owner</code> and submits a Request for asynchronous <code class="language-plaintext highlighter-rouge">redeem</code>. This places the Request in Pending state, with a corresponding increase in <code class="language-plaintext highlighter-rouge">pendingRedeemRequest</code> for the amount <code class="language-plaintext highlighter-rouge">shares</code>.</p>

<p>The output <code class="language-plaintext highlighter-rouge">requestId</code> is used to partially discriminate the request along with the <code class="language-plaintext highlighter-rouge">receiver</code>. See <a href="#request-ids">Request Ids</a> section for more info.</p>

<p>MAY support either a locking or a burning mechanism for <code class="language-plaintext highlighter-rouge">shares</code> depending on the Vault implemention.</p>

<p>If a Vault uses a locking mechanism for <code class="language-plaintext highlighter-rouge">shares</code>, those <code class="language-plaintext highlighter-rouge">shares</code> MUST be burned from the Vault balance before or upon claiming the Request.</p>

<p>MUST support a redeem Request flow where the control of <code class="language-plaintext highlighter-rouge">shares</code> is taken from <code class="language-plaintext highlighter-rouge">owner</code> directly where <code class="language-plaintext highlighter-rouge">msg.sender</code> has ERC-20 approval over the <code class="language-plaintext highlighter-rouge">shares</code> of <code class="language-plaintext highlighter-rouge">owner</code>.</p>

<p>If the length of <code class="language-plaintext highlighter-rouge">data</code> is not 0, the Request MUST send an <code class="language-plaintext highlighter-rouge">onERC7540RedeemReceived</code> callback to <code class="language-plaintext highlighter-rouge">receiver</code> following the interface of <code class="language-plaintext highlighter-rouge">ERC7540RedeemReceiver</code> described in <a href="#request-callbacks">Request Callbacks</a> section. If the length of <code class="language-plaintext highlighter-rouge">data</code> is 0, the Request MUST NOT send a callback.</p>

<p>When the Request is Claimable, <code class="language-plaintext highlighter-rouge">claimableRedeemRequest</code> will be increased for the <code class="language-plaintext highlighter-rouge">receiver</code>. <code class="language-plaintext highlighter-rouge">redeem</code> or <code class="language-plaintext highlighter-rouge">withdraw</code> can subsequently be called by <code class="language-plaintext highlighter-rouge">receiver</code> to receive <code class="language-plaintext highlighter-rouge">assets</code>. A Request MAY transition straight to Claimable state but MUST NOT skip the Claimable state.</p>

<p>The <code class="language-plaintext highlighter-rouge">assets</code> that will be received on <code class="language-plaintext highlighter-rouge">redeem</code> or <code class="language-plaintext highlighter-rouge">withdraw</code> MAY NOT be equivalent to the value of <code class="language-plaintext highlighter-rouge">convertToAssets(shares)</code> at time of Request, as the price can change between Pending and Claimed.</p>

<p>SHOULD check <code class="language-plaintext highlighter-rouge">msg.sender</code> can spend <code class="language-plaintext highlighter-rouge">owner</code> funds using allowance.</p>

<p>MUST revert if all of <code class="language-plaintext highlighter-rouge">shares</code> cannot be requested for <code class="language-plaintext highlighter-rouge">redeem</code> / <code class="language-plaintext highlighter-rouge">withdraw</code> (due to withdrawal limit being reached, slippage, the owner not having enough shares, etc).</p>

<p>MUST emit the <code class="language-plaintext highlighter-rouge">RequestRedeem</code> event.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestRedeem</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">nonpayable</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shares</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">receiver</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestId</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="pendingredeemrequest">pendingRedeemRequest</h4>

<p>The amount of requested <code class="language-plaintext highlighter-rouge">shares</code> in Pending state for the <code class="language-plaintext highlighter-rouge">owner</code> to <code class="language-plaintext highlighter-rouge">redeem</code> or <code class="language-plaintext highlighter-rouge">withdraw</code>.</p>

<p>MUST NOT include any <code class="language-plaintext highlighter-rouge">shares</code> in Claimable state for <code class="language-plaintext highlighter-rouge">redeem</code> or <code class="language-plaintext highlighter-rouge">withdraw</code>.</p>

<p>MUST NOT show any variations depending on the caller.</p>

<p>MUST NOT revert unless due to integer overflow caused by an unreasonably large input.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pendingRedeemRequest</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>

  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shares</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="claimableredeemrequest">claimableRedeemRequest</h4>

<p>The amount of requested <code class="language-plaintext highlighter-rouge">shares</code> in Claimable state for the <code class="language-plaintext highlighter-rouge">owner</code> to <code class="language-plaintext highlighter-rouge">redeem</code> or <code class="language-plaintext highlighter-rouge">withdraw</code>.</p>

<p>MUST NOT include any <code class="language-plaintext highlighter-rouge">shares</code> in Pending state for <code class="language-plaintext highlighter-rouge">redeem</code> or <code class="language-plaintext highlighter-rouge">withdraw</code>.</p>

<p>MUST NOT show any variations depending on the caller.</p>

<p>MUST NOT revert unless due to integer overflow caused by an unreasonably large input.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">claimableRedeemRequest</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
  <span class="na">stateMutability</span><span class="pi">:</span> <span class="s">view</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>

  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shares</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h3 id="events">Events</h3>

<h4 id="depositrequest">DepositRequest</h4>

<p><code class="language-plaintext highlighter-rouge">owner</code> has locked <code class="language-plaintext highlighter-rouge">assets</code> in the Vault to Request a deposit with request ID <code class="language-plaintext highlighter-rouge">requestId</code>. <code class="language-plaintext highlighter-rouge">receiver</code> controls this Request. <code class="language-plaintext highlighter-rouge">sender</code> is the caller of the <code class="language-plaintext highlighter-rouge">requestDeposit</code> which may not be equal to the <code class="language-plaintext highlighter-rouge">owner</code>.</p>

<p>MUST be emitted when a deposit Request is submitted using the <code class="language-plaintext highlighter-rouge">requestDeposit</code> method.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DepositRequest</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">event</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">receiver</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestId</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sender</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">assets</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h4 id="redeemrequest">RedeemRequest</h4>

<p><code class="language-plaintext highlighter-rouge">sender</code> has locked <code class="language-plaintext highlighter-rouge">shares</code>, owned by <code class="language-plaintext highlighter-rouge">owner</code>, in the Vault to Request a redemption. <code class="language-plaintext highlighter-rouge">receiver</code> controls this Request, but is not necessarily the <code class="language-plaintext highlighter-rouge">owner</code>.</p>

<p>MUST be emitted when a redemption Request is submitted using the <code class="language-plaintext highlighter-rouge">requestRedeem</code> method.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RedeemRequest</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">event</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">receiver</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestId</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sender</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shares</span>
      <span class="na">indexed</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
</code></pre></div></div>

<h3 id="request-callbacks">Request Callbacks</h3>

<p>All methods which initiate a request (including <code class="language-plaintext highlighter-rouge">requestId==0</code>) include a <code class="language-plaintext highlighter-rouge">data</code> parameter, which if nonzero length MUST send a callback to the receiver.</p>

<p>There are two interfaces, <code class="language-plaintext highlighter-rouge">ERC7540DepositReceiver</code> and <code class="language-plaintext highlighter-rouge">ERC7540RedeemReceiver</code> which each define the single callback method to be called.</p>

<h4 id="erc7540depositreceiver"><code class="language-plaintext highlighter-rouge">ERC7540DepositReceiver</code></h4>
<p>The interface to be called on <code class="language-plaintext highlighter-rouge">requestDeposit</code>.</p>

<p><code class="language-plaintext highlighter-rouge">operator</code> is the <code class="language-plaintext highlighter-rouge">msg.sender</code> of the original <code class="language-plaintext highlighter-rouge">requestDeposit</code> call. <code class="language-plaintext highlighter-rouge">owner</code> is the <code class="language-plaintext highlighter-rouge">owner</code> of the <code class="language-plaintext highlighter-rouge">requestDeposit</code>. <code class="language-plaintext highlighter-rouge">requestId</code> is the output <code class="language-plaintext highlighter-rouge">requestId</code> of the <code class="language-plaintext highlighter-rouge">requestDeposit</code>, <code class="language-plaintext highlighter-rouge">assets</code> is the amount transferred on <code class="language-plaintext highlighter-rouge">requestDeposit</code>, and <code class="language-plaintext highlighter-rouge">data</code> is the <code class="language-plaintext highlighter-rouge">data</code> of the <code class="language-plaintext highlighter-rouge">requestDeposit</code>.</p>

<p>This function MUST return <code class="language-plaintext highlighter-rouge">0x6d7e2da0</code> upon successful execution of the callback.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">onERC7540DepositReceived</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">operator</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestId</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">assets</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">interfaceId</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes4</span>
</code></pre></div></div>

<h4 id="erc7540redeemreceiver"><code class="language-plaintext highlighter-rouge">ERC7540RedeemReceiver</code></h4>
<p>The interface to be called on <code class="language-plaintext highlighter-rouge">requestRedeem</code>.</p>

<p><code class="language-plaintext highlighter-rouge">operator</code> is the <code class="language-plaintext highlighter-rouge">msg.sender</code> of the original <code class="language-plaintext highlighter-rouge">requestRedeem</code> call. <code class="language-plaintext highlighter-rouge">owner</code> is the <code class="language-plaintext highlighter-rouge">owner</code> of the <code class="language-plaintext highlighter-rouge">requestRedeem</code>. <code class="language-plaintext highlighter-rouge">requestId</code> is the output <code class="language-plaintext highlighter-rouge">requestId</code> of the <code class="language-plaintext highlighter-rouge">requestRedeem</code>, <code class="language-plaintext highlighter-rouge">shares</code> is the amount transferred on <code class="language-plaintext highlighter-rouge">requestRedeem</code>, and <code class="language-plaintext highlighter-rouge">data</code> is the <code class="language-plaintext highlighter-rouge">data</code> of the <code class="language-plaintext highlighter-rouge">requestRedeem</code>.</p>

<p>This function MUST return <code class="language-plaintext highlighter-rouge">0x01a2e97e</code> upon successful execution of the callback.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">onERC7540RedeemReceived</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>

  <span class="na">inputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">operator</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">owner</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">address</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">requestId</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shares</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">uint256</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes</span>
  <span class="na">outputs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">interfaceId</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">bytes4</span>
</code></pre></div></div>

<h3 id="erc-165-support"><a href="./eip-165.md">ERC-165</a> support</h3>

<p>Smart contracts implementing this Vault standard MUST implement the <a href="./eip-165.md">ERC-165</a> <code class="language-plaintext highlighter-rouge">supportsInterface</code> function.</p>

<p>Asynchronous deposit Vaults MUST return the constant value <code class="language-plaintext highlighter-rouge">true</code> if <code class="language-plaintext highlighter-rouge">0x1683f250</code> is passed through the <code class="language-plaintext highlighter-rouge">interfaceID</code> argument.</p>

<p>Asynchronous redemption Vaults MUST return the constant value <code class="language-plaintext highlighter-rouge">true</code> if <code class="language-plaintext highlighter-rouge">0x0899cb0b</code> is passed through the <code class="language-plaintext highlighter-rouge">interfaceID</code> argument.</p>

<h3 id="erc-7575-support"><a href="./eip-7575.md">ERC-7575</a> support</h3>

<p>Smart contracts implementing this Vault standard MUST implement the <a href="./eip-7575.md">ERC-7575</a> standard (in particular the <code class="language-plaintext highlighter-rouge">share</code> method).</p>

<h2 id="rationale">Rationale</h2>

<h3 id="including-request-ids-but-not-including-a-claim-by-id-method">Including Request IDs but Not Including a Claim by ID method</h3>
<p>Requests in an Asynchronous Vault have properties of NFTs or Semi-Fungible tokens due to their asynchronicity. However, trying to pigeonhole all ERC-7540 Vaults into supporting <a href="./eip-721">ERC-721</a> or <a href="./eip-1155">ERC-1155</a> for Requests would create too much interface bloat.</p>

<p>Using both an id and address to discriminate Requests allows for any of these use cases to be developed at an external layer without adding too much complexity to the core interface.</p>

<p>Certain Vaults especially <code class="language-plaintext highlighter-rouge">requestId==0</code> cases benefit from using the underlying <a href="./eip-4626">ERC-4626</a> methods for claiming because there is no discrimination at the <code class="language-plaintext highlighter-rouge">requestId</code> level. This standard is written primarily with those use cases in mind. A future standard can optimize for nonzero request ID with support for claiming and transferring requests discriminated also with an <code class="language-plaintext highlighter-rouge">requestId</code>.</p>

<h3 id="callbacks">Callbacks</h3>

<p>Callbacks on Request calls can be used among other things to allow Requests to become fully <a href="./eip-721">ERC-721</a> or <a href="./eip-1155">ERC-1155</a> compatible in an external layer.</p>

<p>This can support flows where a smart contract manages the Request lifecycle on behalf of a user.</p>

<h3 id="symmetry-and-non-inclusion-of-requestwithdraw-and-requestmint">Symmetry and Non-inclusion of requestWithdraw and requestMint</h3>

<p>In ERC-4626, the spec was written to be fully symmetrical with respect to converting <code class="language-plaintext highlighter-rouge">assets</code> and <code class="language-plaintext highlighter-rouge">shares</code> by including deposit/withdraw and mint/redeem.</p>

<p>Due to the asynchronous nature of Requests, the Vault can only operate with certainty on the quantity that is fully known at the time of the Request (<code class="language-plaintext highlighter-rouge">assets</code> for <code class="language-plaintext highlighter-rouge">deposit</code> and <code class="language-plaintext highlighter-rouge">shares</code> for <code class="language-plaintext highlighter-rouge">redeem</code>). The deposit Request flow cannot work with a <code class="language-plaintext highlighter-rouge">mint</code> call, because the amount of <code class="language-plaintext highlighter-rouge">assets</code> for the requested <code class="language-plaintext highlighter-rouge">shares</code> amount may fluctuate before the fulfillment of the Request. Likewise, the redemption Request flow cannot work with a <code class="language-plaintext highlighter-rouge">withdraw</code> call.</p>

<h3 id="optionality-of-flows">Optionality of flows</h3>

<p>Certain use cases are only asynchronous on one flow but not the other between Request and redeem. A good example of an asynchronous redemption Vault is a liquid staking token. The unstaking period necessitates support for asynchronous withdrawals, however, deposits can be fully synchronous.</p>

<h3 id="non-inclusion-of-a-request-cancelation-flow">Non Inclusion of a Request Cancelation Flow</h3>

<p>In many cases, canceling a Request may not be straightforward or even technically feasible. The state transition of cancelations could be synchronous or asynchronous, and the way to claim a cancelation interfaces with the remaining Vault functionality in complex ways.</p>

<p>A separate EIP should be developed to standardize behavior of cancelling a pending Request. Defining the cancel flow is still important for certain classes of use cases for which the fulfillment of a Request can take a considerable amount of time.</p>

<h3 id="request-implementation-flexibility">Request Implementation flexibility</h3>

<p>The standard is flexible enough to support a wide range of interaction patterns for Request flows. Pending Requests can be handled via internal accounting, globally or on per-user levels, use ERC-20 or <a href="./eip-721.md">ERC-721</a>, etc.</p>

<p>Likewise yield on redemption Requests can accrue or not, and the exchange rate of any Request may be fixed or variable depending on the implementation.</p>

<h3 id="not-allowing-short-circuiting-for-claims">Not allowing short-circuiting for claims</h3>

<p>If claims can short circuit, this creates ambiguity for integrators and complicates the interface with overloaded behavior on Request functions.</p>

<p>An example of a short-circuiting Request flow could be as follows: user triggers a Request which enters Pending state. When the Vault fulfills the Request, the corresponding <code class="language-plaintext highlighter-rouge">assets/shares</code> are pushed straight to the user. This requires only 1 step on the user’s behalf.</p>

<p>This approach has a few issues:</p>
<ul>
  <li>cost/lack of scalability: as the number of vault users grows it can become intractably expensive to offload the Claim costs to the Vault operator</li>
  <li>hinders integration potential: Vault integrators would need to handle both the 2-step and 1-step case, with the 1-step pushing arbitrary tokens in from an unknown Request at an unknown time. This pushes complexity out onto integrators and reduces the standard’s utility.</li>
</ul>

<p>The 2-step approach used in the standard may be abstracted into a 1-step approach from the user perspective through the use of routers, relayers, message signing, or account abstraction.</p>

<p>In the case where a Request may become Claimable immediately in the same block, there can be router contracts which atomically check for Claimable amounts immediately upon Request. Frontends can dynamically route Requests in this way depending on the state and implementation of the Vault to handle this edge case.</p>

<h3 id="no-outputs-for-request-functions">No Outputs for Request functions</h3>

<p><code class="language-plaintext highlighter-rouge">requestDeposit</code> and <code class="language-plaintext highlighter-rouge">requestRedeem</code> may not have a known exchange rate that will happen when the Request becomes Claimed. Returning the corresponding <code class="language-plaintext highlighter-rouge">assets</code> or <code class="language-plaintext highlighter-rouge">shares</code> could not work in this case.</p>

<p>The Requests could also output a timestamp representing the minimum amount of time expected for the Request to become Claimable, however not all Vaults will be able to return a reliable timestamp.</p>

<h3 id="no-event-for-claimable-state">No Event for Claimable state</h3>

<p>The state transition of a Request from Pending to Claimable happens at the Vault implementation level and is not specified in the standard. Requests may be batched into the Claimable state, or the state may transition automatically after a timestamp has passed. It is impractical to require an event to emit after a Request becomes Claimable at the user or batch level.</p>

<h3 id="reversion-of-preview-functions-in-async-request-flows">Reversion of Preview Functions in Async Request Flows</h3>

<p>The preview functions do not take an address parameter, therefore the only way to discriminate discrepancies in exchange rate are via the <code class="language-plaintext highlighter-rouge">msg.sender</code>. However, this could lead to integration/implementation complexities where support contracts cannot determine the output of a claim on behalf of an <code class="language-plaintext highlighter-rouge">owner</code>.</p>

<p>In addition, there is no on-chain benefit to previewing the Claim step as the only valid state transition is to Claim anyway. If the output of a Claim is undesirable for any reason, the calling contract can revert on the output of that function call.</p>

<p>It reduces code and implementation complexity at little to no cost to simply mandate reversion for the preview functions of an async flow.</p>

<h3 id="mandated-support-for-erc-165">Mandated Support for <a href="./eip-165.md">ERC-165</a></h3>

<p>Implementing support for <a href="./eip-165.md">ERC-165</a> is mandated because of the <a href="#optionality-of-flows">optionality of flows</a>. Integrations can use the <code class="language-plaintext highlighter-rouge">supportsInterface</code> method to check whether a vault is fully asynchronous, partially asynchronous, or fully synchronous, and use a single contract to support all cases.</p>

<h3 id="not-allowing-pending-claims-to-be-fungible">Not Allowing Pending Claims to be Fungible</h3>
<p>The async pending claims represent a sort of semi-fungible intermediate share class. Vaults can elect to wrap these claims in any token standard they like, for example ERC-20, <a href="./eip-1155.md">ERC-1155</a> or ERC-721 depending on the use case. This is intentionally left out of the spec to provide flexibility to implementers.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>The interface is fully backwards compatible with <a href="./eip-4626.md">ERC-4626</a>. The specification of the <code class="language-plaintext highlighter-rouge">deposit</code>, <code class="language-plaintext highlighter-rouge">mint</code>, <code class="language-plaintext highlighter-rouge">redeem</code>, and <code class="language-plaintext highlighter-rouge">withdraw</code> methods is different as described in <a href="#specification">Specification</a>.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// This code snippet is incomplete pseudocode used for example only and is no way intended to be used in production or guaranteed to be secure
</span>
    <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">pendingDepositRequest</span><span class="p">;</span>
    
    <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">claimableDepositRequest</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">requestDeposit</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">assets</span><span class="p">,</span> <span class="kt">address</span> <span class="n">receiver</span><span class="p">,</span> <span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">data</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">requestId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">assets</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">owner</span> <span class="o">==</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>

        <span class="n">requestId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// no requestId associated with this request
</span>
        <span class="n">asset</span><span class="p">.</span><span class="n">safeTransferFrom</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">assets</span><span class="p">);</span> <span class="c1">// asset here is the Vault underlying asset
</span>
        <span class="n">pendingDepositRequest</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">+=</span> <span class="n">assets</span><span class="p">;</span>

        <span class="c1">// Perform the callback
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nb">require</span><span class="p">(</span><span class="n">ERC7540Receiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">).</span><span class="n">onERC7540DepositReceived</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">ERC7540Receiver</span><span class="p">.</span><span class="n">onERC7540DepositReceived</span><span class="p">.</span><span class="nb">selector</span><span class="p">,</span> <span class="s">"receiver failed"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">emit</span> <span class="n">DepositRequest</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">assets</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">requestId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Include some arbitrary transition logic here from Pending to Claimable
     */</span>

    <span class="k">function</span> <span class="n">deposit</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">assets</span><span class="p">,</span> <span class="kt">address</span> <span class="n">receiver</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">shares</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">assets</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

        <span class="n">claimableDepositRequest</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">assets</span><span class="p">;</span> <span class="c1">// underflow would revert if not enough claimable assets
</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="n">convertToShares</span><span class="p">(</span><span class="n">assets</span><span class="p">);</span> <span class="c1">// this naive example uses the instantaneous exchange rate. It may be more common to use the rate locked in upon Claimable stage.
</span>
        <span class="n">balanceOf</span><span class="p">[</span><span class="n">receiver</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shares</span><span class="p">;</span>

        <span class="k">emit</span> <span class="n">Deposit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">shares</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<p>In general, asynchronicity concerns make state transitions in the Vault much more complex and vulnerable to security risks. Access control on Vault operations, clear documentation of state transitioning, and invariant checks should all be performed to mitigate these risks. For example:</p>

<ul>
  <li>The view methods for viewing Pending and Claimable request states (e.g. pendingDepositRequest) are estimates useful for display purposes but can be outdated. The inability to know the final exchange rate will be on any Request requires users to trust the implementation of the asynchronous Vault in the computation of the exchange rate and fulfillment of their Request.</li>
  <li>Shares or assets locked for Requests can be stuck in the Pending state. Vaults may elect to allow for fungibility of pending claims or implement some cancellation functionality to protect users.</li>
</ul>

<p>Lastly, it is worth highlighting again here that the Claim functions for any asynchronous flows MUST enforce that msg.sender == owner to prevent theft of Claimable assets or shares.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
