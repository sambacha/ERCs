<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Minimal Modular Smart Accounts | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Minimal Modular Smart Accounts | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7579" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7579" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Minimal Modular Smart Accounts</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This proposal outlines the minimally required interfaces and behavior for modular smart accounts and modules to ensure interoperability across implementations. For accounts, the standard specifies execution, config and fallback interfaces as well as compliance to <a href="./eip-165.md">ERC-165</a> and <a href="./eip-1271.md">ERC-1271</a>. For modules, the standard specifies a core interface, module types and type-specific interfaces.</p>

<h2 id="motivation">Motivation</h2>

<p>Contract accounts are gaining adoption with many accounts being built using a modular architecture. These modular contract accounts (hereafter smart accounts) move functionality into external contracts (modules) in order to increase the speed and potential of innovation, to future-proof themselves and to allow customizability by developers and users. However, currently these smart accounts are built in vastly different ways, creating module fragmentation and vendor lock-in. There are several reasons for why standardizing smart accounts is very beneficial to the ecosystem, including:</p>

<ul>
  <li>Interoperability for modules to be used across different smart accounts</li>
  <li>Interoperability for smart accounts to be used across different wallet applications and sdks</li>
  <li>Preventing significant vendor lock-in for smart account users</li>
</ul>

<p>However, it is highly important that this standardization is done with minimal impact on the implementation logic of the accounts, so that smart account vendors can continue to innovate, while also allowing a flourishing, multi-account-compatible module ecosystem. As a result, the goal of this standard is to define the smart account and module interfaces and behavior that is as minimal as possible while ensuring interoperability between accounts and modules.</p>

<h2 id="specification">Specification</h2>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<h3 id="definitions">Definitions</h3>

<ul>
  <li><strong>Smart account</strong> - An <a href="./eip-4337.md">ERC-4337</a> compliant smart contract account that has a modular architecture.</li>
  <li><strong>Module</strong> - A smart contract with self-contained smart account functionality.
    <ul>
      <li>Validator: A module used during the ERC-4337 validation flow to determine if a <code class="language-plaintext highlighter-rouge">PackedUserOperation</code> is valid.</li>
      <li>Executor: A module that can execute transactions on behalf of the smart account via a callback.</li>
      <li>Fallback Handler: A module that can extend the fallback functionality of a smart account.</li>
    </ul>
  </li>
  <li><strong>Entrypoint</strong> - A trusted singleton contract according to ERC-4337 specifications.</li>
</ul>

<h3 id="account">Account</h3>

<h4 id="validation">Validation</h4>

<p>This standard does not dictate how validator selection is implemented. However, should a smart account encode validator selection mechanisms in ERC-4337 <code class="language-plaintext highlighter-rouge">PackedUserOperation</code> fields (i.e. <code class="language-plaintext highlighter-rouge">userOp.signature</code>), the smart account MUST sanitize the affected values before invoking the validator.</p>

<p>The smart account’s <code class="language-plaintext highlighter-rouge">validateUserOp</code> function SHOULD return the return value of the validator.</p>

<h4 id="execution-behavior">Execution Behavior</h4>

<p>To comply with this standard, smart accounts MUST implement the execution interface below:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IExecution</span> <span class="p">{</span>
    <span class="cm">/**
     * @dev Executes a transaction on behalf of the account.
     *         This function is intended to be called by ERC-4337 EntryPoint.sol
     * @param mode The encoded execution mode of the transaction. See ModeLib.sol for details
     * @param executionCalldata The encoded execution call data
     *
     * MUST ensure adequate authorization control: i.e. onlyEntryPointOrSelf
     * If a mode is requested that is not supported by the Account, it MUST revert
     */</span>
    <span class="k">function</span> <span class="n">execute</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">executionCalldata</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Executes a transaction on behalf of the account.
     *         This function is intended to be called by Executor Modules
     * @param mode The encoded execution mode of the transaction. See ModeLib.sol for details
     * @param executionCalldata The encoded execution call data
     *
     * MUST ensure adequate authorization control: i.e. onlyExecutorModule
     * If a mode is requested that is not supported by the Account, it MUST revert
     */</span>
    <span class="k">function</span> <span class="n">executeFromExecutor</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">executionCalldata</span><span class="p">)</span>
        <span class="k">external</span>
        <span class="k">payable</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">returnData</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The account MAY also implement the following function in accordance with ERC-4337:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @dev ERC-4337 executeUserOp according to ERC-4337 v0.7
 *         This function is intended to be called by ERC-4337 EntryPoint.sol
 * @param userOp PackedUserOperation struct (see ERC-4337 v0.7+)
 * @param userOpHash The hash of the PackedUserOperation struct
 *
 * MUST ensure adequate authorization control: i.e. onlyEntryPointOrSelf
 */</span>
<span class="k">function</span> <span class="n">executeUserOp</span><span class="p">(</span><span class="n">PackedUserOperation</span> <span class="k">calldata</span> <span class="n">userOp</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">userOpHash</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span><span class="p">;</span>
</code></pre></div></div>

<p>The execution mode is a <code class="language-plaintext highlighter-rouge">bytes32</code> value that is structured as follows:</p>

<ul>
  <li>callType (1 byte): <code class="language-plaintext highlighter-rouge">0x00</code> for a single <code class="language-plaintext highlighter-rouge">call</code>, <code class="language-plaintext highlighter-rouge">0x01</code> for a batch <code class="language-plaintext highlighter-rouge">call</code> and <code class="language-plaintext highlighter-rouge">0xff</code> for <code class="language-plaintext highlighter-rouge">delegatecall</code></li>
  <li>execType (1 byte): <code class="language-plaintext highlighter-rouge">0x00</code> for executions that revert on failure, <code class="language-plaintext highlighter-rouge">0x01</code> for executions that do not revert on failure but implement some form of error handling</li>
  <li>unused (4 bytes): this range is reserved for future standardization</li>
  <li>modeSelector (4 bytes): an additional mode selector that can be used to create further execution modes</li>
  <li>modePayload (22 bytes): additional data to be passed</li>
</ul>

<p>Here is a visual representation of the execution mode:</p>

<table>
  <thead>
    <tr>
      <th>CallType</th>
      <th>ExecType</th>
      <th>Unused</th>
      <th>ModeSelector</th>
      <th>ModePayload</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>4 bytes</td>
      <td>4 bytes</td>
      <td>22 bytes</td>
    </tr>
  </tbody>
</table>

<p>Accounts are NOT REQUIRED to implement all execution modes. The account MUST declare what modes are supported in <code class="language-plaintext highlighter-rouge">supportsAccountMode</code> (see below) and if a mode is requested that is not supported by the account, the account MUST revert.</p>

<h4 id="account-configurations">Account configurations</h4>

<p>To comply with this standard, smart accounts MUST implement the account config interface below:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IAccountConfig</span> <span class="p">{</span>
    <span class="cm">/**
     * @dev Returns the account id of the smart account
     * @return accountImplementationId the account id of the smart account
     *
     * MUST return a non-empty string
     * The accountId SHOULD be structured like so:
     *        "vendorname.accountname.semver"
     * The id SHOULD be unique across all smart accounts
     */</span>
    <span class="k">function</span> <span class="n">accountId</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">accountImplementationId</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Function to check if the account supports a certain execution mode (see above)
     * @param encodedMode the encoded mode
     *
     * MUST return true if the account supports the mode and false otherwise
     */</span>
    <span class="k">function</span> <span class="n">supportsAccountMode</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">encodedMode</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Function to check if the account supports a certain module typeId
     * @param moduleTypeId the module type ID according to the ERC-7579 spec
     *
     * MUST return true if the account supports the module type and false otherwise
     */</span>
    <span class="k">function</span> <span class="n">supportsModule</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">moduleTypeId</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="module-configurations">Module configurations</h4>

<p>To comply with this standard, smart accounts MUST implement the module config interface below.</p>

<p>When storing an installed module, the smart account MUST ensure that there is a way to differentiate between module types. For example, the smart account should be able to implement access control that only allows installed executors, but not other installed modules, to call the <code class="language-plaintext highlighter-rouge">executeFromExecutor</code> function.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IModuleConfig</span> <span class="p">{</span>
    <span class="k">event</span> <span class="n">ModuleInstalled</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">moduleTypeId</span><span class="p">,</span> <span class="kt">address</span> <span class="n">module</span><span class="p">);</span>
    <span class="k">event</span> <span class="n">ModuleUninstalled</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">moduleTypeId</span><span class="p">,</span> <span class="kt">address</span> <span class="n">module</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Installs a Module of a certain type on the smart account
     * @param moduleType the module type ID according to the ERC-7579 spec
     * @param module the module address
     * @param initData arbitrary data that may be required on the module during `onInstall`
     * initialization.
     *
     * MUST implement authorization control
     * MUST call `onInstall` on the module with the `initData` parameter if provided
     * MUST emit ModuleInstalled event
     * MUST revert if the module is already installed or the initialization on the module failed
     */</span>
    <span class="k">function</span> <span class="n">installModule</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">moduleType</span><span class="p">,</span> <span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">initData</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Uninstalls a Module of a certain type on the smart account
     * @param moduleType the module type ID according the ERC-7579 spec
     * @param module the module address
     * @param deInitData arbitrary data that may be required on the module during `onInstall`
     * initialization.
     *
     * MUST implement authorization control
     * MUST call `onUninstall` on the module with the `deInitData` parameter if provided
     * MUST emit ModuleUninstalled event
     * MUST revert if the module is not installed or the deInitialization on the module failed
     */</span>
    <span class="k">function</span> <span class="n">uninstallModule</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">moduleType</span><span class="p">,</span> <span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">deInitData</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Returns whether a module is installed on the smart account
     * @param moduleType the module type ID according the ERC-7579 spec
     * @param module the module address
     * @param additionalContext arbitrary data that may be required to determine if the module is installed
     *
     * MUST return true if the module is installed and false otherwise
     */</span>
    <span class="k">function</span> <span class="n">isModuleInstalled</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">moduleType</span><span class="p">,</span> <span class="kt">address</span> <span class="n">module</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">additionalContext</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="hooks">Hooks</h4>

<p>Hooks are an OPTIONAL extension of this standard. Smart accounts MAY use hooks to execute custom logic and checks before and/or after the smart accounts performs a single or batched execution. To comply with this OPTIONAL extension, a smart account:</p>

<ul>
  <li>MUST call the <code class="language-plaintext highlighter-rouge">preCheck</code> function of one or multiple hooks during an execution on the account</li>
  <li>MUST call the <code class="language-plaintext highlighter-rouge">postCheck</code> function of one or multiple hooks during an execution on the account</li>
</ul>

<h4 id="erc-1271-forwarding">ERC-1271 Forwarding</h4>

<p>The smart account MUST implement the ERC-1271 interface. The <code class="language-plaintext highlighter-rouge">isValidSignature</code> function calls MAY be forwarded to a validator. If ERC-1271 forwarding is implemented, the validator MUST be called with <code class="language-plaintext highlighter-rouge">isValidSignatureWithSender(address sender, bytes32 hash, bytes signature)</code>, where the sender is the <code class="language-plaintext highlighter-rouge">msg.sender</code> of the call to the smart account. Should the smart account implement any validator selection encoding in the <code class="language-plaintext highlighter-rouge">bytes signature</code> parameter, the smart account MUST sanitize the parameter, before forwarding it to the validator.</p>

<p>The smart account’s ERC-1271 <code class="language-plaintext highlighter-rouge">isValidSignature</code> function SHOULD return the return value of the validator that the request was forwarded to.</p>

<h4 id="fallback">Fallback</h4>

<p>Smart accounts MAY implement a fallback function that forwards the call to a fallback handler.</p>

<p>If the smart account has a fallback handler installed, it:</p>

<ul>
  <li>MUST implement authorization control</li>
  <li>MUST use <code class="language-plaintext highlighter-rouge">call</code> to invoke the fallback handler</li>
  <li>MUST utilize <a href="./eip-2771.md">ERC-2771</a> to add the original <code class="language-plaintext highlighter-rouge">msg.sender</code> to the <code class="language-plaintext highlighter-rouge">calldata</code> sent to the fallback handler</li>
</ul>

<h4 id="erc-165">ERC-165</h4>

<p>Smart accounts MUST implement ERC-165. However, for every interface function that reverts instead of implementing the functionality, the smart account MUST return <code class="language-plaintext highlighter-rouge">false</code> for the corresponding interface id.</p>

<h3 id="modules">Modules</h3>

<p>This standard separates modules into the following different types that each has a unique and incremental identifier, which MUST be used by accounts, modules and other entities to identify the module type:</p>

<ul>
  <li>Validation (type id: 1)</li>
  <li>Execution (type id: 2)</li>
  <li>Fallback (type id: 3)</li>
  <li>Hooks (type id: 4)</li>
</ul>

<p>Note: A single module can be of multiple types.</p>

<p>Modules MUST implement the following interface:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IModule</span> <span class="p">{</span>
     <span class="cm">/**
     * @dev This function is called by the smart account during installation of the module
     * @param data arbitrary data that may be required on the module during `onInstall` initialization
     *
     * MUST revert on error (i.e. if module is already enabled)
     */</span>
    <span class="k">function</span> <span class="n">onInstall</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">data</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev This function is called by the smart account during uninstallation of the module
     * @param data arbitrary data that may be required on the module during `onUninstall` de-initialization
     *
     * MUST revert on error
     */</span>
    <span class="k">function</span> <span class="n">onUninstall</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">data</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Returns boolean value if module is a certain type
     * @param typeID the module type ID according the ERC-7579 spec
     *
     * MUST return true if the module is of the given type and false otherwise
     */</span>
    <span class="k">function</span> <span class="n">isModuleType</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">typeID</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Returns bit-encoded integer of the different typeIds of the module
     *
     * MUST return all the bit-encoded typeIds of the module
     */</span>
    <span class="k">function</span> <span class="n">getModuleTypes</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="validators">Validators</h4>

<p>Validators MUST implement the <code class="language-plaintext highlighter-rouge">IModule</code> and the <code class="language-plaintext highlighter-rouge">IValidator</code> interface and have module type id: <code class="language-plaintext highlighter-rouge">1</code>.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IValidator</span> <span class="k">is</span> <span class="n">IModule</span> <span class="p">{</span>
    <span class="cm">/**
     * @dev Validates a UserOperation
     * @param userOp the ERC-4337 PackedUserOperation
     * @param userOpHash the hash of the ERC-4337 PackedUserOperation
     *
     * MUST validate that the signature is a valid signature of the userOpHash
     * SHOULD return ERC-4337's SIG_VALIDATION_FAILED (and not revert) on signature mismatch
     */</span>
    <span class="k">function</span> <span class="n">validateUserOp</span><span class="p">(</span><span class="n">PackedUserOperation</span> <span class="k">calldata</span> <span class="n">userOp</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">userOpHash</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Validates a signature using ERC-1271
     * @param sender the address that sent the ERC-1271 request to the smart account
     * @param hash the hash of the ERC-1271 request
     * @param signature the signature of the ERC-1271 request
     *
     * MUST return the ERC-1271 `MAGIC_VALUE` if the signature is valid
     * MUST NOT modify state
     */</span>
    <span class="k">function</span> <span class="n">isValidSignatureWithSender</span><span class="p">(</span><span class="kt">address</span> <span class="n">sender</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">hash</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">signature</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes4</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="executors">Executors</h4>

<p>Executors MUST implement the <code class="language-plaintext highlighter-rouge">IModule</code> interface and have module type id: <code class="language-plaintext highlighter-rouge">2</code>.</p>

<h4 id="fallback-handlers">Fallback Handlers</h4>

<p>Fallback handlers MUST implement the <code class="language-plaintext highlighter-rouge">IModule</code> interface and have module type id: <code class="language-plaintext highlighter-rouge">3</code>.</p>

<p>Fallback handlers that implement authorization control, MUST NOT rely on <code class="language-plaintext highlighter-rouge">msg.sender</code> for authorization control but MUST use ERC-2771 <code class="language-plaintext highlighter-rouge">_msgSender()</code> instead.</p>

<h4 id="hooks-1">Hooks</h4>

<p>Hooks MUST implement the <code class="language-plaintext highlighter-rouge">IModule</code> and the <code class="language-plaintext highlighter-rouge">IHook</code> interface and have module type id: <code class="language-plaintext highlighter-rouge">4</code>.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="n">IHook</span> <span class="k">is</span> <span class="n">IModule</span> <span class="p">{</span>
    <span class="cm">/**
     * @dev Called by the smart account before execution
     * @param msgSender the address that called the smart account
     * @param msgData the data that was sent to the smart account
     *
     * MAY return arbitrary data in the `hookData` return value
     */</span>
    <span class="k">function</span> <span class="n">preCheck</span><span class="p">(</span><span class="kt">address</span> <span class="n">msgSender</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">msgData</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">hookData</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Called by the smart account after execution
     * @param hookData the data that was returned by the `preCheck` function
     *
     * MAY validate the `hookData` to validate transaction context of the `preCheck` function
     */</span>
    <span class="k">function</span> <span class="n">postCheck</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">hookData</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>

<h3 id="minimal-approach">Minimal approach</h3>

<p>Smart accounts are a new concept and we are still learning about the best ways to build them. Therefore, we should not be too opinionated about how they are built. Instead, we should define the most minimal interfaces that allow for interoperability between smart accounts and modules to be used across different account implementations.</p>

<p>Our approach has been twofold:</p>

<ol>
  <li>Take learnings from existing smart accounts that have been used in production and from building interoperability layers between them</li>
  <li>Ensure that the interfaces are as minimal and open to alternative architectures as possible</li>
</ol>

<h3 id="extensions">Extensions</h3>

<p>While we want to be minimal, we also want to allow for innovation and opinionated features. Some of these features might also need to be standardized (for similar reasons as the core interfaces) even if not all smart accounts will implement them. To ensure that this is possible, we suggest for future standardization efforts to be done as extensions to this standard. This means that the core interfaces will not change, but that new interfaces can be added as extensions. These should be proposed as separate ERCs, for example with the title <code class="language-plaintext highlighter-rouge">[FEATURE] Extension for ERC-7579</code>.</p>

<h3 id="specification-1">Specification</h3>

<h4 id="execution-mode">Execution mode</h4>

<p>Accounts need to be able to execute calldata in different ways. Rather than defining a separate function for each combination of execution types, we decided to encode the execution type in a single <code class="language-plaintext highlighter-rouge">bytes32</code> value. This allows for a more flexible and extensible approach, while also making the code far easier to write, read, maintain and audit. As explained above, the exeuction mode consists of two bytes that encode the call type and the execution type. The call type covers the three different methods of calls, namely single, batched and <code class="language-plaintext highlighter-rouge">delegatecall</code> (note that you can <code class="language-plaintext highlighter-rouge">delegatecall</code> to a multicall contract to batch <code class="language-plaintext highlighter-rouge">delegatecalls</code>). The execution type covers the two different types of executions, namely executions that revert on failure and executions that do not revert on failure but implement some form of error handling. This allows for accounts to batch together uncorrelated executions, such that if one execution fails, the other executions can still be executed. These two bytes are followed by 4 unused bytes that are reserved for futurre standardization, should this be required. This is followed by an item of 4 bytes which is a custom mode selector that accounts can implement. This allows for accounts to implement custom execution modes that are not covered by the standard and do not need to be standardized. This item is 4 bytes long to ensure collision resistance between different account vendors, with the same guarantees as Solidity function selectors. Finally, the last 22 bytes are reserved for custom data that can be passed to the account. This allows for accounts to pass any data up to 22 bytes, such as a 2 byte flag followed by an address, or otherwise a pointer to further data packed into the calldata for the execution. For example, this payload can be used to pass a hook address that should be executed before and/or after the execution.</p>

<h4 id="differentiating-module-types">Differentiating module types</h4>

<p>Not differentiating between module types could present a security issue when enforcing authorization control. For example, if a smart account treats validators and executors as the same type of module, it could allow a validator to execute arbitrary transactions on behalf of the smart account.</p>

<h4 id="account-id">Account id</h4>

<p>The account config interface includes a function <code class="language-plaintext highlighter-rouge">accountId</code> which can be used to identify an account. This is especially useful for frontend libraries that need to determine what account type and version is being used in order to implement the correct logic for account behavior that is not standardized. Alternate solutions include using an ERC-165-like interface to declare the exact differences and supported features of accounts or returning a keccak hash of the account id. However, the first solution is not as flexible as the account id and requires agreeing on a well-defined set of features to use, while the second solution is not as human-readable as the account id.</p>

<h4 id="dependence-on-erc-4337">Dependence on ERC-4337</h4>

<p>This standard has a strict dependency on ERC-4337 for the validation flow. However, it is likely that smart account builders will want to build modular accounts in the future that do not use ERC-4337 but, for example, a native account abstraction implementation on a rollup. Once this starts to happen, the proposed upgrade path for this standard is to move the ERC-4337 dependency into an extension (ie a separate ERC) and to make it optional for smart accounts to implement. If it is required to standardize the validation flow for different account abstraction implementations, then these requirements could also be moved into separate extensions.</p>

<p>The reason this is not done from the start is that currently, the only modular accounts that are being built are using ERC-4337. Therefore, it makes sense to standardize the interfaces for these accounts first and to move the ERC-4337 dependency into an extension once there is a need for it. This is to maximize learnings about how modular accounts would look like when built on different account abstraction implementations.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<h3 id="already-deployed-smart-accounts">Already deployed smart accounts</h3>

<p>Smart accounts that have already been deployed will most likely be able to implement this standard. If they are deployed as proxies, it is possible to upgrade to a new account implementation that is compliant with this standard. If they are deployed as non-upgradeable contracts, it might still be possible to become compliant, for example by adding a compliant adapter as a fallback handler, if this is supported.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<p>A full interface of a smart account can be found in <a href="../assets/eip-7579/IMSA.sol"><code class="language-plaintext highlighter-rouge">IMSA.sol</code></a>.</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>Needs more discussion. Some initial considerations:</p>

<ul>
  <li>Implementing <code class="language-plaintext highlighter-rouge">delegatecall</code> executions on a smart account must be considered carefully. Note that smart accounts implementing <code class="language-plaintext highlighter-rouge">delegatecall</code> must ensure that the target contract is safe, otherwise security vulnerabilities are to be expected.</li>
  <li>The <code class="language-plaintext highlighter-rouge">onInstall</code> and <code class="language-plaintext highlighter-rouge">onUninstall</code> functions on modules may lead to unexpected callbacks (i.e. reentrancy). Account implementations should consider this by implementing adequate protection routines. Furthermore, modules could maliciously revert on <code class="language-plaintext highlighter-rouge">onUninstall</code> to stop the account from uninstalling a module and removing it from the account.</li>
  <li>For modules types where only a single module is active at one time (e.g. fallback handlers), calling <code class="language-plaintext highlighter-rouge">install*</code> on a new module will not properly uninstall the previous module, unless this is properly implemented. This could lead to unexpected behavior if the old module is then added again with left over state.</li>
  <li>Insufficient authorization control in fallback handlers can lead to unauthorized executions.</li>
  <li>Malicious Hooks may revert on <code class="language-plaintext highlighter-rouge">preCheck</code> or <code class="language-plaintext highlighter-rouge">postCheck</code>, adding untrusted hooks may lead to a denial of service of the account.</li>
  <li>Currently account configuration functions (e.g. <code class="language-plaintext highlighter-rouge">installValidator</code>) are designed for single operations. An account could allow these to be called from <code class="language-plaintext highlighter-rouge">address(this)</code>, creating the possibility to batch configuration operations. However, if an account implements greater authorization control for these functions since they are more sensitive, then these measures can be bypassed by nesting calls to configuration options in calls to self.</li>
</ul>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
