<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Secure Messaging Protocol | Ethereum Improvement Proposals</title>
    <meta
      property="og:title"
      content="Secure Messaging Protocol | Ethereum Improvement Proposals"
    />
    <meta name="description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards." />
  
  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="http://localhost:4000/ERCS/erc-7627" />
  <meta property="og:url" content="http://localhost:4000/ERCS/erc-7627" />
  <meta property="og:site_name" content="Ethereum Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "http://localhost:4000",
      "name": "Ethereum Improvement Proposals",
      "description": "Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ethereum Improvement Proposals" /><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/override.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
  <script type="text/javascript">
    window.MathJax = {
      loader: {
        load: ['input/tex-base', 'output/chtml']
      },
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: false,
        processRefs: false
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js" integrity="sha384-/1zmJ1mBdfKIOnwPxpdG6yaRrxP6qu3eVYm0cz2nOx+AcL4d3AqEFrwcqGZVVroG" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    addEventListener('DOMContentLoaded', async () => {
      const Cite = window.require('citation-js');
      const citationElements = document.querySelectorAll('.language-csl-json');
      for (let citationElement of citationElements) {
        try {
          const citation = await Cite.async(citationElement);
          const template = document.createElement('template');
          template.innerHTML = citation.format('bibliography', {
            format: 'html',
            template: 'apa',
            lang: 'en-US'
          });
          if (citationElement.parentElement && citationElement.parentElement.matches('pre')) {
            citationElement.parentElement.replaceWith(template.content);
          } else {
            citationElement.replaceWith(template.content);
          }
        } catch (e) {
          console.error("unable to render citation", e);
        }
      }
    });
  </script>
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Ethereum Improvement Proposals</a><nav class="site-nav d-flex">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger row p-2"><a class="page-link col" href="/all">All</a><a class="page-link col" href="/core">Core</a><a class="page-link col" href="/networking">Networking</a><a class="page-link col" href="/interface">Interface</a><a class="page-link col" href="/erc">ERC</a><a class="page-link col" href="/meta">Meta</a><a class="page-link col" href="/informational">Informational</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Secure Messaging Protocol</h1>
  </header>

  <div class="post-content">
    <h2 id="abstract">Abstract</h2>

<p>This proposal implements the capability to securely exchange encrypted messages on-chain. Users can register their public keys and encryption algorithms by registration and subsequently send encrypted messages to other users using their addresses. The interface also includes enumerations for public key algorithms and a structure for user information to support various encryption algorithms and user information management.</p>

<h2 id="motivation">Motivation</h2>

<p>With the emergence of Layer 2 chains featuring sub-second block times and the introduction of account abstraction, the use of end-to-end encrypted communication has facilitated the proliferation of real-time communication and online chat dApps. Leveraging asymmetric encryption now enables the establishment of decentralized, end-to-end interoperable messaging protocols as a standard.</p>

<h2 id="specification">Specification</h2>

<h3 id="objectives">Objectives</h3>

<ul>
  <li>Provide a standardized interface for implementing messaging systems in smart contracts, including user registration and message sending functionalities.</li>
  <li>Enhance flexibility and scalability for messaging systems by defining enumerations for public key algorithms and a structure for user information.</li>
  <li>Define events for tracking message sending to enhance the observability and auditability of the contract.</li>
  <li>Using a custom sessionId allows messages to be organized into a conversation.</li>
  <li>Encrypt message content using the recipient’s public key during message transmission.</li>
</ul>

<h3 id="interface">Interface</h3>

<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>

<p>Implementers of this standard <strong>MUST</strong> have all of the following functions:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">IERC7627</span> <span class="p">{</span>

    <span class="k">enum</span> <span class="n">PublicKeyAlgorithm</span> <span class="p">{</span> <span class="n">RSA</span><span class="p">,</span> <span class="n">ECDSA</span><span class="p">,</span> <span class="n">ED25519</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="n">DH</span><span class="p">,</span> <span class="n">ECDH</span><span class="p">,</span> <span class="n">X25519</span> <span class="p">}</span>
    
    <span class="c1">// Events
</span>
    <span class="cm">/**
     * @dev Event emitted when a message is sent.
     * @param from The address of the sender.
     * @param to The address of the recipient.
     * @param sessionId The session ID of the message.
     * @param encryptedMessage The encrypted message.
     */</span>
    <span class="k">event</span> <span class="n">MessageSent</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">from</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">to</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">sessionId</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">encryptedMessage</span><span class="p">);</span>

    <span class="cm">/**
     * @dev Event emitted when a user updates their public key.
     * @param user The address of the user.
     * @param newPublicKey The new public key of the user.
     * @param algorithm The algorithm used for the public key.
     */</span>
    <span class="k">event</span> <span class="n">PublicKeyUpdated</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">user</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">newPublicKey</span><span class="p">,</span> <span class="n">PublicKeyAlgorithm</span> <span class="n">algorithm</span><span class="p">);</span>

    <span class="c1">// Functions
</span>
    <span class="cm">/**
     * @dev Function to update a user's public key.
     * @param _publicKey The public key of the user.
     * @param _algorithm The algorithm used for the public key.
     */</span>
    <span class="k">function</span> <span class="n">updatePublicKey</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">_publicKey</span><span class="p">,</span> <span class="n">PublicKeyAlgorithm</span> <span class="n">_algorithm</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Function to send an encrypted message from one user to another.
     * @param _to The address of the recipient.
     * @param _sessionId The session ID of the message.
     * @param _encryptedMessage The encrypted message.
     */</span>
    <span class="k">function</span> <span class="n">sendMessage</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">_sessionId</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">_encryptedMessage</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>

    <span class="cm">/**
     * @dev Function to retrieve a user's public key and algorithm.
     * @param _user The address of the user.
     * @return publicKey The public key of the user.
     * @return algorithm The algorithm used for the public key.
     */</span>
    <span class="k">function</span> <span class="n">getUserPublicKey</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">publicKey</span><span class="p">,</span> <span class="n">PublicKeyAlgorithm</span> <span class="n">algorithm</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="rationale">Rationale</h2>

<p>Traditional messaging lacks security and transparency for blockchain communication. The choice of asymmetric encryption ensures the confidentiality and integrity of messages, which is why we opted for this encryption method. Providing a unified interface enables easy integration of encrypted communication into smart contracts, thereby fostering innovation. Encrypted messaging guarantees adherence to best practices in data security. Due to security reasons, public keys need to be regularly updated, hence we have added a feature that allows users to autonomously update their public keys. The interface supports various encryption methods, enhancing adaptability. Event tracking enhances the observability and auditability of the contract, aiding compliance efforts. Standardization promotes interoperability, facilitating seamless communication across platforms.</p>

<h2 id="reference-implementation">Reference Implementation</h2>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">ERC7627</span> <span class="p">{</span>

    <span class="k">enum</span> <span class="n">PublicKeyAlgorithm</span> <span class="p">{</span> <span class="n">RSA</span><span class="p">,</span> <span class="n">ECDSA</span><span class="p">,</span> <span class="n">ED25519</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="n">DH</span><span class="p">,</span> <span class="n">ECDH</span><span class="p">,</span> <span class="n">X25519</span> <span class="p">}</span>

    <span class="k">struct</span> <span class="n">UserInfo</span> <span class="p">{</span>
        <span class="kt">bytes</span> <span class="n">publicKey</span><span class="p">;</span>
        <span class="n">PublicKeyAlgorithm</span> <span class="n">algorithm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">UserInfo</span><span class="p">)</span> <span class="k">public</span> <span class="n">pk</span><span class="p">;</span>

    <span class="k">event</span> <span class="n">MessageSent</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">from</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">to</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">sessionId</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">encryptedMessage</span><span class="p">);</span>
    <span class="k">event</span> <span class="n">PublicKeyUpdated</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">user</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">newPublicKey</span><span class="p">,</span> <span class="n">PublicKeyAlgorithm</span> <span class="n">algorithm</span><span class="p">);</span>

    <span class="c1">// Function to register a user with their public key
</span>    <span class="k">function</span> <span class="n">updatePublicKey</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">_publicKey</span><span class="p">,</span> <span class="n">PublicKeyAlgorithm</span> <span class="n">_algorithm</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="n">pk</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">].</span><span class="n">publicKey</span> <span class="o">=</span> <span class="n">_publicKey</span><span class="p">;</span>
        <span class="n">pk</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">].</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">_algorithm</span><span class="p">;</span>
        <span class="k">emit</span> <span class="n">PublicKeyUpdated</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">_publicKey</span><span class="p">,</span> <span class="n">_algorithm</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Function to send an encrypted message from one user to another
</span>    <span class="k">function</span> <span class="n">sendMessage</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">_sessionId</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">_encryptedMessage</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="k">emit</span> <span class="n">MessageSent</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">_to</span><span class="p">,</span> <span class="n">_sessionId</span><span class="p">,</span> <span class="n">_encryptedMessage</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Function to retrieve a user's public key
</span>    <span class="k">function</span> <span class="n">getUserPublicKey</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">,</span> <span class="n">PublicKeyAlgorithm</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UserInfo</span> <span class="k">memory</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[</span><span class="n">_user</span><span class="p">];</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="n">publicKey</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">.</span><span class="n">algorithm</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="security-considerations">Security Considerations</h2>

<h4 id="utilization-of-latest-secure-encryption-algorithms">Utilization of Latest Secure Encryption Algorithms</h4>
<p>When selecting encryption algorithms, it is essential to stay informed about the latest security news and recommendations. Avoid using asymmetric encryption algorithms with known vulnerabilities or those not recommended to ensure the confidentiality and integrity of messages. Regularly update encryption algorithms to address evolving security threats.</p>

<h4 id="strict-encryption-using-public-keys-for-message-content">Strict Encryption Using Public Keys for Message Content</h4>
<p>To maintain message confidentiality, the content of sent messages must be strictly encrypted using the recipient’s public key. Any plaintext information transmitted could lead to information leakage and security risks. Encrypt message content at all times during transmission and storage to prevent unauthorized access to sensitive information.</p>

<h4 id="key-management-and-protection">Key Management and Protection</h4>
<p>Robust key management and protection measures are necessary for both user public and private keys. Ensure secure storage and transmission of keys to prevent leakage and tampering. Employ multi-factor authentication and key rotation strategies to enhance key security and regularly assess key management processes to mitigate potential security risks.</p>

<h4 id="auditing-and-monitoring">Auditing and Monitoring</h4>
<p>Implement auditing and monitoring mechanisms to track message sending and receiving, as well as key usage. Promptly identify anomalous activities and potential security threats and take appropriate response measures. Record critical operations and events for security incident investigation and traceability purposes.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="/LICENSE">CC0</a></p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ethereum Improvement Proposals</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ethereum Improvement Proposals</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ethereum/EIPs"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ethereum/EIPs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Ethereum Improvement Proposals (EIPs) describe standards for the Ethereum platform, including core protocol specifications, client APIs, and contract standards.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
